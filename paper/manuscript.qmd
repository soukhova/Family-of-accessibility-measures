---
title: "A family of accessibility measures derived from spatial interaction principles"
format: pdf
bibliography: "`r system('kpsewhich ../bibliography/bibliography.bib', intern=TRUE)`"
---

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r load-packages, include=FALSE, cache=FALSE}
library(bibliometrix) # Comprehensive Science Mapping Analysis
library(dplyr) # A Grammar of Data Manipulation
library(flextable) # Functions for Tabular Reporting
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggraph) # An Implementation of Grammar of Graphics for Graphs and Networks
library(glue) # Interpreted String Literals
library(gt) # Easily Create Presentation-Ready Display Tables
library(here) # A Simpler Way to Find Your Files
library(knitr) # A General-Purpose Package for Dynamic Report Generation in R
library(tidytext) # Text Mining using 'dplyr', 'ggplot2', and Other Tidy Tools
```

# Introduction

<!-- SUMMARY: Accessibility is related to mobility, however, institutionalized mobility-based transportation planning practice has treated accessibility as it's proxy. This has had problematic consequences. Conceptually, accessibility is a more complete and comprehensive evolution of mobility. As such, there has been recognition that the adoption of accessibility planning approaches are needed; however there are 1) too many definitions and 2) uncertainty in meaning of the outputs--> 

Historically, the focus of transportation planning has been to prioritize mobility while treating access to destinations as a by-product of movement. This has had problematic consequences: with the car seen as the ultimate mobility tool, this approach has led to the emergence and continued dominance of an automobility mono-culture [@miller_collaborative_2011; @lavery_driving_2013]. Decades of mobility-based planning (often characterized by road and highway expansion) have been marked by increased travel cost and environmental burdens, but often have had limited impact on the ease with which people can reach destinations [@farber_running_2011; @handyACCESSIBILITYVSMOBILITYENHANCING2002; @paez_healthcare_2010]. In response to this situation, transportation researchers have increasingly advocated for the adoption of accessibility as a planning criterion [@silvaAccessibilityInstrumentsPlanning2017; @paez_developing_2013; @handy2020] using both positive and normative approaches [@paez2012measuring; @levineCenturyEvolutionAccessibility2020]. Accessibility, a central concept in transport geography, planning, and engineering, is conceptually related to human mobility and the opportunity landscape. In simple terms, it is defined as the "potential of opportunities for interaction" [@hansen1959]. Compared to other measures of performance used in transportation that benchmark movement (e.g., VKT, PKT, etc.), accessibility brings a more holistic understanding of transportation and land use systems combined [@handyMeasuringAccessibilityExploration1997]. 

As a result, scholarly research on accessibility has experienced a remarkable boom, and has grown to include employment [e.g., @karstEvaluationAccessibilityImpacts2003; @grengs2010job; @paez_jobs_2013; @merlin2017competition; @tao_investigating_2020], health care [e.g., @luo2003; @paez_healthcare_2010; @wan2012three; @delamater2013spatial; @boisjoly2017informality; @pereira_2021_geographic], green spaces [@reyesAccessibility2014; @rojas_accessibility_2016; @liang_novel_2024], schools [e.g., @williams_disparities_2014; @romanillosAccessibilitySchoolsSpatial2018; @marques_accessibility_2021], social contacts [e.g., @neutens_human_2007; @farberActivitySpacesMeasurement2012; @farber_2013_social], and regional economic analysis [e.g., @vickermanAccessibility1999; @lopezMeasuring2008; @ribeiro_road_2010; @gutierrez_evaluating_2011] among many other domains of application. In other words, accessibility analysis is used today to understand the potential to reach opportunities that are important to people [@ferreiraReenactingMobilityAccessibility2020]. However, despite its growth in popularity in scholarly works, challenges remain to more widespread adoption of accessibility in planning practice. Several barriers to bridging the scholarly-practice accessibility gap have been identified. For example, the diversity of accessibility definitions has been flagged by @vanweeAccessible2016, @handy2020, and @kapatsila_resolving_2023. Further, difficulties in the interpretability and communicability of outputs has also been noticed by @geursAccessibilityEvaluationLanduse2004, @vanweeAccessible2016, and @ferreiraReenactingMobilityAccessibility2020. 

Adoption of accessibility in planning practice is not necessarily made easier when potential adopters have to contend with a plethora of definitions, each seemingly more sophisticated but less intuitive than the last [@kapatsila_resolving_2023]. The menu of accessibility measures has grown to include gravity-based accessibility [e.g., @hansen1959; @pirie_measuring_1979], cumulative opportunities [e.g., @wachs_physical_1973; @pirie_measuring_1979; @ye_spatial_2018], modified gravity [e.g., @SchuurmanMeasuring2010], 2-Step Floating Catchment Areas [e.g., @luo2003], Enhanced 2-Step Floating Catchment Areas [e.g., @luoEnhanced2009], 3-Stage Floating Catchment Areas [e.g., @wan2012three], Modified 2-Step Floating Catchment Areas [e.g., @delamater2013spatial], inverse 2-Step Floating Catchment Areas [e.g., @wang_2sfca_2021], and n-steps Floating Catchment Areas [@liang_novel_2024]. How is a practitioner to choose among this myriad options? What differences in accessibility scores should matter, and how should they be communicated? [see @vanweeAccessible2016; p. 14].

In this respect, @wuUnifyingAccess2020's contribution provides a unifying framework to think about accessibility measures, the most general of which they describe as $S_i$ in @eq-access-Lu-Levinson. By considering the key features of accessibility, namely travel-cost $f(c{ij})$ and the distribution of opportunities $g(O_i)$, @wuUnifyingAccess2020 demonstrate that a majority of the concepts found scattered throughout the accessibility literature can be seen as particular cases of a general accessibility formula. One needs only to judiciously change the way travel-cost and opportunities are formulated, to derive almost any known accessibility measure. In this way, @wuUnifyingAccess2020 have taken a considerable step towards clarifying the differences between various accessibility indicators. 

$$
S_i \propto \sum_j g(O_j)f(c_{ij})
$${#eq-access-Lu-Levinson}

However, there is room to further clarify another relevant aspect: competition. @wuUnifyingAccess2020's unifying framework does not appear to accommodate many (or any) of the floating catchment area methods, a popular method within the competitive accessibility literature. There have also been more recent developments in the literature: for instance, @soukhovIntroducingSpatialAvailability2023 demonstrate that the introduction of a single constraint is sufficient to turn the general accessibility measure (i.e, @eq-access-Lu-Levinson) into a competitive measure of accessibility in accordance with the 2-Step Floating Catchment Area approach. Moreover, the proportional allocation balancing factors in @soukhovIntroducingSpatialAvailability2023 apply a singly-constraint to the accessibility measure, akin to the constraints introduced within the spatial interaction modelling framework outlined in @wilson1971.

Taken this motivation of incorporating competition in the unified framework and recent developments in methodology, this paper contends that accessibility research must reconnect with its spatial interaction origins. Particularly, we argue an important aspect of spatial interaction modelling -namely, constraining the results to match empirical observations- was never effectively reincorporated into accessibility analysis. Empirical constraints were embraced by early spatial interaction literature until the research stream diverged following the work of @hansen1959 and @wilson1971; at which point 'accessibility' and 'spatial interaction modelling' began to flow more distinctly. The application of @wilson1971's empirical constraints supported the development of various spatial interaction models that remain relevant in research and practice today [@ortuzar_2011_modelling]. However, the same cannot be traced for contemporary accessibility literature, where empirical constraints were not explicitly adopted. We argue the absence of empirical constraints or attendance proportionality constants has contributed to some of accessibility analysis' interpretability issues; for instance, the fuzziness of insights beyond simple proportional statements like 'higher-than' or 'lower-than' [@millerAccessibilityMeasurementApplication2018].

These streams of literature share common headwaters. It is by looking to the past that we believe accessibility analysis can newly wade into the future. Hence, this work's primary focus is to show that the same empirical constraints used in @wilson1971's family of spatial interaction models can be mapped onto accessibility. We begin by tracing the development of accessibility from its origins in spatial interaction, from the Newtonian gravitational expression in @ravensteinLawsMigration1889 through to the "seminal" accessibility work of @hansen1959. We then present evidence for a narrative highlighting the marked divergence between accessibility and spatial interaction modelling research after the work of @wilson1971. Next, we hark back to @wilson1971's spatial interaction models, and use it to derive a family of accessibility measures based on different types of constraints. We illustrate various members of this family with a simple numerical example and a real world data set. We then conclude by discussing the uses of these measure and their interpretation.

<!--
We wish to demonstrate the importance of transiting from proportionality to equality in @eq-accessibility-general, in order to balance the units of accessibility into more interpretable values, as well as converting accessibility indicators from ordinal variables into interval/ration ones. To address this matter, we need not reinvent the wheel. Stewart left the determination of $G$ for the future, possibly expecting it to be some sort of universal constant. However, the solution to this problem was found by @wilson1971, who discovered that there was not a single $G$, but rather various balancing factors that depend on 1) empirical observations of population and/or opportunities; and 2) whether (and how) they were used to constrain the analysis. This development is outlined next.
-->

# Newtonian's roots of human spatial interaction research

<!--SUMMARY: Overview of the proportionality constant in Newton Law of Universal Gravitation - it takes the proportion relationship into one of equality. -->

The patterns of people's movement in space have been a subject of scientific inquiry for almost a century and a half. From as far back as Henry C. Carey's _Principles of Social Science_ [@careyPrinciplesSocialScience1858], a concern with the scientific study of human spatial interaction can be observed. It was in this work where Carey stated that "man [is] the molecule of society [and their interaction is subject to] the direct ratio of the mass and the inverse one of distance" [@mckeanManual1883, pp. 37-38]. This statement shows how investigations into human spatial interaction have often been explicitly coloured by the features of Newton's Law of Universal Gravitation, first posited in 1687's _Principia Mathematica_ and expressed as in @eq-phys-grav-prop.

$$
F_{ij} \propto \frac{M_i M_j} {D_{ij}^{2}}
$${#eq-phys-grav-prop}

To be certain, the expression above, a proportionality, is one of the most famous in all of science. In brief, it states that the force of attraction $F$ between a pair of bodies $i$ and $j$ is directly _proportional_ to the product of their masses $M_i$ and $M_j$, and inversely _proportional_ to the square of the distance between them $D_{ij}$. Direct proportionality means that as the product of the masses increases, so does the force. Likewise, inverse proportionality means that as the distance increases, the force decreases. @eq-phys-grav-prop, however, does not quantify the magnitude of the force. To do so, an empirical constant is required to convert the proportionality into an equality, ensuring that values of the force $F$ in @eq-phys-grav-prop match the observed force of attraction between masses. In other words, @eq-phys-grav-prop needs to be _constrained_ using empirical data. Ultimately, the equation for the force is as seen in @eq-phys-grav, where $G$ is an empirically calibrated proportionality constant:

$$
F_{ij} = G \frac{M_i M_j} {D_{ij}^{2}}
$${#eq-phys-grav}

Newton's initial estimate of $G$ was based on a speculation that the mean density of earth was between five or six times that of water, an assumption that received support after Hutton's experiments of 1778 [@hutton_xxxiii_1778, p. 783]. Still, it took over a century from the publication of _Principia_ to refine the estimate of the proportionality constant to within 1\% accuracy, with Cavendish's 1798 experiment [@cavendish_xxi_1798].

# Early research on human spatial interaction: from Ravenstein (1889) to Stewart (1948)

<!-- 
SUMMARY: a review of spatial interaction literature from the 1880s to the 1940s. A number of researchers theoretically and empirically attempted to characterise human spatial interaction as some force of attraction $F$ that is directly proportion to the masses $Mi$ and $Mj$ and inversely proportional by their separation distance. This concept was captured with different expressions, but all tie back to the same Newtonian gravity analogy, although not all of them included a proportionality constant in their formulation.
-->

Following Carey's _Principles_ of 1858, research into human spatial interaction continued in different contexts. In the late 1880s, Ravenstein proposed some "Laws of Migration" based on his empirical analysis of migration flows in various countries [@ravensteinLawsMigration1885; @ravensteinLawsMigration1889]. In these works, Ravenstein posited 1) a directly proportional relationship between migration flows and the size of destinations (i.e., centres of commerce and industry), and 2) an inversely proportional relationship between the size of flows and the separation between origins and destinations. As with Carey, these propositions are similar to Newton's gravitational laws. Over time, other researchers discovered similar relationships. <!--Rilley does not cite Newton, nor Carey, nor Ravenstein, but I removed this curiosity as it's not central to our point here--> For example, @reilly1929methods formulated a law of retail gravitation, expressed in terms of equal attraction to competing retail destinations. Later, Zipf proposed a $\frac{P_1P_2}{D}$ hypothesis for the case of goods movement by railways [@zipfHypothesisCaseRailway1946], intercity personal movement [@zipfHypothesisIntercityMovement1946], and information [@zipfDeterminantsCirculationInformation1946]. The $\frac{P_1P_2}{D}$ hypothesis stated that the magnitude of flows was proportional to the product of the populations of settlements, and inversely proportional to the distance between them. 

A common feature of these early investigations of human spatial interaction is that a proportionality constant similar to $G$ in @eq-phys-grav was never considered. Of the researchers cited above, only Reilly and Zipf expressed their hypotheses in mathematical terms. Reilly's hypothesis was presented in the following form:

$$
B_a = \frac{(P_a\cdot P_T)^N}{D_{aT}^n}
$${#eq-reilly}

\noindent Where $B_a$ is the amount of business drawn to $a$ from $T$, $P_a$ and $P_T$ are the populations of the two settlements, and $D_{aT}$ is the distance between them. Quantity $N$ was chosen by Reilly in a somewhat _ad hoc_ fashion as 1, and he used empirical observations of shoppers to choose a value of $n = 2$. 

Zipf, on the other hand, wrote his hypothesis in mathematical form as:

$$
C^2 = \frac{P_1\cdot P_2}{D_{12}}
$${#eq-zipf}

\noindent where $C$ is the volume of goods exchanged between $1$ and $2$, $P_1$ and $P_2$ are the populations of the two settlements, and $D_{12}$ is the distance between them.

After Carey, it is in Stewart's work on the principles of demographic gravitation that we find the strongest connection yet to Newton's law [@stewartDemographicGravitationEvidence1948]. We suspect that this relates to academic backgrounds; where Ravenstein, Reilly, and Zipf were social scientists, Stewart was a physicist. Besides awareness of preceding research (Stewart cites both Reilly and Zipf as predecessors in the analysis of human spatial interaction), Stewart appears to have been the first author to express his theorized relationships for human spatial interaction with a proportionality constant $G$, as follows:

$$
F = G\frac{(\mu_1N_1)(\mu_2N_2)}{d_{12}^2} = G\frac{M_1\cdot M_2}{d_{12}^2} 
$${#eq-stewart-force}

\noindent Where:

- $F$ is the _demographic force_
- $N_1$ and $N_2$ are the numbers of people of in groups 1 and 2
- $\mu_1$ and $\mu_2$ are so-called _molecular weights_
- $M_1 = \mu_1N_1$ and $M_2 = \mu_2N_2$ are the demographic masses at 1 and 2
- $d_{12}^2$ is the distance between $1$ and $2$
- And finally $G$, a constant that Stewart "left for future determination" [-@stewartDemographicGravitationEvidence1948, p. 34]

In addition to demographic force, Stewart defined a measure of the "population potential" of $2$ with respect to $1$ as follows:
$$
V_1 = G\frac{M_2}{d_{12}}
$${#eq-stewart-population-potential}

For a system with more than two population bodies, Stewart formulated the population potential at $i$ as follows (after arbitrarily assuming that $G=1$):
$$
V_i = \int\frac{D}{r} ds
$${#eq-stewart-population-potential-integral}

\noindent Where $D$ is the population density over an infinitesimal area $ds$ and $r$ is the distance to $i$. In @eq-stewart-population-potential-integral, $D\cdot ds$ gives an infinitesimal count of the population, say $dm$, and so, after discretizing space, @eq-stewart-population-potential-integral can be rewritten as:
$$
V_i = \sum_j \frac{M_j}{d_{ij}}
$${#eq-stewart-population-potential-sum}

Alerted readers will notice that @eq-stewart-population-potential-sum is formally equivalent to our modern definition of accessibility.

Stewart's formulation of demographic force, developed in the context of what he called "social physics" [@stewartPrinciples1947], was problematic. It had issues with inconsistent mathematical notation. <!--For example, in @stewartDemographicGravitationEvidence1948, $G$ is used as a proportionality constant p. 34 and then later as _demographic energy_ on p. 53.--> More seriously though, Stewart's work was permeated by a view of humans as particles following physical laws, but tinted by unscientific ideas that were unadultered racism. For instance, he assumed that the molecular weight $\mu$ of the average American was one, but "presumably...much less than one....for an Australian aborigine" [p. 35]. Stewart's ideas about "social physics" soon fell out of favour among social scientists, but not before influencing the nascent field of accessibility research, as detailed next.

# Hansen's gravity-based accessibility to today

<!-- SUMMARY: Stewart 1948 made an important contribution methodologically: Hansen picked it up. Is now cited as the father of accessibility. However, Hansen work was applied, and he's use of Stewart's Population Potential measure included two crucial omissions that afflict the literature to this day. The first omission is 1) Stewart set the proportional constant $G$ to 1 _for future determination_, this constant is not explicitly addressed in @hansen1959 and accessibility continues to evolve without it. The second omission is 2) Stewart suggests that keeping the exponent value of $d_ij$ as 1 is sufficient. In @hansen1959, an exponent other than 1 for $d_ij$ is selected based on empirical findings, however, the issue of _opportunity potential_ units are never addressed. -->

From @stewartDemographicGravitationEvidence1948, we arrive to 1959 and Walter G. Hansen, whose work proved to be exceptionally influential in the accessibility literature [@hansen1959]. In his seminal paper, Hansen defined accessibility as "the potential of opportunities for interaction... a generalization of the population-over-distance relationship or _population potential_ concept developed by @stewartDemographicGravitationEvidence1948" (p. 73). As well as being a student of city and regional planning at Massachusetts Institute of Technology, Hansen was also an engineer with the Bureau of Roads, and preoccupied with the power of transportation to shape land uses in a very practical sense. @hansen1959 focused on @stewartDemographicGravitationEvidence1948's _population potential_ (expressed in @eq-stewart-population-potential-sum), leaving Stewart's other formulaic contributions and objectionable aspects of "social physics" behind. @hansen1959 recast @eq-stewart-population-potential-sum to reflect accessibility, a model of human behaviour useful to capture regularities in mobility patterns. In this equation, @hansen1959 replaced $M_j$ with _opportunities_ to derive an _opportunity potential_, or more accurately, a _potential of opportunities for interaction_ as follows:

$$
S_{i} = \sum_j \frac{O_j }{d_{ij}^\beta}
$${#eq-accessibility}

Or a contemporary rewriting of the above @eq-accessibility accounts for a variety of impedance functions beyond the inverse power $d^{-\beta}$:

$$
S_{i} = \sum_j O_j \cdot f(d_{ij})
$${#eq-accessibility-general}

$S_{i}$ in @eq-accessibility is a measure of the accessibility of site $i$. This is a function of $O_j$ (the mass of opportunities at $j$), $d_{ij}$ (the cost, e.g.,  distance or travel time, incurred to reach $j$ from $i$), and $\beta$ (a parameter that modulates the friction of cost). Today, Hansen is frequently cited as the father of modern accessibility analysis [e.g., @reggianiGuestEditorialNew2011], and Hansen-type accessibility is commonly referred to as the gravity-based accessibility measure.

Of note, however is that between @stewartDemographicGravitationEvidence1948 and @hansen1959 the proportionality constant $G$ in @eq-stewart-population-potential vanished. There is some evidence that @hansen1959 was aware of the importance of this constant as he wrote about _directly_ and _inversely proportional_ relationships between opportunities in one area, opportunities at another, and their separation distance. At any rate, those reading @hansen1959 must recall that @stewartDemographicGravitationEvidence1948 set the proportionality constant $G$ to 1, with a note that "$G$ [was] left for future determination: a suitable choice of other units can reduce it to unity". 

After @hansen1959, accessibility analysis has been widely used in numerous disciplines but, to our knowledge, the proportionality constant has remained forgotten, with no notable developments to explicitly determine it. In this way, $G$ continues to be implicitly set to $1$, even when the fundamental relationship in accessibility is proportionality (e.g., $S_{i}  \propto \sum_j g(O_j)f(d_{ij})$) and not equality [for instance, see the formula for accessibility at the top of Figure 1 in @wuUnifyingAccess2020]. Alas, without a proportionality constant, the units of $S_i$ remain unclear: the unit of "potential of opportunity for interaction" is left free to change as $\beta$ is calibrated. Hansen-style accessibility, therefore, is technically an ordinal measure of potential that can only be interpreted in terms of higher and lower accessibility [@millerAccessibilityMeasurementApplication2018]. 

# Wilson's family of spatial interaction models

<!--SUMMARY: Introduce Wilson's spatial interaction model. Then discuss how it could relate to gravity analogy -- but is tactically derived using entropy-maximisation, obtaining the interaction variable as a statistical average. Then introduce the constraints and cases. -->

In his groundbreaking work, Wilson [-@wilson1971] defined a general spatial interaction model as follows: 

$$
T_{ij} = k W_i^{(1)} W_j^{(2)} f(c_{ij})
$${#eq-phys-gravity-model}

The model in @eq-phys-gravity-model posits a quantity $T_{ij}$ that represents a value in a matrix of flows of size $n \times m$, that is, between $i = 1,\cdots, n$ origins and $j = 1,\cdots, m$ destinations. The quantities $W_i^{(1)}$ and $W_j^{(2)}$ are proxies for the masses at $i=1,\cdots,n$ origins and $j=1,\cdots,m$ destinations. Finally, $f(c_{ij})$ is the $i-j$ element of an $n \times m$ matrix representing some function of travel cost $c_{ij}$ which reflects travel impedance. In this way, $T_{ij}$ explicitly measures _interaction_ in the unit of trips, and the role of the single proportionality constant $k$ is to ensure the total sum of $T_{ij}$ represents the total flows in the data. In other words, $k$ is a scale parameter that makes the overall amount of flows identical to the magnitude of the phenomenon being modeled.

Traditionally, development of the spatial interaction model put an emphasis on the interpretability of the results [@kirbyNormalizingFactorsGravity1970; @wilsonSTATISTICALTHEORYSPATIAL1967;@wilson1971]. But instead of relying on the heuristic of Newtonian gravity (e.g., some interaction between a mass at $i$ and a mass at $j$ separated by some distance), Wilson's approach was to maximise the entropy of the system. Entropy maximisation in this cases achieves stable results as a statistical average that represents the population. The approach works by assuming undifferentiated individual interactions, and assessing their probabilities of making a particular journey. The result of @eq-phys-gravity-model then is a statistical average [@wilson1971; @seniorGravityModellingEntropy1979].

To ensure that $T_{ij}$ in @eq-phys-gravity-model is in the unit of trips, additional knowledge about the system is required. At the very least, this framework assumes that the total number of trips in the system $T$ is known, and therefore:

$$
\sum_i\sum_j T_{ij} = T
$${#eq-constraint0-gravitymodel}

Additional information can be introduced. For example, when information is available about the total number of trips produced by each origin ($O_i$), the following constraint can be used:

$$
\sum_j T_{ij} = O_i
$${#eq-constraint1-gravitymodel}

Alternatively, if there is information available about the total number of trips attracted by each destination ($D_j$), the following constraint can be used:
$$
\sum_i T_{ij} = D_j
$${#eq-constraint2-gravitymodel}

It is also possible to have information about both $O_i$ and $D_j$, in which case both constraints could be imposed on the model.

Parting from this, it is possible to derive a family of spatial interaction models. In Wilson's terms, there is the "unconstrained" (but actually total flow constrained) model in equation @eq-phys-gravity-model. The proportionality constant $k$ in this case is [see @cliff_evaluating_1974; @fotheringham_spatial_1984]:

$$
k=\frac{T}{\sum_i\sum_j T_{ij}}
$${#eq-total-flow-balancing-factor}

When only one of @eq-constraint1-gravitymodel or @eq-constraint2-gravitymodel holds, the resulting models are, in Wilson's terms, singly-constrained. Entropy maximisation leads to the following production-constrained model:

$$
T_{ij} = A_i O_i W_j^{(2)} f(c_{ij})
$${#eq-production-constrained-gravitymodel}

Notice how, in this model, the proxy for the mass at the origin $W_i^{(1)}$ is replaced by the actual mass, as measured by the trips produced $O_i$. Also, there is no longer a single system-wide proportionality constant, but rather a balancing factor specific to each origin, namely $A_i$, which Wilson found to be as follows:

$$
A_i = \frac{1}{\sum_j W_j^{(2)} f(c_{ij})}
$${#eq-production-constrained-balancing-factor}

The attraction-constrained model, in turn, takes the following form:

$$
T_{ij} = B_j D_j W_i^{(1)} f(c_{ij})
$${#eq-attraction-constrained-gravitymodel}

Notice how now the proxy for the mass at the destination $W_j^{(2)}$ is replaced by the actual mass, as measured by the trips attracted $D_j$. As before, destination-specific balancing factors $B_j$ were derived by Wilson as:

$$
B_j = \frac{1}{\sum_i W_i^{(1)} f(c_{ij})}
$${#eq-attraction-constrained-balancing-factor}

When both @eq-constraint1-gravitymodel and @eq-constraint2-gravitymodel hold, the resulting models is, in Wilson's terms, doubly-constrained, and takes the following form:

$$
T_{ij} = A_i B_j O_i D_j f(c_{ij})
$${#eq-doubly-constrained-gravitymodel}

In this model, both proxies for the masses are replaced with the known masses, that is, the trips produced by origin and the trips attracted by destination. And, now the balancing factors are:

$$
\begin{array}{l}
A_i = \frac{1}{\sum_j B_j D_j f(c_{ij})}\\
B_j = \frac{1}{\sum_i A_i O_i f(c_{ij})}
\end{array}
$${#eq-doubly-constrained-balancing-factors}

Derivation of these models is demonstrated in detail elsewhere [e.g., @ortuzar_2011_modelling; @wilsonSTATISTICALTHEORYSPATIAL1967]. It is worth noting, however, that although Wilson's approach is built on a different conceptual foundation than the old reference to Newtonian gravity, the work succeeded at identifying the steps from proportionality to equality to yield variations of proportionality constants, including the one that eluded @stewartDemographicGravitationEvidence1948 and has been ignored in almost all subsequent accessibility research. Why could this be? In the next section we aim to address this question.

# Accessibility and spatial interaction modelling: two divergent research streams

<!--
SUMMARY: Accessibility developed separate from SIM.

SIM focuses on trips and was institutionalized to develop the US Interstate highway systems. Many guidelines and practical training was done - a lot of funding. SIM development has integrated accessibility in a few ways: 1) within the SIM itself as a balancing factor, 2) as an additional independent variable in the SIM, 3) SIM and HAM in parallel in the context of location allocation problems and within the steps of transportation demand modelling (trip distribution or trip generation). 

Accessibility research has separated SIM almost entirely. When Wilson is cited: 1) typically when using a different impedance function, 2) when using the SIM to predict trip flows for accessibility input or vice versa, 3) a few exceptional papers that interpret the doubly-constraints as an inverse HAM in the context of competitive accessibility, and 4) it was only until recently, that a singly-constrain was introduced in Soukhov et al. 2023.  -->

```{r}
#| label: load-data

load(glue::glue(here::here(),
                "/data/corpus.rda"))
```

```{r}
#| label: calculate-cocMatrix
#| cache: true

# $A$ is a sparse adjacency matrix with sources cited by each document in the corpus
A <- cocMatrix(corpus, 
               Field = "CR", 
               sep = ";")
```

```{r}
#| label: coupling-matrix

# The product of $A$ and its transpose gives the bibliographical coupling by cited references $B = A\cdot A^T$

# $B$ is a square symmetric matrix where element $b_{ij}$ is the total number of cited references in common between document $i$ and document $j$. A higher value of $b_{ij}$ indicates a stronger relationship between documents $i$ and $j$ (more references in common). A value of zero indicates no references in common.
B <- tcrossprod(A)
```

```{r}
#| label: clean-coupling-matrix

# Remove the diagonal (papers cited within a single source)
B_nd <- B - Matrix::band(B, 0, 0)
```

```{r}
#| label: create-coupling-network

#These matrices are sparse symmetric matrices of "adjacencies" between documents in the corpus. Convert `B` to an `igraph` network without the diagonal
coupling_net <- igraph::graph_from_adjacency_matrix(B, 
                                            mode = "directed", 
                                            weighted = TRUE,
                                            diag = FALSE)
```

```{r}
#| label: remove-A-memory

rm(A)
```

```{r}
#| label: convert-to-tidygraph

# For convenience, convert the [{igraph}](https://r.igraph.org) object to a [{tidygraph}](https://www.data-imaginist.com/posts/2017-07-07-introducing-tidygraph/) object:
coupling_net <- tidygraph::as_tbl_graph(coupling_net)
```

```{r}
#| label: add-corpus-label-to-coupling-network

# Add the `corpus` variable to `coupling_net`. Remember to activate the nodes.
coupling_net <- coupling_net |>
  tidygraph::activate("nodes") |>
  left_join(tibble::rownames_to_column(corpus, 
                                       var = "rowname") |> 
              transmute(rowname, 
                        corpus = corpus),
            by = c("name" = "rowname"))
```

```{r}
#| label: corpus-summary

summary_coupling_network <- coupling_net |>
  tidygraph::activate("nodes") |>
  as_tibble() |>
  mutate(corpus = factor(corpus)) |>
  group_by(corpus) |>
  summarize(n = n())

# Number of documents in each corpus
# Hansen
n_h <- summary_coupling_network |> 
  filter(corpus == "Hansen") |> 
  pull(n)
# Wilson
n_w <- summary_coupling_network |> 
  filter(corpus == "Wilson") |> 
  pull(n)
# Both
n_b <- summary_coupling_network |> 
  filter(corpus == "Both") |> 
  pull(n)
```

The work of @hansen1959 and @wilson1971 responded to important developments in the Anglo-American world at the time, in particular a need "to meet the dictates and needs of public policy for strategic land use and transportation planning" [@battyChronicleScientificPlanning1994]. Said dictates and needs were far from trivial. In the US alone, the Federal-Aid Highway Act of 1956 authorized the creation of the US Interstate Highway System, with a budget of more than one hundred billion dollars [@weinerUrbanTransportationPlanning2016; @mdotMnDOTJoins2007]. Spatial interaction modelling, with its ability to quantify trips, was incorporated into institutional modelling practices meant to "predict and provide", i.e., predict travel demand and supply transportation infrastructure [@kovatch1971modeling; @weinerUrbanTransportationPlanning2016]. Accessibility at the time did not quite have that power: it did not quantify trips, but rather something more elusive: the less tangible "potential for interaction". In this way, where spatial interaction modelling became a key element of transportation planning practice, accessibility remained a somewhat more academic pursuit, and the two streams of literature only rarely connected. 

```{r}
#| label: plot-docs-per-year
#| include: false

docs_per_year_plot <- ggplot(data = corpus |> 
         group_by(corpus, PY) |> 
         summarize(n = n()),
         .groups = "drop") + 
  geom_col(aes(x = PY, 
               y = n,
               fill = corpus),
           color = "black") + 
  xlab("Publication year") + 
  ylab("Number of documents") +
  theme_minimal()

ggsave(filename = glue::glue(here::here(), 
                             "/figures/docs_per_year_plot.png"))
```

```{r}
#| label: fig-docs-per-year
#| out-width: 70%
#| fig-cap: "Historical pattern of publication: documents per year."

docs_per_year_plot
```

To illustrate this point, we conducted a bibliographic analysis of the literature that cites @hansen1959, @wilson1971 or both. We retrieved all relevant documents using the Web of Science "Cited References" functionality, and the digital object identifiers of @hansen1959 and @wilson1971. As a result of this search we identified `r n_h |> prettyNum(big.mark = ",")` documents that cite @hansen1959, `r n_w  |> prettyNum(big.mark = ",")` documents that cite @wilson1971, and `r n_b |> prettyNum(big.mark = ",")` that cite both. The earliest document in this corpus dates to `r min(corpus$PY)` and the most recent is from `r max(corpus$PY)`. The number of documents per year appears in @fig-docs-per-year, where we see the frequency of documents over a span of almost fifty years. In particular, we notice the remarkable growth in the number of papers that cite @hansen1959 compared to those that cite @wilson1971 or both.

<!--
Current transportation planning practice was arguably born in the 1950s; fueled by advancements in computer technologies and catalyzed by the unprecedented Federal-Aid Highway Act of 1956 which authorized the creation of the US Interstate Highway System, costing over a hundred billion in public spending in the following 35 years [@weinerUrbanTransportationPlanning2016; @mdotMnDOTJoins2007]. To plan this ambitious project, transportation planning practice adopted SIM and extended it into four-step transportation demand modelling; where tangible outputs of transportation systems such as _mobility_ (e.g., trips) were calibrated, modeled and applied to "predict and provide" transportation supply and demand [@kovatch1971modeling; @weinerUrbanTransportationPlanning2016]. However, within the same time period, accessibility remained largely within the academic realm. For instance, accessibility measures were used to study a variety of transportation-related dimensions such as residential (or firm) location and city growth [e.g., @kain1962multiple]; where the importance of accessibility versus non-accessibility characteristics (quality of destination, composition of household or inherent individual characteristics) were debated [e.g., @redding1970quality; @chapin1968activity] and experimentation with different cases and travel behaviours emerged showing this nuance [e.g., studies that showcase nuanced preferences in accessibility based on household characteristics or destination type etc.]. We perceive these debates as a significant point that defined accessibility's outgrowth from the mobility-oriented practical implementation of SIM in transportation planning. Accessibility's flexible definition, various mathematical formulations and increasing complexity in its application and interpretation made it a concept more difficult to institutionalize in the moments were planning "embraced" automobility-oriented regional development. 

However, in recent years, this embrace has been weakened by the mounting evidence of the burdens that automobility is placing on the planet and communities. A renewed wave of criticism levelled at traditional transportation modelling practice's focus on  _mobility_ instead of _accessibility_ have been growing [@handy2020]. Accessibility, captures the concept of _potential_ interaction, more aligned with the true purpose of transportation systems, and can be used to plan for equitable and sustainable transportation systems in ways using _mobility_ cannot. While SIM and mobility-based planning has been institutionalized in transportation practice, accessibility has yet to do so [@papaAccessibilityInstrumentsPlanning2015; @boisjolyInsiderPlannersPerspective2017; @silvaProximitycentredAccessibilityConceptual2023].  

```{r}
#| label: community-detection
#| cache: true

# Detect communities based on the bibliographic coupling. For repeatability set the random seed
set.seed(979834789)
coupling_net <- coupling_net |>
  mutate(community = as.factor(tidygraph::group_infomap(weights = weight)))
```

-->

After compiling this corpus of documents, we used the {bibliometrix} package [@bibliometrix2017] to create a bibliographical coupling matrix. In this matrix, two documents are coupled if they share at least one common reference, and the strength of the coupling increases with the number of references that the documents have in common. @fig-Fig1 presents the results. In this figure, each symbol represents a document and their distance on the plot represents the strength of bibliographical coupling: more strongly coupled documents suggests those that share more items in their lists of references are plotted closer to each other.

```{r}
#| label: layout-for-coupling-net
#| cache: true

layout <- create_layout(coupling_net,
                        layout = "stress",
                        weights = weight)
```

```{r}
#| label: plot-coupling-network
#| include: false

coupling_net_plot <- ggplot(data = layout) +
  geom_point(aes(x = x,
                 y = y,
                 shape = corpus,
                 color = corpus),
             size = 3,
             alpha = 0.7) +
  geom_point(data = layout |>
               filter(corpus == "Both"),
             aes(x = x,
                 y = y),
             shape = 1,
             size = 3) +
  geom_point(data = layout |>
               filter(corpus == "Wilson"),
             aes(x = x,
                 y = y),
             shape = 0,
             size = 3,
             alpha = 0.5) +
  theme_void()

ggsave(filename = glue::glue(here::here(), 
                             "/figures/Han_Wilson_bib_coupling_plot.png"))
```

```{r}
#| label: fig-Fig1
#| out-width: 70%
#| fig-cap: "Bibliometric coupling of papers that cite Hansen (1959) and/or Wilson (1971)."

coupling_net_plot
```

```{r}
#| label: center-of-mass-of-Hansen

# This is the center of mass of the documents that cite Hansen
hansen_center_of_mass <- layout |>
  filter(corpus == "Hansen") |>
  summarize(x = mean(x),
            y = mean(y))
```

```{r}
#| label: center-of-mass-of-Wilson

# This is the center of mass of the documents that cite Wilson
wilson_center_of_mass <- layout |>
  filter(corpus == "Wilson") |>
  summarize(x = mean(x),
            y = mean(y))
```

```{r}
#| label: row-names-by-corpus

# Extract the row names by corpus to be able to partition the coupling matrix
hansen_names <- rownames(corpus |>
                           filter(corpus == "Hansen"))

wilson_names <- rownames(corpus |>
                           filter(corpus == "Wilson"))

both_names <- rownames(corpus |>
                           filter(corpus == "Both"))
```

```{r}
#| label: partition-of-coupling-matrix

# With the row names we can extract submatrices to examine the strength of coupling within and between the three corpora, i.e., documents that cite only Hansen, only Wilson, or both
hansen_to_wilson <- B_nd[hansen_names, wilson_names]

hansen_to_hansen <- B_nd[hansen_names, hansen_names]

wilson_to_wilson <- B_nd[wilson_names, wilson_names]

both_to_both <- B_nd[both_names, both_names]

both_to_hansen <- B_nd[both_names, hansen_names]

both_to_wilson <- B_nd[both_names, wilson_names]
```

```{r}
#| label: summary-of-coupling-within-and-between-corpora 

# The number of common citations per pair of documents can be calculated as the sum of all common citations in the matrix, divided by the number of pair-paper combinations:
# Average coupling for the total corpora
c_t <- sum(sum(B_nd))/(dim(B_nd)[1] * (dim(B_nd)[2]))
# Average coupling for papers that cite both Hansen and Wilson
c_b <- sum(sum(both_to_both))/(dim(both_to_both)[1] * (dim(both_to_both)[2]))
# Average coupling for papers that cite only Hansen
c_h <- sum(sum(hansen_to_hansen))/(dim(hansen_to_hansen)[1] * (dim(hansen_to_hansen)[2]))
# Average coupling for papers that cite only Wilson
c_w <- sum(sum(wilson_to_wilson))/(dim(wilson_to_wilson)[1] * (dim(wilson_to_wilson)[2]))
# Average coupling between papers that cite both Hansen and Wilson, and those that cite only Hansen
c_h_to_b <- sum(sum(both_to_hansen))/(dim(both_to_hansen)[1] * dim(both_to_hansen)[2])
# Average coupling between papers that cite both Hansen and Wilson, and those that cite only Wilson
c_w_to_b <- sum(sum(both_to_wilson))/(dim(both_to_wilson)[1] * dim(both_to_wilson)[2])
# Average coupling between papers that cite only Hansen, and those that cite only Wilson
c_h_to_w <- sum(sum(hansen_to_wilson))/(dim(hansen_to_wilson)[1] * dim(hansen_to_wilson)[2])
```

Further examination of the bibliographical coupling matrix allows us to check the coupling strength within and between subgroups of documents (i.e., those that cite only Hansen, only Wilson, or both papers). First, we note that when we look at the three subgroups of documents pooled together, the average number of references shared by a pair of documents is `r round(c_t, 2)`. @tbl-coupling-results presents the average number of items cited in common within each subgroup, as well as between subgroups. As seen in the table, the coupling within subgroup tends to be higher than when we consider the full corpus with all three groups together. The tightest coupling is seen for the group of documents that cite both Hansen and Wilson, with an average number of references in common of `r prettyNum(c_b, digits = 3)`. The weakest coupling is between the Hansen and Wilson subgroups, with only `r prettyNum(c_h_to_w, digits = 1)` references in common on average, which indicates a large degree of decoupling (independence) between these bodies of work.

```{r}
#| label: tbl-coupling-results
#| tbl-cap: "Average coupling strength within and between groups of documents. The average coupling strength is the number of references shared on average by a pair of documents."

data.frame(corpus = c(glue::glue("Hansen (n = {n_h |> prettyNum(big.mark = ",")})"), 
                      glue::glue("Wilson (n = {n_w |> prettyNum(big.mark = ",")})"),
                      glue::glue("Both (n = {n_b  |> prettyNum(big.mark = ",")})")),
           Hansen = c(prettyNum(c_h, digits = 3),
                      prettyNum(c_h_to_w, digits = 1),
                      prettyNum(c_h_to_b, digits = 3)),
           Wilson = c("-",
                      prettyNum(c_w, digits = 3),
                      prettyNum(c_w_to_b, digits = 3)),
           Both = c("-",
                    "-",
                    prettyNum(c_b, digits = 3))
           ) |>
  gt() |>
  tab_footnote(footnote = glue::glue("Average coupling for the pooled set of documents (n = {(n_h + n_w + n_b) |> prettyNum(big.mark = ",")}) is {round(c_t, 2)}")) |>
  tab_options(footnotes.font.size = "small") |>
  as_latex()
```

<!-- 
In summary, papers that cite only @hansen1959 do not focus on SIM and instead focus on _potential_ for interaction while papers that cite only @wilson1971 deal with SIM in the realm of _interaction_. Those that cite both @hansen1959 and @wilson1971 (77 journal articles) are of interest in this paper, as they often focus on accessibility's role within the SIM formulation (@eq-phys-gravity-model) but are often still seem to be more SIM than HAM, hence are overviewed as follows. 

Often, these SIM/HAM papers seek interpretation of the HAM within the SIM. Specifically, many early works in the 70s and 80s have indicated that HAM is represented within the balancing factors of the SIM [@harrisEquilibriumValuesDynamics1978; @leonardiOptimumFacilityLocation1978; @fotheringhamSPATIALSTRUCTUREDISTANCE1981; @fotheringhamSpatialCompetitionAgglomeration1985]. Recognizing the balancing factors as HAM is a "common sense" approach at including accessibility in the SIM [@morrisAccessibilityIndicatorsTransport1979], though its relationship may be worth further exploring [@battyMethodResiduesUrban1976]. 

However, some authors that did explore this relationship, for instance as in @fotheringhamSpatialCompetitionAgglomeration1985 who demonstrates how SIM may insufficiently explain spatial patterns and how explicitly defining destination's accessibility, citing HAM as convenvient formulation, within the SIM framework may remedy the issue. This re-formulation of the SIM later came to be defined as _competition destination_ model, and is now one of a few techniques to address spatial variation in SIMs [@oshanSpatialStructureDebate2021]. Other early SIM works incorporating accessibility also went implicitly beyond this understanding that accessibility is neatly considered within the SIM framework. Some works went beyond HAM and considered other accessibility expressions of individual choice. For instance, using concepts of micro-economic consumer behaviour such as random utility choice models [@morrisAccessibilityIndicatorsTransport1979; @leonardiRandomUtilityDemand1984]. Other papers used the SIM and HAM in conjunction, such as in Operations research that define a location-allocation problem using the singly-constrained SIM, and HAM as an objective function subject [@leonardiOptimumFacilityLocation1978; @beaumontLocationallocationProblemsPlane1981].

Interestingly from this work in the 70s and 80s, it can be understood that while the balancing factors within the SIM could be read as HAM, they should not be understood as capturing accessibility -eek? I don't think I can say this--. We also gather that in this moment of growing complexity of SIM (not) capturing accessibility, literature exploring accessibility sprouted in new mediums of budding GIS technologies and the conceptual emergence of space-time dimensions in the 90s onward [e.g., @millerMeasuringSpaceTimeAccessibility1999; @occelli2000revisiting]. With the possibility for showcasing complex GIS methodologies for varied case studies, this accessibility-based literature became mature enough to branch off on its own without meting in the affairs of SIM. 

In papers published within and after the 1990s, @hansen1959 is consistently cited as providing a definition of accessibility or in using the HAM, however the attribution of @wilson1971 is various. @wilson1971 is cited alongside accessibility-based literature in three important ways; two of which incorrectly conflate and interpret the SIM and HAM.

Firstly, many of these works attribute @wilson1971 for using different context-dependent travel cost functions [@weibullNumericalMeasurementAccessibility1980; @handyMeasuringAccessibilityExploration1997; @kwan1998space; @shenLocationCharacteristicsInnercity1998;@ashiru2003space; @rau2012spatial; @pan2013impacts; @margaridacondecomelhoradoImpactMeasuringInternal2016; @caschili2015accessibility; @grengs2015nonwork; @pan2020measuring; @chia2020extending; @roblot2021participation; @sharifiasl2023incorporating; @kharel2024examining]. 

Secondly, in the 2000s and beyond, the concept of spatial interaction and accessibility are conflated throughout the years [e.g., @giuliano2010accessibility; @grengs2010intermetropolitan; @grengs2010job; @grengs2012equity; @levine2012does; @levinson2012positive; @tong2015transportation; @liu2015spatial; @he2017measuring; @wuUnifyingAccess2020; @ng2022reflection; @naqavi2023mobility; @suel2024measuring]; indeed, accessibility is an expression of _potential_ spatial interaction, and should not be interpreted the same way as the SIM is commonly used. Surprisingly, @hansen1959 and @wilson1971 are further conflated by being co-cited as being 'gravity models' [e.g., @liu2004accessibility; @dai2017visualization; @shen2019segregation; @chia2020extending]. 

And thirdly, accessibility-based literature cite @wilson1971's balancing factors, and re-iterate how they can be interpreted as the inverse of HAM and hence can capture competition [@vickermanAccessibilityAttractionPotential1974; @karstEvaluationAccessibilityImpacts2003;@geurs2006accessibility; @willigers2007accessibility;@el2011place; @curtis2010planning; @manaugh2012makes; @chen2013regional; @alonso2014labour; @albacete2017measuring; @sahebgharani2019computing; @mayaud2019future; @allenMeasureCompetitiveAccess2020; @levinsonGeneralTheoryAccess2020; @marwal2022literature; @su2023untangling]. However, we argue that this interpretation is fraut, considering @fotheringhamSpatialCompetitionAgglomeration1985's demonstration that SIM does not completely incorporate accessibility. However some work does consider competition more scrupulously; these works use SIMs to estimate trip (or some other interaction flows) alongside accessibility indicators [e.g., @clarke2002deriving; @grengs2004measuring; @turk2019socio] or integrate accessibility within the SIM, in line with @fotheringhamSpatialCompetitionAgglomeration1985's demonstration and most often in context with retailing [@beckers2022incorporating]. Only the work of @soukhovIntroducingSpatialAvailability2023 and @soukhovMultimodalSpatialAvailability2024 cite @wilson1971's use of balancing factors as ways to maintaining constraints in opportunities in the context of competitive accessibility.  

Indeed, @hansen1959 offers a relatively straightforward and practical application of accessibility, while @wilson1971's contribution is methodological and dense. Accessibility-based literature that has flourished since the 1990s, sprouting from the rise of GIS technologies, the plethora of _bigger_ data and different qualities of opportunities and populations to examine, it has developed in a different direction. However, HAM and SIM share similar roots, there are plenty of insights to be shared across these sibling branches. A relevant and contemporary connection between HAM and SIM is in the realm of competitive accessibility, and how the SIM can be reconceptualised as measuring _potential for interaction_ and competition can be interpreted through the regional and zonal constraints ensured by the balancing factors. How these balancing factors are applied in the context of _interaction_ like trips  can be applied to accessibility outputs like the "number of opportunities potentially interacted with".
-->

<!--
The approach is based on partition functions from statistical mechanics (the physics of gases), not Newtonian gravitation. In short, the approach accepts that there are macro, meso, and micro states. In the case of 'trips' being the interaction variable, a micro state is an individual trip maker, the meso state is the statistically representative zone representing a collection of individual trip makers, and the macro state is the entire study region. Using these assumptions, a set of $T_{ij}$ that maximizes the number of micro states in each meso state subject to some sensible macro-state constraints (@eq-constraint0-gravitymodel, @eq-constraint1-gravitymodel, and @eq-constraint2-gravitymodel). From this approach, the SIM can be interpreted as the given the total number of individual trips (micro level) statistically represented at origin and destination zones (meso level), the cost of travelling (micro level, represented at the meso level), and the fixed total cost of travelling in the region (number of trips and cost of travel at the macro level). There is then a most probable distribution of trips between zones (meso-states) that satisfies all the macro-state constraints.

Using these constraints, the SIM @eq-phys-gravity-model is distinguished into three general cases. These cases are presented in increasing order of constraint restrictiveness and continued to be useful in classifying the SIM in trip distribution modelling to this day [@ortuzar_2011_modelling].
-->

# A family of accessibility measures

As we argued in the preceding sections, the accessibility and spatial interaction modelling literature streams tended to evolve with relatively little contact. This may explain the failure of the constraints/proportionality constant(s) of spatial interaction models to cross over to accessibility analysis. This is intriguing, considering that Wilson himself made an effort to connect his developments in spatial interaction modelling to accessibility, noting the similarity between the denominator in @eq-production-constrained-balancing-factor and Hansen's accessibility indicator. In fact, Wilson noted that Hansen's accessibility was the inverse of $A_i$, which offered a potential interpretation for the balancing factor (p. 10):

$$
S_i = \frac{1}{A_i} = \sum_j W_j^{(2)} f(c_{ij})
$${#eq-Ai-as-accessibility}

This, however, only helps to illustrate the ease with which confusion may arise in this context. The relationship in @eq-Ai-as-accessibility appears to be misguided when we note that Hansen, and Stewart before him, defined accessibility as a partial sum of the demographic force $F$, essentially going from the demographic force:

$$
F = G\frac{M_1\cdot M_2}{d_{12}^2}
$$

\noindent to the pairwise population potential:
$$
V_1 = G\frac{M_2}{d_{12}}
$$

\noindent and from there to the system-wide population potential:
$$
V_i = \sum_j \frac{M_j}{d_{ij}}
$$

It is useful to think of the accessibility as a partial sum of the spatial interaction, before we return to Wilson's general model:

$$
T_{ij} = k W_i^{(1)} W_j^{(2)} f(c_{ij})
$$

Then, we define the _potential for interaction_ (i.e., accessibility) as follows:

$$
V_{ij} = k W_j^{(2)} f(c_{ij})
$${#eq-access}

\noindent where $V_{ij}$ is the potential for interaction. Similar to @eq-phys-gravity-model, $W_j^{(2)}$ is the mass at the destination, and the sub-indices are for $i = 1,\cdots, n$ origins and $j = 1,\cdots, m$ destinations.

<!--
. Potential interaction is the preoccupation of accessibility measures. The same analytical framework to define the balancing factors $k$ can be used for the family of accessibility measures as in the family of SIMs, however with different interpretation. In this section, we explicitly define these cases. 
-->

From here, we can define various accessibility measures depending on how we choose to constrain them.

## Unconstrained accessibility

Unconstrained accessibility results when we set the proportionality constant/balancing factor to one in @eq-access:

$$
V^0_{ij} = W_j^{(2)} f(c_{ij})
$${#eq-unconstrained-access}

Then, the partial sum becomes:

$$
V^0_i = \sum_j V^0_{ij} = \sum_j W^{(2)}_jf(c_{ij}) = S_i
$${#eq-unconstrained-accessibility}

We can see that in this case we simply have Hansen's accessibility. In general, the following does not hold true:

$$
\sum_i V^0_{i} = O
$${#eq-no-constraint0-accessibility}

\noindent where $O$ is the total number of opportunities in the system. In other words, the sum of all accessibility scores will generally be different from the total of the opportunities available in the region. To complicate matters, the difference will depend on the choice of impedance function $f(c_{ij})$ and any associated parameters, as well as the number of locations $n$ for which an accessibility score is calculated. For this reason, unconstrained accessibility can only be appropriately used as an ordinal variable to make comparisons of size (greater than, less than, equal to), but not to calculate intervals (the magnitude of differences) or ratios.

## Total opportunity constrained accessibility

We can choose to retain the proportionality constant in @eq-access to obtain the following:

$$
V^T_{ij} = kW_j^{(2)} f(c_{ij})
$${#eq-total-constrained-access}

Our accessibility measure now becomes:

$$
V^T_i = \sum_j V^T_{ij} = k\sum_j W^{(2)}_jf(c_{ij}) = kV^0_i
$${#eq-total-constrained-accessibility}

The constraint that we impose in this case is the total number of opportunities in the region $O$ (compare to @eq-constraint0-gravitymodel):

$$
\sum_i\sum_j V^T_{ij} = O
$${#eq-total-constraint-accessibility}

Substituting @eq-total-constrained-accessibility in @eq-total-constraint-accessibility, and solving for $k$, we have that (compare to the constant in the total flow spatial interaction model, Equation 2.11 in @cliff_evaluating_1974):

$$
k=\frac{O}{\sum_i\sum_j V^0_{ij}}
$${#eq-total-opportunity-balancing-factor}

Let us write our total opportunity constrained accessibility as follows:

$$
V^T_i = k\sum_j W^{(2)}_jf(c_{ij}) = \sum_j W^{(2)}_j\frac{O*f(c_{ij})}{\sum_i\sum_j V^0_{ij}} = \sum_j W^{(2)}_j\frac{O*f(c_{ij})}{\sum_i\sum_j W^{(2)}_jf(c_{ij})} 
$$

Further, we can see that, since $O$ and $W^{(2)}_j$ are opportunities, the following term is dimensionless:

$$
\kappa = \frac{O*f(c_{ij})}{\sum_i\sum_j W^{(2)}_jf(c_{ij})}
$$

\noindent and therefore $V^T_i$ is now in the units of $W^{(2)}_j$, that is, the mass at the destination:

$$
V^T_i = \kappa\sum_j W^{(2)}_j 
$$

Notice that the role of $\kappa$ in this reformulation of accessibility is to adjust the number of opportunities accessible from $i$ so that they represent a proportion of the total number of opportunities in the region. Constant $\kappa$ then assigns opportunities in proportion to the impedance between $i$ and $j$. For this reason we call it a proportional allocation factor.

## Singly-constrained accessibility: attraction-constrained 

If we decide to introduce additional information into our analysis, say, the number of opportunities _by destination_ (i.e., $O_j$), we can impose the following constraint (compare to @eq-constraint2-gravitymodel):

$$
\sum_i V^D_{ij} =  D_j
$${#eq-attraction-constraint}

The underlying spatial interaction model is now the attraction-constrained model in @eq-attraction-constrained-gravitymodel, and our accessibility measure becomes:

$$
V^D_{i} = \sum_j B_j D_j W_i^{(1)} f(c_{ij})
$${#eq-attraction-constrained-accessibility}

\noindent where $W_i^{(1)}$ is a measure of the mass at origin $i$ (i.e., the opportunity-seeking population). The corresponding balancing factor, as per Wilson, is:

$$
B_j = \frac{1}{\sum_i W_i^{(1)} f(c_{ij})}
$$

If we introduce this balancing factor in @eq-attraction-constrained-accessibility we obtain:

$$
V^D_{i} = \sum_j D_j \frac{W_i^{(1)} f(c_{ij})}{\sum_i W_i^{(1)} f(c_{ij})}
$${#eq-attraction-constrained-accessibility-with-balancing-factor}

Further, we define the following proportional allocation factor:

$$
\kappa^D _{ij} = \frac{W_i^{(1)} f(c_{ij})}{\sum_i W_i^{(1)} f(c_{ij})}
$${#eq-attraction-constrained-proportional-allocation-factor}

After this, it is possible to rewrite @eq-attraction-constrained-accessibility-with-balancing-factor as:

$$
V^D_{i} = \sum_j  \kappa^D_{ij} D_j
$${#eq-attraction-constrained-accessibility-with-proportional-allocation-factor}

@soukhovIntroducingSpatialAvailability2023 have shown that the role of $\kappa^D_{ij}$ is to allocate opportunities $D_j$ proportionally to the mass at each origin $i$ and the impedance between $i$ and $j$. As before, $\kappa^D_{ij}$ is dimensionless and $V_i^D$ is in the units of opportunities $D_j$. The singly-constrained accessibility measure in @eq-attraction-constrained-accessibility-with-proportional-allocation-factor is called spatial availability by @soukhovIntroducingSpatialAvailability2023, because it represents the number of opportunities that can be reached _and_ are available, in the sense that there is no competition for them. These authors also show that the following expression (accessibility per capita) is a constrained version of the popular two-stage floating catchment area measure of @shen1998 and @luo2003:

$$
v^D_{i} = \frac{V^D_{i}}{W^{(1)}_i}
$$

As an additional point, the constraint in @eq-attraction-constraint ensures that the following also holds:

$$
\sum_i V^D_{i} = O
$$

For this reason, $\frac{V_i^D}{O}$ can be interpreted as the proportion of opportunities accessible _and_ available to location $i$ out of the total number of opportunities in the system

## Singly-constrained accessibility: production-constrained  

Not the most common application of accessibility analysis, but if the origins and destinations are transposed, we can define a measure of market potential that preserves the population. The underlying spatial interaction model is now the production-constrained model in @eq-production-constrained-gravitymodel, and our market potential measure $V^P_i$ becomes:

$$
V^P_j = \sum_i A_i O_i W_j^{(2)} f(c_{ij})
$${#eq-attraction-constrained-accessibility}

In this case the measure is constrained by the population _by origin_ (i.e., $P_i$). Compare to @eq-constraint2-gravitymodel:

$$
\sum_j V^P_{ij} =  P_i
$${#eq-attraction-constraint}

The corresponding balancing factor, as per Wilson, is:

$$
A_i = \frac{1}{\sum_j W_j^{(2)} f(c_{ij})}
$$

Following the same logic as in the preceding section, one arrives at the following expression:

$$
V^P_{j} = \sum_i  \kappa^P_{ij} P_i
$${#eq-production-constrained-accessibility-with-proportional-allocation-factor}

\noindent with:

$$
\kappa^P _{ij} = \frac{W_j^{(2)} f(c_{ij})}{\sum_i W_j^{(2)} f(c_{ij})}
$${#eq-attraction-constrained-proportional-allocation-factor}

In addition to market potential, $V_j^P$ can be interpreted as a constrained measure of "facility crowdedness" as in @wang_inverted_2018. This "crowdedness" now satisfies, in addition to @eq-attraction-constraint, the following:

$$
\sum_j V^P_{j} = P
$$

\noindent where $P$ is the total population of the region. In this way, $\frac{V_j^P}{P}$ can be interpreted as the proportion of the total population serviced by location $j$.

<!--

## Gravity-based accessibility's cousin: Wilson's spatial interaction model
Today's gravity-based accessibility measures (@eq-accessibility-general) share the same early 20th century Newtonian-based origins as the model's of Reilly, Zipf, and Stewart, versions of which continue to be extensively used today in transportation demand modelling [@ortuzar_2011_modelling;@wilson1971]. However, in many ways these spatial interaction models, commonly refered to as gravity models, continued to evolve independently from accessibility (@eq-accessibility-general). Our paper aims to demonstrate that Hansen-type accessibility can be interpreted as a SIM. This connection can enrich the accessibility literature by linking it to the extensive practical application of SIMs. This paper's focus is on how SIMs utilize "proportionality constants" and constraints to interpret results, and how Hansen-type accessibility can transit to _constrained_ accessibility.

--> 

<!--
## Interpreting SIM constraints for accessibility

SUMMARY: Introduce the SIM constraints generally, and explain them in terms of accessibility (e.g., P_i as weight at origin and O_j as weight at destination)

Then, detail a synthetic example for 'non-constrained' (e.g., HAM), Total constrained, Singly-constrained (both versions), Doubly-constrained and finally Hybrid constrained (?maybe?).

Instead of an interaction variable as in the SIM (e.g., trips, spending, sales), we focus on _potential_ interaction (e.g., accessible opportunities). Potential interaction is the preoccupation of accessibility measures. The same analytical framework to define the balancing factors $k$ can be used for the family of accessibility measures as in the family of SIMs, however with different interpretation. In this section, we explicitly define these cases. 

In this context, accessibility is our _interaction_ variable of choice, so $T_{ij}$ in @eq-phys-gravity-model is replaced with $V_{ij}$. As the interaction variable represents _potential_, i.e., the number of potential reachable opportunities, as opposed to trips:

$$
V_{ij} = k W_i^{(1)} W_j^{(2)} f(c_{ij})
$${#eq-access}

Where $V_{ij}$ consists of the same variables, however $V_{ij}$ explicitly measures _potential interaction_ as a unit of number of potentially reachable opportunities and the single proportionality constant $k$ ensures the total sum of $V_{ij}$ represents the total potential reachable opportunities in the data. Notably, the mass vectors $W_i^{(1)}$ and $W_j^{(2)}$ can be replaced by $P_i$ and $O_j$, representing the weight of the origin (population) and destination (opportunities) as known, the weights common in accessibility literature. As accessibility is the sum of opportunities for a $j$ from $i$, when the mass of the origin ($P_i$) is relevant, it enters @eq-access through the $k$ constant. Accessibility is also most often presented as a locational measure, so the value of $V_i$ is of most interest, e.g., the number of potentially reachable opportunities at a zone:

$$
V_{i} = k W_i^{(1)} \sum_j W_j^{(2)} f(c_{ij})
$${#eq-access-sum}


Like with @eq-phys-gravity-model, we distinguish @eq-access into three cases based on versions of the gravity-model building constraints (@eq-constraint0-access,  @eq-constraint1-access, and @eq-constraint2-access) to reflect macro-level knowledge, i.e., the sum of the number of potential reachable opportunities. 

$$
\sum_i\sum_j V_{ij} = V
$${#eq-constraint0-access}
\noindent Where the sum of all potentially reached opportunities in the region is equal to a total opportunities in the region $V$.


$$
\sum_j V_{ij} = P_i
$${#eq-constraint1-access}
\noindent Where sum of all potentially reachable opportunities for all $j$ zones in the region is equal to the production weight at each $i$ in the region.

$$
\sum_i V_{ij} =  O_j
$${#eq-constraint2-access}

\noindent Where sum of all potentially reachable opportunities for all $i$ zones in the region is equal to the attraction weight at each $j$ in the region.

All three cases are differentiated as follows:
- The total constrained case: only @eq-constraint0-access hold. In this case, $V$ is the number of potential for interaction 
- The singly-constrained case: either @eq-constraint1-access holds (origin-constrained)  or @eq-constraint2-access holds (destination-constrained) -- can only be in any combination of "potential for interaction" units, e.g., units of "opportunities" or "population" or "population for opportunities" or "opportunities for population; 
- The doubly-constrained case: both @eq-constraint1-access and @eq-constraint2-access hold simultaneously production-attraction


Notably, $V_{ij}$ can be in any combination of "potential for interaction" units that reflect the meaning of the spatial weights matrix e.g., units of "opportunities" from $i$ to $j$, or "population" from $i$ to $j$, or "population for opportunities" from $i$ to $j$, or "opportunities for population" from $i$ to $j$. The meaning of the units depends on the constraints: e.g., if singly-constrained - the spatial weights matrix represents units of opportunity or population while in doubly-constrained population and opportunities are two sides of this same matrix so take on the meaning of "population for opportunities" or "opportunities for population" from $i$ to $j$. 

Also it is relevant to describe previous accessibility literature relation to this framework:
- Nonconstrained cases: current practice, the HAM, where @eq-constraint0-access, @eq-constraint1-access, nor  @eq-constraint2-access hold.
- HYBRID CASE: examples of where @eq-constraint1-access or @eq-constraint2-access partly hold BFCA? Others?


In these cases, $V_{ij}$ is never explicitly defined but we work backwards to develop it and place it within the SIM framework. 

Like the conventional SIM, $V_{ij}$ can be solved using a travel cost matrix and a spatial weights matrix but with alternative meanings. $P_i$ (our $W_i^{(1)}$ if known) is population at $i$ who seek opportunities. $O_j$ (our $W_j^{(2)}$ if known) are the opportunities being sought. For this simple example, we can say that the opportunities are the population's jobs. In our region, each person has a job - but we only know at an aggregate how many people are at each $i$, the jobs that are located at $j$ and the travel cost $c_{ij}$. We assume the the travel impedance ($f(c_{ij})$) is the associated travel propensity of $f(c_{ij}) = 1/C$. 
-->

## Doubly-constrained

In the case of SIM calibrated for accessibility, the doubly-constrained case has more limited applications than the singly-constrained case because the double constraints (both marginals) are so specific. In this case, the units of the population and opportunities must be able to be understood as the same. E.g., the number of population at $i$ that seek opportunities at each $j$ and the number of opportunities at $j$ that are sought by population at each $i$ must both be known to match. 

In our examples of children and schools, and urgent care clincs and all people, they could be solved as doubly-constrained if additional information was known. In the case of urgent care children and schools, if the number of children at $i$ that visit specific schools $j$ was additionally known: then the doubly-constrained $V_{ij}$ could be interpreted as "the number of school-seats accessible from $j$ by the students at $i$ " OR "the number of students accessible from $i$ by the school-seats at $j$" - they would be equivalent statements. If you sub in 'urgent-care-seats' for 'school-seats' and 'population' for 'students', you'd have the analogous interpretation for the doubly-constrained case for urgent care clinics described. 

Literature has explored 'doubly-constrained' but -- not the same: , etc. Ex. @hornerExploringMetropolitanAccessibility2004 and @allenMeasureCompetitiveAccess2020.

# Simple numerical example

The following is the known accessibility matrix. The $V_{ij}$, the number of jobs spatially accessible at $i$ from destination $j$. The TOTALs are the $V_i$ and $V_j$, the total number of jobs spatially available at $i$ and the number of jobs spatially available from $j$.

The following vectors are the population by origin ($O_i$) and the opportunities by destination $D_j$:

<!--Check here, the number of physicians per 10,000 in Canada in 2022 was 24.97
https://en.wikipedia.org/wiki/List_of_countries_by_number_of_physicians -->
```{r}
#| label: simple-numerical-example-opportunities-and-population

id <- c("1", "2", "3")
O_i <- c(4, 10, 6) 
D_j <- c(160, 150, 180)
LU <- data.frame(id, O_i, D_j)
```

```{r}
LU
```

Think of $O_i$ as population in 10,000 and $D_j$ as number of physicians. The Provider-to-Population-Ratio (PPR) is:
```{r}
sum(LU$D_j) / sum(LU$O_i)
```

And the cost of travel from $i$ to $j$ is as follows:
```{r}
#| label: simple-numerical-example-cost

# Simulate a table with OD cost for the simple example, beginning with the ids, the cost, and then two impedance functions 
C <- expand.grid(oid = c("1", "2", "3"),
                 did = c("1", "2", "3")) |>
  mutate(cost = c(2, 15, 5, 15, 2, 10, 5, 10, 2)) |>
  mutate(f1 = exp(-1.00000 * cost^2), 
         f2 = exp(-0.01000 * cost^2),
         f3 = exp(-0.00001 * cost^2))
```

```{r}
C |> select(oid, did, cost)
```

For comparison, use three different impedance functions:
$$
\begin{array}{l}
f_1(c_{ij}) = exp(-c_{ij}^2)\\
f_2(c_{ij}) = exp(-0.01\cdot c_{ij}^2)\\
f_3(c_{ij}) = exp(-0.00001\cdot c_{ij}^2)
\end{array}
$$

## Unconstrained accessibility 

The following case is standard practice, the HAM. It is expressed as a value of the origin, a summary of the destination weight multiplied by the travel impedance. There is no explicit consideration of a proportionality constant ($k$), we can presume it is still set to 1 as in @stewartPrinciples1947. Neither are there origin weights $W_i^{(1)}$, we assume is also wrapped up in this proportionality and implicitly set to 1. Working backward from this expression and assumptions, $S_{ij}$ can be expressed more generally as well. 

$S_i$ reflects the magnitude of opportunity accessibility but it is not scaled to equal the number opportunities $O_j$ and/or population $P_i$ (only in some case when $k$ and $W_i^{(1)}$ equal 1).

In solving the example, each origin (row) all the opportunities at each destination are available. Likewise, each destination (column) offers all opportunities to each origin: 
```{r}
#| label: simple-numerical-example-OD-table

OD <- C |>
  left_join(LU |>
              select(-D_j),
            by = c("oid" = "id")) |>
  left_join(LU |>
              select(-O_i),
            by = c("did" = "id"))
```

```{r}
unc_acc_ij <- OD |>
  group_by(oid) |>
  reframe(V_unc_ij_1 = D_j * f1,
            V_unc_ij_2 = D_j * f2,
            V_unc_ij_3 = D_j * f3)

unc_acc <- unc_acc_ij |>
  group_by(oid) |>
  summarize(V_unc_i_1 = sum(V_unc_ij_1),
            V_unc_i_2 = sum(V_unc_ij_2),
            V_unc_i_3 = sum(V_unc_ij_3))

unc_acc
```

Compare the accessibility differences and between pairs of zone using the two different impedance functions: 
```{r}
unc_acc$V_unc_i_1[2] - unc_acc$V_unc_i_1[1]
unc_acc$V_unc_i_2[2] - unc_acc$V_unc_i_2[1]
unc_acc$V_unc_i_3[2] - unc_acc$V_unc_i_3[1]

unc_acc$V_unc_i_1[2]/unc_acc$V_unc_i_1[1]
unc_acc$V_unc_i_2[2]/unc_acc$V_unc_i_2[1]
unc_acc$V_unc_i_3[2]/unc_acc$V_unc_i_3[1]
```

This illustrates how the differences and ratios are not meaningful.

The total accessibility compared to the number of opportunities:
```{r}
unc_acc <- unc_acc |> 
  left_join(LU |>
              select(-D_j),
            by = c("oid" = "id"))

unc_acc  |>
  summarize(V_unc_1 = sum(V_unc_i_1),
            V_unc_2 = sum(V_unc_i_2),
            V_unc_3 = sum(V_unc_i_3))

LU |>
  summarize(O = sum(D_j))
```

And the ratio of accessibility to population compared to the ratio of opportunities to population:
```{r}
# Accessibility divided by population
unc_acc |> 
  mutate(v_unc_1 = V_unc_i_1/O_i,
            v_unc_2 = V_unc_i_2/O_i,
            v_unc_3 = V_unc_i_3/O_i)

# Sum of the accessibility divided by the total population
unc_acc |> 
  summarize(v_unc_1 = sum(V_unc_i_1)/sum(O_i),
            v_unc_2 = sum(V_unc_i_2)/sum(O_i),
            v_unc_3 = sum(V_unc_i_3)/sum(O_i))

# Sum of the opportunities divided by the total population
LU |> 
  summarize(PPR = sum(D_j)/sum(O_i))
```

Notice the wild differences. Accessibility according to impedance function 3 basically says that everyone has access to all opportunities all at once. Accessibility according to function 1, on the other hand, says that each population has accessibility to around 3 opportunities, which is absurd: the number of opportunities available locally are in the order of 150-180. One should not have to adjust the impedance function to obtain "reasonable" results [EXAMPLE]; instead, the impedance function should reflect the travel behavior.

**PREVIOUS TEXT FOLLOWS: REVISE DISCUSSION**

We'd report origin 1 as having 148 accessibility (i.e., $S_{i=1} = 148$), origin 2 as 248 accessibility, and origin 3 as 172 accessibility. The total accessibility in the region is 568 ($\sum_i S_{i} = 568$), not equal to any meaningful value. This value is not often reported in the accessibility literature for this reason. One could also report the accessibility values that destinations offers ($S_{j}$), namely destination 1 offers 123, destination 2 offer 291, and destination 3 offers 154. However, these values are also not reported in the literature currently... as they aren't constrained to match up to anything known, including the number of opportunities at each j (i.e., 160, 437 and 193). Assuming $k=1$, $S_i$ and $S_j$ represent magnitudes of accessibility concepts, but in an nonconstrained way. The population matrix is not incorporated in the $S_{ij}$ calculation, so $S_i$ cannot be directly compared to population. From a different perspective, $S_j$ values also cannot be compared to known $O_j$ values as the equation unconstrained. 

OF NOTE: in the context of spatial interaction modelling, this nonconstrained version of model is seldom useful. While the resulting $T_{ij}$ values are technically units of 'trips' - there are no constraints, so the assumption of $k$ and $W_i^(1)$ equaling 1 is practically meaningless. 

Accessibility, or the _potential_ for interaction is different than interaction ($V_{ij}$ vs. $T_{ij}$), namely since the number of opportunities that are accessible at an origin from a destination cannot be known in the same way as a trip from an origin to a destination. However, we would argue that getting closer to knowing this number and planning for it - is what accessibility research should strive to capture. An origin-destination based accessibility value $V_{ij}$. We demonstrate the following three cases sub-sequently.

**END OF PREVIOUS TEXT** 

## Total constrained accessibility

**PREVIOUS TEXT FOLLOWS: REVISE DISCUSSION**

Solved for our example, $K$ is equal to the total accessibility $V$, the only thing we know: either all the opportunities $O$ or all the population $P$, divided by remaining part of the equation. In the following, we assume our spatial weights matrix only reflects $W_j^(2)$ as $O_j$ and $W_i^{(1)}$ is uniform (1):
$$
\begin{array}{l}
k = \frac{V}{\sum_{i}\sum_{j} O_j f(c_{ij})}\\
k = \frac{V}{\frac{O_1}{c_{11}}+\frac{O_1}{c_{21}}+\frac{O_1}{c_{31}}+\frac{O_2}{c_{12}} +... \frac{O_3}{c_{33}}
}\\
k = \frac{790}{568.4} \\
k = 1.389866
\end{array}
$$

**END OF PREVIOUS TEXT**

Calculate the balancing factors/proportionality constants:
```{r}
k_tot <- unc_acc_ij |> 
  summarize(k1 = sum(LU$D_j)/sum(V_unc_ij_1),
            k2 = sum(LU$D_j)/sum(V_unc_ij_2),
            k3 = sum(LU$D_j)/sum(V_unc_ij_3))
```

Use these proportionality constants to calculate the total opportunity constrained accessibility:
```{r}
tot_acc_ij <- unc_acc_ij |>
  mutate(V_tot_ij_1 = k_tot$k1 * V_unc_ij_1,
         V_tot_ij_2 = k_tot$k2 * V_unc_ij_2,
         V_tot_ij_3 = k_tot$k3 * V_unc_ij_3)

tot_acc <- tot_acc_ij |>
  group_by(oid) |>
  summarize(V_tot_i_1 = sum(V_tot_ij_1),
            V_tot_i_2 = sum(V_tot_ij_2),
            V_tot_i_3 = sum(V_tot_ij_3))
  
tot_acc |>
  select(oid, starts_with("V_"))
```

Compare the accessibility differences and between pairs of zone using the two different impedance functions: 
```{r}
tot_acc$V_tot_i_1[2] - tot_acc$V_tot_i_1[1]
tot_acc$V_tot_i_2[2] - tot_acc$V_tot_i_2[1]
tot_acc$V_tot_i_3[2] - tot_acc$V_tot_i_3[1]

tot_acc$V_tot_i_1[2]/tot_acc$V_tot_i_1[1]
tot_acc$V_tot_i_2[2]/tot_acc$V_tot_i_2[1]
tot_acc$V_tot_i_3[2]/tot_acc$V_tot_i_3[1]
```

This illustrates how the differences and ratios are now meaningful.

The total accessibility compared to the number of opportunities:
```{r}
tot_acc <- tot_acc |> 
  left_join(LU |>
              select(-D_j),
            by = c("oid" = "id"))

tot_acc  |>
  summarize(V_tot_1 = sum(V_tot_i_1),
            V_tot_2 = sum(V_tot_i_2),
            V_tot_3 = sum(V_tot_i_3))

LU |>
  summarize(O = sum(D_j))
```

This shows how the number of opportunities is preserved.

And the ratio of accessibility to population compared to the ratio of opportunities to population:
```{r}
# Accessibility divided by population
tot_acc |> 
  mutate(v_tot_1 = V_tot_i_1/O_i,
            v_tot_2 = V_tot_i_2/O_i,
            v_tot_3 = V_tot_i_3/O_i)

# Sum of the accessibility divided by the total population
tot_acc |> 
  summarize(v_tot_1 = sum(V_tot_i_1)/sum(O_i),
            v_tot_2 = sum(V_tot_i_2)/sum(O_i),
            v_tot_3 = sum(V_tot_i_3)/sum(O_i))

# Sum of the opportunities divided by the total population
LU |> 
  summarize(PPR = sum(D_j)/sum(O_i))
```


**PREVIOUS TEXT FOLLOWS: REVISE DISCUSSION**

While we can see that the 'number of potentially reachable opportunities' V results, the total access at a each $i$ or $j$ is not equal to the known known total access ends (because these constraints are not specified and thus not satisfied by the model). This approach is not yet seen in accessibility literature, but could be an intelligible way to compare accessibility values ($V_i$ or $V_j$) without considering the population matrix. 

This case can be reformulated if the spatial weights matrix reflects only weights at the origin $W_i^(1)$ such as population $P_i$ and $W_j^(2)$ is unknown/irrelevant. 

**END OF PREVIOUS TEXT**

## Singly-constrained accessibility: attraction-constrained 

<!--
The singly-constrained case can be either origin-constrained $V_i''^{(1)}$ or destination-constrained $V_i''^{(2)}$. For the origin- and destination- constrained versions, $k$ is replaced with $A_{i}$ and $B_{j}$ respectively (@eq-access enforcing constraint @eq-constraint1-access or @eq-constraint2-access, and implicitly @eq-constraint0-access):

$$
V_{ij}''^{(1)} = A_{i} W_j^{(2)} P_i f(c_{ij})\\
V_{ij}''^{(2)} = B_{j} O_j W_i^{(1)} f(c_{ij})\\
$${#eq-access-singlyconstrained-origin}

\noindent Where $A_{i}$ and $B_{j}$ are the same as the balancing factors of the SIM for the singly-constrained cases:
$$
A_{i} = \frac{1}{\sum_j B_{j} O_j f(c_{ij})}\\
B_{j} = \frac{1}{\sum_i A_{i} P_i f(c_{ij})}\\
$$

\noindent NOTE: if the unknown spatial weight ($W_j^{(2)}$ for $A_{i}$ and $W_i^{(1)}$ for $B_{j}$) is moved from @eq-access-singlyconstrained-origin's numerator to $A_{i}$ or $B_{j}$ it is equivalent to a simplified version of Spatial Availability's formulation which is also demonstrated to be related to @shen1998 and the 2SFCA (see appendix @soukhovIntroducingSpatialAvailability2023). 

In solving the origin-constrained $V_{ij}^{''(1)}$ case (e.g., @eq-constraint1-access of $\sum_j V_{ij} = P_i$ is enforced), $B_{j} = 1$. In solving the destination-constrained $V_{ij}^{''(2)}$ case (e.g., @eq-constraint2-access of $\sum_i V_{ij} = O_j$ is enforced), $A_{i} = 1$. 

Solving for the destination-constrained case $V_{ij}^{''(2)}$ may be helpful in an example where the number of people seeking opportunities is known ($P_i$), along with the number of opportunities $O_j$ offered by a destination as in total accessibility. An example could be the number of people at each residence seeking hospital-beds (origin) and hospital-beds (opportunities) at each healthcare location (destination) to calculate the opportunity access at each origin. Another case could be calculating the opportunity access at each origin using the quantity of goods available to purchase (opportunities) at each commercial location (destination).

From our review, related versions of this defined destination-constrained accessibility are formulaically similar to retail accessibility models e.g., decision model for shops to optimally spatially locate to maximize their potential consumer interaction. Starting with reilly's law of gravitational retail [@reilly1929methods], formalized later in @huffDefiningEstimatingTrading1964 and @lakshmananRetailMarketPotential1965. Other literature also demonstrates  similar _competition_ considerations through its analytical formulation; for instance, in the Intervening Opportunities model [@stoufferInterveningOpportunitiesTheory1940; @stoufferINTERVENINGOPPORTUNITIESCOMPETING1960] "axiomatically" @weibull_axiomatic_1976, and competition consideration expressed as a per population rate particularly in healthcare and job opportunity accessibility analysis [@shen1998], and 2FCA methods in general [@soukhovIntroducingSpatialAvailability2023]. Most of these works do not explicitly focus on balancing accessibility units; rather, they center on _competition_ considerations. We suspect this may be why they have been used in case studies examining access to opportunities that are inherently competitive or where the concept of supply and demand resonates. It was only until the recent work of [@soukhovIntroducingSpatialAvailability2023], where the units of accessibility given competition, e.g., the spatial availability, was introduced with the focus on both competition and balanced units.
-->

**PREVIOUS TEXT FOLLOWS: REVISE DISCUSSION**

Returning to our simple example, the attraction-constrained case would yield the following $B_{j}$ values assuming $A_{i}$ is 1:

$$
B_{j} = \frac{1}{\sum_i P_i f(c_{ij})}\\
$$

$$
\begin{array}{l}
B_{1} =  \frac{1}{160/2+450/15+180/5} = 0.006849315 \\ 
B_{2} =  \frac{1}{160/15+450/2+180/10} = 0.003942181 \\
B_{3} =  \frac{1}{160/5+450/10+180/2} = 0.005988024
\end{array}
$$

**END OF PREVIOUS TEXT**

Balancing factors $B_j$:
```{r}
B_j <- OD |> 
  group_by(did) |>
  summarize(B_j_1 = 1/sum(O_i * f1),
            B_j_2 = 1/sum(O_i * f2),
            B_j_3 = 1/sum(O_i * f3))

B_j
```

Use these proportionality constants to calculate the total opportunity constrained accessibility:
```{r}
opp_acc_ij <- OD |>
  left_join(B_j,
            by = "did") |>
  mutate(V_opp_ij_1 = B_j_1  * O_i * D_j * f1,
         V_opp_ij_2 = B_j_2  * O_i * D_j * f2,
         V_opp_ij_3 = B_j_3  * O_i * D_j * f3)

opp_acc <- opp_acc_ij |>
  group_by(oid) |>
  summarize(V_opp_i_1 = sum(V_opp_ij_1),
            V_opp_i_2 = sum(V_opp_ij_2),
            V_opp_i_3 = sum(V_opp_ij_3))
  
opp_acc  |>
  select(oid, starts_with("V_"))
```

Compare the accessibility differences and between pairs of zone using the two different impedance functions: 
```{r}
opp_acc$V_opp_i_1[2] - opp_acc$V_opp_i_1[1]
opp_acc$V_opp_i_2[2] - opp_acc$V_opp_i_2[1]
opp_acc$V_opp_i_3[2] - opp_acc$V_opp_i_3[1]

opp_acc$V_opp_i_1[2] / opp_acc$V_opp_i_1[1]
opp_acc$V_opp_i_2[2] / opp_acc$V_opp_i_2[1]
opp_acc$V_opp_i_3[2] / opp_acc$V_opp_i_3[1]
```

This illustrates how the differences and ratios are now meaningful.

The total accessibility compared to the number of opportunities:
```{r}
opp_acc <- opp_acc |> 
  left_join(LU |>
              select(-D_j),
            by = c("oid" = "id"))

opp_acc  |>
  summarize(V_opp_1 = sum(V_opp_i_1),
            V_opp_2 = sum(V_opp_i_2),
            V_opp_3 = sum(V_opp_i_3))

LU |>
  summarize(O = sum(D_j))
```

This shows how the number of opportunities is preserved.

And the ratio of accessibility to population compared to the ratio of opportunities to population:
```{r}
# Accessibility divided by population
opp_acc |> 
  mutate(v_opp_1 = V_opp_i_1/O_i,
            v_opp_2 = V_opp_i_2/O_i,
            v_opp_3 = V_opp_i_3/O_i)

# Sum of the accessibility divided by the total population
opp_acc |> 
  summarize(v_opp_1 = sum(V_opp_i_1)/sum(O_i),
            v_opp_2 = sum(V_opp_i_2)/sum(O_i),
            v_opp_3 = sum(V_opp_i_3)/sum(O_i))

# Sum of the opportunities divided by the total population
LU |> 
  summarize(PPR = sum(D_j)/sum(O_i))
```

**PREVIOUS TEXT FOLLOWS: REVISE DISCUSSION**

(NOTE: notably, when $B_j$ is multiplied by $P_i*f(c_{ij})$, it is a proportion (like spatial availability's total population&travel-cost balancing factor) representing how much of $O_j$ is allocated to each $i$)

The $O_j$ values (bottom row) are equal to the known opportunities at each $j$, whereas the $P_i$ values (right-most column) are not. The total accessibility in the region is maintained at 790. Each $V_{ij}$ can be interpreted as $O_j$ weighted by the proportional balancing factor e.g., "the number of opportunities accessible from $j$ by the population at $i$" all weighted by travel cost, of course. Use this formulation of the singly-constrained case when the number of opportunities, at each $j$, that are being competed for by the population is known but the precise number of population that is competiting for opportunities is not. For example, public schools as a destination in a region where all children attend them. All school-seats at $j$ are open to all children at all $i$s. However, not all population $i$ are equally interested in school-seats at all $j$s (e.g., some prefer special programs, teachers, etc.); and we do not know this precise population $i$ to $j$ number. Hence, an opportunity-constrained version of the singly-constrained case is appropriate. 

However, the population-constrained version of the singly-constrained case can be appropriate in the converse situation. Consider the case of public urgent care clinics in a region where all people use them equally. Unlike schools, all population at $i$ are equally interested in urgent-care-seats at all clinics $j$. If there's an emergency, or not, they will visit. However, from an operational perspective all clinics at $j$ are _not_ interested in serving all people (e.g., they'd rather serve people who have access to primary care medicine as they are more likely to seek urgent care in actual medical emergencies). From this perspective, using a _population-constrained_ version of the singly-constrained case $V_i''^{(1)}$, is appropriate. Each $V_{ij}$ can be interpreted as $P_i$ weighted by the proportional balancing factor e.g., "the number of population accessible from $i$ by the opportunities at $j$" all weighted by travel cost, of course. 

**END OF PREVIOUS TEXT**

## Singly-constrained accessibility: production-constrained 

**PREVIOUS TEXT FOLLOWS: REVISE DISCUSSION**

Returning to our simple example, the production-constrained case would yield the following $A_{j}$:

$$
A_{i} = \frac{1}{\sum_j O_j f(c_{ij})}\\
$$

$$
\begin{array}{l}
A_{1} =  \frac{1}{160/2+437/15+193/5} = 0.006768953 \\ 
A_{2} =  \frac{1}{160/15+437/2+193/10} = 0.004024685 \\
A_{3} =  \frac{1}{160/5+437/10+193/2} = 0.005807201
\end{array}
$$

**END OF PREVIOUS TEXT**

Balancing factors $A_i$:
```{r}
A_i <- OD |> 
  group_by(oid) |>
  summarize(A_i_1 = 1/sum(D_j * f1),
            A_i_2 = 1/sum(D_j * f2),
            A_i_3 = 1/sum(D_j * f3))

A_i
```

Use these proportionality constants to calculate the total opportunity constrained accessibility:
```{r}
pop_acc_ij <- OD |>
  left_join(A_i,
            by = "oid") |>
  mutate(V_pop_ij_1 = A_i_1  * O_i * D_j * f1,
         V_pop_ij_2 = A_i_2  * O_i * D_j * f2,
         V_pop_ij_3 = A_i_3  * O_i * D_j * f3)

pop_acc <- pop_acc_ij |>
  group_by(did) |>
  summarize(V_pop_i_1 = sum(V_pop_ij_1),
            V_pop_i_2 = sum(V_pop_ij_2),
            V_pop_i_3 = sum(V_pop_ij_3))
  
pop_acc  |>
  select(did, starts_with("V_"))
```

Compare the accessibility differences and between pairs of zone using the two different impedance functions: 
```{r}
pop_acc$V_pop_i_1[2] - pop_acc$V_pop_i_1[1]
pop_acc$V_pop_i_2[2] - pop_acc$V_pop_i_2[1]
pop_acc$V_pop_i_3[2] - pop_acc$V_pop_i_3[1]

pop_acc$V_pop_i_1[2] / pop_acc$V_pop_i_1[1]
pop_acc$V_pop_i_2[2] / pop_acc$V_pop_i_2[1]
pop_acc$V_pop_i_3[2] / pop_acc$V_pop_i_3[1]
```

This illustrates how the differences and ratios are now meaningful.

The total accessibility compared to the number of opportunities:
```{r}
pop_acc <- pop_acc |> 
  left_join(LU |>
              select(-O_i),
            by = c("did" = "id"))

pop_acc  |>
  summarize(V_pop_1 = sum(V_pop_i_1),
            V_pop_2 = sum(V_pop_i_2),
            V_pop_3 = sum(V_pop_i_3))

LU |>
  summarize(P = sum(O_i))
```

This shows how the population is preserved.

And the ratio of accessibility to population compared to the ratio of opportunities to population:
```{r}
# Accessibility divided by population
pop_acc |> 
  mutate(v_pop_1 = V_pop_i_1/O_i,
            v_pop_2 = V_pop_i_2/O_i,
            v_pop_3 = V_pop_i_3/O_i)

# Sum of the accessibility divided by the total population
pop_acc |> 
  summarize(v_pop_1 = sum(V_pop_i_1)/sum(D_j),
            v_pop_2 = sum(V_pop_i_2)/sum(D_j),
            v_pop_3 = sum(V_pop_i_3)/sum(D_j))

# Sum of the opportunities divided by the total population
LU |> 
  summarize(PPR = sum(O_i))/sum(D_j)
```

**PREVIOUS TEXT FOLLOWS: REVISE DISCUSSION**

In this version of the singly-constrained case, the population is constrained so the $P_i$ values (right-most column) are equal to the known population, whereas the $O_j$ values (bottom row) is not. The total accessibility in the region is maintained at 790. 
To reiterate, each  $V_{ij}$ can be interpreted as  "the number of population accessible from $i$ by the opportunities at $j$" all weighted by travel cost, of course. 

**END OF PREVIOUS TEXT**

## Doubly-constrained case (population-opportunity constrained)
NOTE: The example needs to be revised in this case to have the population and opportunities match, as in, one person-one opportunity

<!--
In this case, $V_{ij}$ would be:
```{r}
#| eval: false

doubly_constrained_gravity_model <- function(
    #CREDIT: I converted the python code from (https://github.com/SadraDaneshvar/Gravity_Model) to R
  O,  # Origin production weights vector
  D,  # Destination attraction weights vector
  impedance_matrix,  # the resulting travel cost impedance matrix
  error_threshold = 0.001,  # Error threshold for stopping condition
  improvement_threshold = 1e-6  # Improvement threshold for stopping condition
) {

  # Normalize O and D
  sum_O <- sum(O)
  sum_D <- sum(D)
  cat("Checking production, attraction balancing:\n")
  cat("Production: ", sum_O, "\n")
  cat("Attraction: ", sum_D, "\n")

  if (sum_O != sum_D) {
    cat("Productions and attractions do not balance, scaling to match.\n")
    if (sum_O < sum_D) {
      O <- O * (sum_D / sum_O)
    } else {
      D <- D * (sum_O / sum_D)
    }
  } else {
    cat("Production, attraction balancing OK.\n")
  }

  n <- length(O)  # Number of i
  T <- sum(O)  # Total trips
  Ai <- rep(1, n)  # Initialize Ai
  Bj <- rep(1, n)  # Initialize Bj

  previous_error <- Inf
  iteration_count <- 0
  stop_reason <- ""

  while (TRUE) {
    iteration_count <- iteration_count + 1

    # Update Ai
    for (i in 1:n) {
      Ai[i] <- 1 / (sum(Bj * D * impedance_matrix[i, ]) + 1e-9)
    }

    # Update Bj
    Bj_new <- rep(1, n)
    for (j in 1:n) {
      Bj_new[j] <- 1 / (sum(Ai * O * impedance_matrix[, j]) + 1e-9)
    }

    # Calculate Tij
    Tij <- outer(Ai * O, Bj_new * D) * impedance_matrix #Tij <- outer(Ai * O, Bj_new * D) * impedance_matrix

    # Print Ai and Bj for this iteration
    cat("\nIteration:", iteration_count, "\n")
    cat("Ai:", round(Ai, 3), "\n")
    cat("Bj:", round(Bj_new, 3), "\n")

    # Calculate error
    error <- (sum(abs(O - rowSums(Tij))) + sum(abs(D - colSums(Tij)))) / T

    # Calculate change in error
    error_change <- abs(previous_error - error)

    # Check stopping conditions
    if (error < error_threshold) {
      stop_reason <- "Error threshold met"
      break
    } else if (error_change < improvement_threshold) {
      stop_reason <- "Slow improvement"
      break
    }

    previous_error <- error
    Bj <- Bj_new
  }

  # report stopping condition and final error threshold
  cat("\nStopping Condition: ", stop_reason, "\n")
  cat(sprintf("Final Error: %.3f%%\n", error * 100))

  return(list(Ai = Ai, Bj = Bj, Tij = Tij))
}

dc_results <- doubly_constrained_gravity_model(O=P_i, D=O_j, impedance_matrix = 1/C)
dc_results$Tij
```

The $A_i$ and $B_j$ matrices:
```{r}
#| eval: false

A_i_doubly <- dc_results$Ai
B_j_doubly <- dc_results$Bj

A_i_doubly |> matrix()
B_j_doubly |> matrix() |> t()
```

The trip matrix (notice, all summed up opportunities and populations are equivalent to our knowns)
```{r}
#| eval: false

V_doubly <- dc_results$Tij

P_i_doubly <- V_doubly |> rowSums()
O_j_doubly <- V_doubly |> colSums()
V_TOTAL_dest <- ifelse(sum(P_i_doubly)==sum(O_j_doubly), sum(V_doubly), NA)
V_doubly_longer <- cbind(V_doubly,P_i_doubly)
V_doubly_longer <- rbind(V_doubly_longer, cbind(t(O_j_doubly),V_TOTAL_dest))

rownames(V_doubly_longer) <- c("1","2","3", "TOTAL") 
colnames(V_doubly_longer) <- c("1","2","3", "TOTAL")

V_doubly_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE)
```

Nice. 
-->

<!--
### Hybrid singly-constrained case: 
NOTE TO SELF: where does E2SFCA and 3SFCA fit?? Maybe here. Maybe BFCA?
Balanced floating catchment areas (not truly doubly constrained)

-->

# Empirical examples

Use the TTS2016R package to illustrate every measure.

# A note on interpretation and possible applications

When to use each of these measures?

# Conclusions

Accessibility development has a rich history. There have been developments in the cases/breath of travel impedance functions, competition considerations, and in incorporating individual choice as part of activity-based accessibility. However, no work yet has examined accessibilities explicit connecting to SIM. We examine this connection, and provide a origin-destination ($i$ to $j$) formulation of accessibility as part of the SIM framework. Novel stuff.

<!--
# APPENDIX (some musings... destined for the commented-out graveyard)

## Singly-constrained case is spatial availability

The destination-constrained case is also spatial availability, see below! As follows then, this case is also related to 2SFCA - if the value is divided by per capita (OR $P_i$ from the numerator in $B_{j}$ is removed).

Spatial availability is formulated like so:
$$
V_{ij}''^{(2)}  = O_j\frac{F^p_{ij} \cdot F^c_{ij}}{\sum_{i=1}^K F^p_{ij} \cdot F^c_{ij}}
$$
It turns out that the denominators of the Population balancing factor $F^p_{ij} = \frac{P_{i\in r}^\alpha}{\sum_{i=1}^K P_{i\in r}^\alpha}$ and Travel cost balancing factor $F^c_{ij} = F^c_{ij} = \frac{f(c_{ij})}{\sum_{i=1}^K f(c_{ij})}$ cancel out, so spatial availability can be expressed as:
$$
V_{ij}''^{(2)} =O_j \frac{ P_i  f(c_{ij})}{\sum_i P_i f(c_{ij})}\\
$$

Reformatted in the general family of accessibility measure form, it looks like:
$$
V_{ij}''^{(2)} =k O_j f(c_{ij})\\
V_{ij}''^{(2)} =\frac{ P_i}{\sum_i P_i f(c_{ij})} O_j f(c_{ij})\\
V_{ij}''^{(2)} =  O_j\frac{F^p_{ij} \cdot F^c_{ij}}{\sum_{i=1}^K F^p_{ij} \cdot F^c_{ij}} = O_j \frac{ P_i  f(c_{ij})}{\sum_i P_i f(c_{ij})}\\
$$

## Checking singly-constrained case against spatial availability
```{r}
#| eval: false

sp_avail <- function(x, o_id, d_id, pop, opp, r, f, alpha = 1){

  o_id <- rlang::enquo(o_id)
  d_id <- rlang::enquo(d_id)
  pop <- rlang::enquo(pop)
  opp <- rlang::enquo(opp)
  r <- rlang::enquo(r)
  f <- rlang::enquo(f)

  sum_pop <- x %>%
    dplyr::distinct(!!o_id,
                    .keep_all = TRUE) %>%
    dplyr::mutate(sum_pop = !!r*(!!pop)^alpha) %>%
    dplyr::pull(sum_pop) %>%
    sum()

  f_p <- dplyr::pull(x, !!r) * dplyr::pull(x, !!pop)^alpha / sum_pop

  sum_impedance <- x %>%
    dplyr::group_by(!!d_id) %>%
    dplyr::summarize(sum_impedance = sum(!!f))

  x <- x %>%
    dplyr::left_join(sum_impedance,
                     by = rlang::as_name(d_id))

  f_c <- dplyr::pull(x, !!f) / x$sum_impedance

  x$f_c <- f_c
  x$f_p <- f_p

  sum_pa <- x %>%
    dplyr::group_by(!!d_id) %>%
    dplyr::summarize(sum_pa= sum(f_p * f_c))

  x <- x %>%
    dplyr::left_join(sum_pa,
                     by = rlang::as_name(d_id))
  f_t <- (f_p * f_c) / dplyr::pull(x, sum_pa)

  dplyr::pull(x, !!opp) * f_t
}
```


```{r}
#| eval: false

df <- data.frame(i = c(1,1,1,2,2,2,3,3,3), 
                 j= c(1,2,3,1,2,3,1,2,3),
                 f = c(1/C[1,], 1/C[2,], 1/C[3,]),
                 pop = c(P_i[1], P_i[1], P_i[1], P_i[2], P_i[2], P_i[2], P_i[3], P_i[3], P_i[3]),
                 opp = c(O_j[1],O_j[2],O_j[3], O_j[1],O_j[2],O_j[3], O_j[1],O_j[2],O_j[3]),
                 catch = c(1,1,1,1,1,1,1,1,1))

calced <- sp_avail(df,
                         o_id = i,
                         d_id = j,
                         pop = pop,
                         opp = opp,
                         r = catch,
                         f = f)
df$V_ij <- calced

df |> group_by(j) |> summarise(V_j = sum(V_ij))
```

## Destination- (or ATTRACTION) constrained is the only singly-constrained case... population- (or PRODUCTION) constrained doesn't make sense!

Then the origin-constrained (singly-constrained) case $V_{ij}^{(1)}$, no $P_i$ values are needed only $O_j$ values. Using this method, V_i values equal P_i values...? while O_j values are unconstrained. This case may be helpful in an example where the number of opportunities available to an origin is known and fixed. This could be a normative minimum threshold, such as 100 opportunities at each origin. 

Returning to our simple example, the origin-constrained singly-constrained case would yield the following $A_{i}$ values:
$$
A_{i} = \frac{O_{j}}{\sum_j O_j f(c_{ij})}\\
A_{1,1} = \frac{O_{j}}{O_1 f(c_{1,1}) + O_2 f(c_{1,2}) + O_3 f(c_{1,3})}\\
...\\
A_{1,1} = 160 *\frac{1}{160/2+437/15+193/5} = 1.083032 \\ 
A_{2,1} = 160 *\frac{1}{160/15+437/2+193/10} =0.6439496 \\
A_{3,1} = 160 * \frac{1}{160/5+437/10+193/2} =0.9291521 \\
...\\
A_{1,2} = 437 *\frac{1}{160/2+437/15+193/5} =2.958032 \\
A_{2,2} = 437 *\frac{1}{160/15+437/2+193/10} =1.7587872 \\
A_{3,2} = 437 * \frac{1}{160/5+437/10+193/2} =2.5377468 \\
...\\
A_{1,3} = 193 *\frac{1}{160/2+437/15+193/5} = 1.306408 \\
A_{2,3} = 193 *\frac{1}{160/15+437/2+193/10} = 0.7767642 \\
A_{3,3} = 193 *\frac{1}{160/5+437/10+193/2} = 1.1207898 \\
$$

```{r}
#| eval: false

A_ij <- matrix(O_j) %*% (1/(t((matrix(O_j))) %*% (1/C))) |> t()
A_ij_longer <- A_ij
rownames(A_ij_longer) <- c("1","2","3") 
colnames(A_ij_longer) <- c("1","2","3") 
A_ij_longer 
```

Starting off with this opportunity matrix, namely - at i=1, only a fixed number of opportunities are accessible to this origin. same for i=2, i=3.
```{r}
#| eval: false

(matrix(rep(O_j, 3), 3, 3))
```

$V_{ij}$ values:
```{r}
#| eval: false

V_orig <- (A_ij) * t(S_non) #S_non -> (1/C)* t(matrix(rep(O_j, 3), 3, 3)) #if you transpose the matrix here, that's another way of generating the answer. 

P_i_orig <- V_orig |> rowSums()
O_j_orig<- V_orig |> colSums()
V_TOTAL_orig <- ifelse(sum(P_i_orig)==sum(O_j_orig), sum(V_orig), NA)
V_orig_longer <- cbind(V_orig,P_i_orig)
V_orig_longer <- rbind(V_orig_longer, cbind(t(O_j_orig),V_TOTAL_orig))

rownames(V_orig_longer) <- c("1","2","3", "TOTAL") 
colnames(V_orig_longer) <- c("1","2","3", "TOTAL")

V_orig_longer #|> as.data.frame()  |> gt(rownames_to_stub=TRUE)
```

-->

# References


<!-- 
## QUESTIONS:
- what does k=1 mean? What does assuming k=1, so the units can be kept mean for the model? Is it meaningless?
- not sure if the singly-constrained (PRODUCTION case) makes sense.. It sort of does..? I believe this needs to be figured out before the doubly constrained case. Pi needs to be integrated somehow. 
- doubly constrained still needs to be solved.


## next steps
- grocery stores for example; maybe 2 grids?
- bibliometric analysis 
- - draft of this end of jan 2025

- (future) intervening opportunities ? radiation model - deep gravity
- (future) accessibility pyramids 
- (future) MAUP addressed
- (future) comparing cities 
-->


<!--NOTE: what about activity-based accessibility? Answer: it is individual utility based, unlike traditional SIM which is origin-destination based. -->


<!-- Despite the theoretical and observed findings that _both_ mobility and accessibility influence an individual’s capacity to travel [@morrisAccessibilityIndicatorsTransport1979], SIM literature that focuses on Hansen's accessibility is relatively scarce in the literature.  -->

<!--the benefits of this formulation, and the inclusion of the propoartionality constant has been imense for spatial interaction modelling. For instance, the identification of the conovlution of spatial autocorrelation and and distance-decay @griffithSpatialStructureSpatial2007 -->

<!-- Wilson in @wilsonSTATISTICALTHEORYSPATIAL1967 was the first to connect accessibility measures to balancing factors-->

<!--
@wilson1971 (pg. 28) summarises the following checklist for spatial interaction model builders:
1. Nature of the spatial interaction variable; 
2. Nature of the mass terms
3. Measurement of mass terms
4. Measurement of interaction cost
5. Choice of cost function
6. Other terms
7. Design of spatial system
8. Calibration
9. Relation to general model framework
-->

<!-- (cool paper that explores this @kirbyNormalizingFactorsGravity1970 - he "shows that the Ai and Bj balancing factors are the mean values of the inverse of the function e^-N*F(c_ij) calculated by summing the function over i values for Ai factors and over j values for Bj factors." -->


<!--TO DISCUSS:
-- should we use entropy maximisation to actually derive the models? I'm hazy on that.
  -- relatedly, in the unconstrained case... is k=1 or does k just not exist..? I assume k=1 and say that the interpretation in reality is confusing. a consistent derivation of all cases can help address this.
  -- constraint 0 or 0.5..? a consistent derivation of all cases should help address this. -->


<!--THE FOLLOWING ARE SOLVED EXAMPLES OF ALL FOUR CASES OF THE SIM -->
<!-- The following are simple numerical examples of each case assuming the following 1) $T_{ij}$ trip ends matrix, 2) $C_{ij}$ travel cost matrix, and 3) an assumed travel impedance function of $f(c_{ij}) = \frac{1}{c_{ij}}$. For all cases, we look to estimate each $T_{ij}$ value using these three inputs, we present the known trip matrix and the trip ends below: -->
<!-- ```{r} -->
<!-- known_trip_matrix <- matrix(c(95,23,42, 27,378,45, 38,36,106), ncol = 3, byrow = TRUE) -->
<!-- #unknowns <- matrix(c(rep(NA,9)), ncol=3, byrow=TRUE) -->
<!-- W_i <- known_trip_matrix |> rowSums() -->
<!-- W_j <- known_trip_matrix |> colSums() -->
<!-- T <- ifelse(sum(W_i)==sum(W_j), sum(W_j),NA) -->
<!-- knowns_longer <- cbind(known_trip_matrix,W_i) -->
<!-- knowns_longer <- rbind(knowns_longer,cbind(t(W_j),T)) -->

<!-- rownames(knowns_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(knowns_longer) <- c("1","2","3", "TOTAL") -->

<!-- knowns_longer #|> as.data.frame() |> round() |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- And the matrix of cost of travel from $i$ (rows) to $j$ (columns) is as follows: -->
<!-- ```{r} -->
<!-- C <- matrix(c(2, 15, 5, 15, 2, 10, 5, 10, 2), ncol = 3, byrow = TRUE) -->
<!-- C_longer <-C -->
<!-- rownames(C_longer) <- c("1","2","3")  -->
<!-- colnames(C_longer) <- c("1","2","3")  -->
<!-- C_longer #|> as.data.frame() |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- For examples of how each type of case is solved, see many of the cited literutre, like @Wilson and @ortuza. -->



<!-- ## Unconstrained interaction case -->

<!-- $k$ can be understood as being set to 1, so the model looks as follows, with no constraints and the trip matrix is as follows. For example, $T_{1,1} = 160*160*\frac{1}{2}$ -->

<!-- $$ -->
<!-- T_{ij} = W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- ```{r} -->
<!-- T_unc <- W_i %*% t(W_j) / C -->

<!-- W_i_unc <- T_unc |> rowSums() -->
<!-- W_j_unc <- T_unc |> colSums() -->
<!-- T_TOTAL_unc <- ifelse(sum(W_i_unc|>round())==sum(W_j_unc|>round()), sum(T_unc), NA) -->
<!-- T_unc_longer <- cbind(T_unc,W_i_unc) -->
<!-- T_unc_longer <- rbind(T_unc_longer, cbind(t(W_j_unc),T_TOTAL_unc)) -->

<!-- rownames(T_unc_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_unc_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_unc_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- As we can surmise, the trip ends do not add up to anything we know -- they do not add up to the known trip ends. Instead, they take on the assumptions of all balancing factors $k$ being equal to 1. When would this happen? It's hard to say... as the balancing factors themselves do not have practical meaning; what has meaning are the constraints. By satisfying the constraints, the model gains meaning. In this way, the resulting unconstrained interaction matrix is simply an expression of the magnitude of interaction of $W_i$ to $W_j$ assuming $f(c_{ij})$. In the context of spatial interaction modelling, this model is not entirely useful; it is in units of 'trips' but trips that satisify the macro constraint of $k$ equaling 1, which is practically meaningless.   -->

<!-- ## Total constrained interaction case -->

<!-- In the total constrained case, $k$ is replaced with $K$ (@eq-bf-K-gravitymodel satisfying only constraint @eq-constraint0-gravitymodel) so the model looks as follows: -->
<!-- $$ -->
<!-- T_{ij}' = K W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- \where Solved for our example, $K$ is equal to the total number of known trips divided by the sum of all the unconstrained trips made: -->
<!-- $$ -->
<!-- K = \frac{T}{\sum_{i}\sum_{j} W_i^{(1)} W_j^{(2)} f(c_{ij})}\\ -->
<!-- K = \frac{T}{\frac{W_1^{(1)}W_1^{(2)}}{c_{1,1}}+\frac{W_2^{(1)}W_1^{(2)}}{c_{2,1}}+\frac{W_3^{(1)}W_1^{(2)}}{c_{3,1}}+\frac{W_1^{(1)}W_2^{(2)}}{c_{1,2}} +... \frac{W_3^{(1)}W_3^{(2)}}{c_{3,3}} -->
<!-- }\\ -->
<!-- K = \frac{790}{166443} \\ -->
<!-- K = 0.00474636 -->
<!-- $$ -->

<!-- ```{r} -->
<!-- K <- T/sum(sum(T_unc)) -->
<!-- T_tot <- K * T_unc -->

<!-- W_i_tot <- T_tot |> rowSums() -->
<!-- W_j_tot <- T_tot |> colSums() -->
<!-- T_TOTAL_tot <- ifelse(sum(W_i_tot|>round())==sum(W_j_tot|>round()), sum(T_tot), NA) -->
<!-- T_tot_longer <- cbind(T_tot,W_i_tot) -->
<!-- T_tot_longer <- rbind(T_tot_longer, cbind(t(W_j_tot),T_TOTAL_tot)) -->

<!-- rownames(T_tot_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_tot_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_tot_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->
<!-- While we can see that the total trips `r T` results, the total trip ends are not equal to the known trip ends as these constraints are not specified and thus not satisfied by the model. -->

<!-- ## Singly-constrained -->

<!-- Two versions of this case, either origin-constrained or destination-constrained.  -->

<!-- For the origin-constrained model, where $k$ is replaced with $A_i$ (@eq-bf-A-gravitymodel satisfying only constraint @eq-constraint1-gravitymodel and implicitly @eq-constraint0-gravitymodel), the model looks as follows: -->
<!-- $$ -->
<!-- T_{ij}^{''(1)} = A_i W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- \where In our example, $A_i$ is: -->
<!-- $$ -->
<!-- A_i = \frac{1}{\sum_j W_j^{(2)} f(c_{ij})}\\ -->
<!-- A_1 = \frac{1}{W_1^{(2)} f(c_{1,1}) + W_2^{(2)} f(c_{1,2}) + W_3^{(2)} f(c_{1,3})}\\ -->
<!-- ...\\ -->
<!-- A_1 = \frac{1}{160/2+437/15+193/5} =0.006768953 \\ -->
<!-- A_2 = \frac{1}{160/15+437/2+193/10} =0.004024685 \\ -->
<!-- A_3 = \frac{1}{160/5+437/10+193/2} =0.005807201  -->
<!-- $$ -->

<!-- ```{r} -->
<!-- A_i <- 1/t((matrix(W_j))) %*% (1/C) -->
<!-- #A_i <- rowSums(known_trip_matrix)/rowSums(T_unc) #our answer with knowns -->
<!-- A_i<- diag(A_i|> as.numeric(), nrow=3, ncol=3) -->

<!-- T_orig <-  A_i%*%T_unc -->

<!-- W_i_orig <- T_orig |> rowSums() -->
<!-- W_j_orig <- T_orig |> colSums() -->
<!-- T_TOTAL_orig <- ifelse(sum(W_i_orig)==sum(W_j_orig), sum(T_orig), NA) -->
<!-- T_orig_longer <- cbind(T_orig,W_i_orig) -->
<!-- T_orig_longer <- rbind(T_orig_longer, cbind(t(W_j_orig),T_TOTAL_orig)) -->

<!-- rownames(T_orig_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_orig_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_orig_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- We can see that the $W_i^{(1)}$ values are equal to the trip ends, but not $W_j^{(2)}$ values.  -->

<!-- Similarly, the singly-constrained case can be flipped to be origin-constrained (@eq-bf-B-gravitymodel satisfying only constraint @eq-constraint1-gravitymodel and implicitly @eq-constraint0-gravitymodel): -->
<!-- $$ -->
<!-- T_{ij}^{''(2)} = B_j W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- \where $B_j$ is, and equal to: -->
<!-- $$ -->
<!-- B_j = \frac{1}{\sum_i W_i^{(1)} f(c_{ij})}\\ -->
<!-- $$ -->
<!-- ```{r} -->
<!-- B_j <- 1/(t(matrix(W_i))) %*% (1/C)  -->

<!-- B_j <- matrix(B_j) |> t() -->
<!-- B_j_longer <- B_j -->
<!-- colnames(B_j_longer) <- c("1","2","3") -->
<!-- B_j_longer  #|> as.data.frame()  |> gt() -->
<!-- #B_j <- colSums(known_trip_matrix)/colSums(T_unc) #our answer with knowns -->
<!-- ``` -->

<!-- And trips are: -->
<!-- ```{r} -->
<!-- B_j <- diag(B_j|> as.numeric(), nrow=3, ncol=3) -->

<!-- T_dest <-  (B_j)%*%t(T_unc) |> t() -->

<!-- W_i_dest <- T_dest |> rowSums() -->
<!-- W_j_dest <- T_dest |> colSums() -->
<!-- T_TOTAL_dest <- ifelse(sum(W_i_dest)==sum(W_j_dest), sum(T_dest), NA) -->
<!-- T_dest_longer <- cbind(T_dest,W_i_dest) -->
<!-- T_dest_longer <- rbind(T_dest_longer, cbind(t(W_j_dest),T_TOTAL_dest)) -->

<!-- rownames(T_dest_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_dest_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_dest_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- And as we can observe, the $W_j^{(2)}$ values are equal to the known trip ends, while $W_i^{(1)}$ is not. -->

<!-- ## Doubly-constrained case -->

<!-- The parameter $k$ is replaced with both $A_i$ and $B_j$ (@eq-bf-A-gravitymodel and @eq-bf-B-gravitymodel satisfying all three constraints @eq-constraint1-gravitymodel,  @eq-constraint2-gravitymodel and implicitly @eq-constraint0-gravitymodel), the model looks as follows: -->
<!-- $$ -->
<!-- T_{ij}^{'''} = A_i B_j W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- \where In our example, $A_i$ and $B_j$ is: -->
<!-- $$ -->
<!-- A_i = \frac{1}{\sum_j B_j W_j^{(2)} f(c_{ij})}\\ -->
<!-- B_j = \frac{1}{\sum_i A_i W_i^{(1)} f(c_{ij})} -->
<!-- $$ -->
<!-- ```{r} -->
<!-- doubly_constrained_gravity_model <- function( -->
<!--     #CREDIT: I converted the python code from (https://github.com/SadraDaneshvar/Gravity_Model) to R -->
<!--   O,  # Origin production weights vector -->
<!--   D,  # Destination attraction weights vector -->
<!--   impedance_matrix,  # the resulting travel cost impedance matrix -->
<!--   error_threshold = 0.001,  # Error threshold for stopping condition -->
<!--   improvement_threshold = 1e-6  # Improvement threshold for stopping condition -->
<!-- ) { -->

<!--   # Normalize O and D -->
<!--   sum_O <- sum(O) -->
<!--   sum_D <- sum(D) -->
<!--   cat("Checking production, attraction balancing:\n") -->
<!--   cat("Production: ", sum_O, "\n") -->
<!--   cat("Attraction: ", sum_D, "\n") -->

<!--   if (sum_O != sum_D) { -->
<!--     cat("Productions and attractions do not balance, scaling to match.\n") -->
<!--     if (sum_O < sum_D) { -->
<!--       O <- O * (sum_D / sum_O) -->
<!--     } else { -->
<!--       D <- D * (sum_O / sum_D) -->
<!--     } -->
<!--   } else { -->
<!--     cat("Production, attraction balancing OK.\n") -->
<!--   } -->

<!--   n <- length(O)  # Number of i -->
<!--   T <- sum(O)  # Total trips -->
<!--   Ai <- rep(1, n)  # Initialize Ai -->
<!--   Bj <- rep(1, n)  # Initialize Bj -->

<!--   previous_error <- Inf -->
<!--   iteration_count <- 0 -->
<!--   stop_reason <- "" -->

<!--   while (TRUE) { -->
<!--     iteration_count <- iteration_count + 1 -->

<!--     # Update Ai -->
<!--     for (i in 1:n) { -->
<!--       Ai[i] <- 1 / (sum(Bj * D * impedance_matrix[i, ]) + 1e-9) -->
<!--     } -->

<!--     # Update Bj -->
<!--     Bj_new <- rep(1, n) -->
<!--     for (j in 1:n) { -->
<!--       Bj_new[j] <- 1 / (sum(Ai * O * impedance_matrix[, j]) + 1e-9) -->
<!--     } -->

<!--     # Calculate Tij -->
<!--     Tij <- outer(Ai * O, Bj_new * D) * impedance_matrix -->

<!--     # Print Ai and Bj for this iteration -->
<!--     cat("\nIteration:", iteration_count, "\n") -->
<!--     cat("Ai:", round(Ai, 3), "\n") -->
<!--     cat("Bj:", round(Bj_new, 3), "\n") -->

<!--     # Calculate error -->
<!--     error <- (sum(abs(O - rowSums(Tij))) + sum(abs(D - colSums(Tij)))) / T -->

<!--     # Calculate change in error -->
<!--     error_change <- abs(previous_error - error) -->

<!--     # Check stopping conditions -->
<!--     if (error < error_threshold) { -->
<!--       stop_reason <- "Error threshold met" -->
<!--       break -->
<!--     } else if (error_change < improvement_threshold) { -->
<!--       stop_reason <- "Slow improvement" -->
<!--       break -->
<!--     } -->

<!--     previous_error <- error -->
<!--     Bj <- Bj_new -->
<!--   } -->

<!--   # report stopping condition and final error threshold -->
<!--   cat("\nStopping Condition: ", stop_reason, "\n") -->
<!--   cat(sprintf("Final Error: %.3f%%\n", error * 100)) -->

<!--   return(list(Ai = Ai, Bj = Bj, Tij = Tij)) -->
<!-- } -->

<!-- dc_results <- doubly_constrained_gravity_model(O=W_i, D=W_j, impedance_matrix = 1/C) -->
<!-- ``` -->

<!-- The $A_i$ and $B_j$ matrices: -->
<!-- ```{r} -->
<!-- A_i_doubly <- dc_results$Ai -->
<!-- B_j_doubly <- dc_results$Bj -->

<!-- A_i_doubly |> matrix() -->
<!-- B_j_doubly |> matrix() |> t() -->
<!-- ``` -->

<!-- The trip matrix (notice, all trip ends are equivalent to the known trip ends) -->
<!-- ```{r} -->
<!-- T_doubly <- dc_results$Tij -->

<!-- W_i_doubly <- T_doubly |> rowSums() -->
<!-- W_j_doubly <- T_doubly |> colSums() -->
<!-- T_TOTAL_dest <- ifelse(sum(W_i_doubly)==sum(W_j_doubly), sum(T_doubly), NA) -->
<!-- T_doubly_longer <- cbind(T_doubly,W_i_dest) -->
<!-- T_doubly_longer <- rbind(T_doubly_longer, cbind(t(W_j_doubly),T_TOTAL_dest)) -->

<!-- rownames(T_doubly_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_doubly_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_doubly_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->


<!-- ## Mean absolute percentage error (MAPE) between all cases -->

<!-- ```{r} -->
<!-- #unconstrained -->
<!-- ((sum(abs(W_i_unc - rowSums(known_trip_matrix))) + sum(abs(W_j_unc - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->

<!-- #unconstrained -- rescaled! -->
<!-- W_i_unc_rescaled <- T_unc |> scales::rescale() |> rowSums() -->
<!-- W_j_unc_rescaled <- T_unc |> scales::rescale() |> colSums() -->

<!-- W_i_rescaled <- known_trip_matrix |> scales::rescale() |> rowSums() -->
<!-- W_j_rescaled <- known_trip_matrix |> scales::rescale() |> colSums() -->

<!-- ((sum(abs(W_i_unc_rescaled - W_i_rescaled)) + sum(abs(W_j_unc_rescaled - W_j_rescaled))) / T) |> scales::percent(0.01) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- #total constrained -->
<!-- ((sum(abs(W_i_tot - rowSums(known_trip_matrix))) + sum(abs(W_j_tot - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->

<!-- #singly-constrained (orig) -->
<!-- ((sum(abs(W_i_orig - rowSums(known_trip_matrix))) + sum(abs(W_j_orig - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->

<!-- #singly-constrained (dest) -->
<!-- ((sum(abs(W_i_dest - rowSums(known_trip_matrix))) + sum(abs(W_j_dest - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->

<!-- #doubly-constrained (dest) -->
<!-- ((sum(abs(W_i_doubly - rowSums(known_trip_matrix))) + sum(abs(W_j_doubly - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->
<!-- ``` -->

<!-- - doubly c is lowest error -->
<!-- - singly constrained error is mid -->
<!-- - total constrained has high error -->
<!-- - notably, unconstrained unscaled is obviously much higher in error - there are no constraints! But if you scale the matrices, the error is both low (interesting!! why is this?). However as mentioned, the unconstrained case is hard to interpret literally -- in what situations would k=1..?  -->


<!-- So... our dear Mac alumni Fotheringham, in the early 1980s as a fresh PhD graduate demonstrates that the gravity model is misspecified. Responding to other authors at the time saying there is a 'map pattern' left over in estimated gravity models -- he demonstrated that this residual spatial variation can be reduced by including an additional independent variable into the gravity model, accessibility at the destination! This is the 'competing destination' model. In transport modelling, the CD model is one of a few ways they address this spatial In the wake of the debate, four generalizable approaches were proposed to account for the spatial structure effect (others include: the Box–Cox transform, spatial econometric models, and eigenvector spatial filtering (ESF)). Failing to account for destination accessibility when spatial structure effects are present generally biases origin-specific distance-decay parameter estimates upwards for accessible origins and downward for inaccessible origin. The strength of this bias is shown by Fotheringham (1984) to depend on the strength of two relationships: that between the volume of flows and destination accessibility and that between destination accessibility and distance from the origin to each destination. It is this bias that causes the unintuitive spatial patterns observed in origin-specific distance-decay parameter estimates, such as positive estimates for the most accessible origins (Fotheringham, 1981) -->

<!-- So Aij is a relevant explanatory variable that can increase the accuracy of a Tij model! There's a relationship there. It makes me wonder if those spatial effects would be there if you used a constrained accessibility measure. Maybe using Aij (Hansen-type accessibility) doesn't completely solve this issue. -->

