---
title: "A family of accessibility measures (bringing balance back?)"
format: pdf
bibliography: "`r system('kpsewhich ../bibliography/bibliography.bib', intern=TRUE)`"
---

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r load-packages, include=FALSE, cache=FALSE}
library(dplyr) # A Grammar of Data Manipulation
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(flextable)
library(knitr)
library(glue)
library(here)
# library(huxtable) # Easily Create and Style Tables for LaTeX, HTML and Other Formats
# library(kableExtra) # Construct Complex Table with 'kable' and Pipe Syntax
# library(patchwork) # The Composer of Plots
# library(RColorBrewer) # ColorBrewer Palettes
# library(sf) # Simple Features for R
# library(scales) # Scale Functions for Visualization
# library(shadowtext) # Shadow Text Grob and Layer
# library(skimr) # Compact and Flexible Summaries of Data
# library(spdep) # Spatial Dependence: Weighting Schemes, Statistics
# library(tidyr) # Tidy Messy Data
# library(tmap) # Thematic Maps
# library(ggpmisc) # Miscellaneous Extensions to 'ggplot2'
# library(ggrepel) # Automatically Position Non-Overlapping Text Labels with 'ggplot2'
# library(ggspatial) # Spatial Data Framework for ggplot2
# library(gridExtra) # Miscellaneous Functions for "Grid" Graphics 
# library(here)
```

# Introduction

<!-- SUMMARY: Accessibility is related to mobility, however, institutionalized mobility-based transportation planning practice has treated accessibility as it's proxy. This has had problematic consequences. Conceptually, accessibility is a more complete and comprehensive evolution of mobility. As such, there has been recognition that the adoption of accessibility planning approaches are needed; however there are 1) too many definitions and 2) uncertainty in meaning of the outputs--> 
Accessibility, a central concept in transport geography, planning, and engineering, is conceptually related to human mobility and the opportunity landscape. In simple terms, it is defined as the "potential of opportunities for interaction" [@hansen1959]. The range of opportunities considered in accessibility analysis has grown to include <!-- --> employment [REFS], health care [REFS], green spaces [REFS], schools [REFS], social contacts [REFS], emergency services [e.g., shelters, REFS], and many more. In other words, accessibility analysis is today used to understand the potential to reach opportunities that are important to people [@ferreiraReenactingMobilityAccessibility2020]. Compared to earlier measures of performance used in transportation (e.g., VKT, PKT, etc.) that benchmark the amount of movement, accessibility brings a more holistic understanding of transportation and land use systems combined [@handyMeasuringAccessibilityExploration1997]. However, the focus of transportation planning has historically prioritized mobility and treated accessibility as a by-product of movement, leading to problematic consequences [@handy2020]. With the rise of an automobility mono-culture [@miller_collaborative_2011; @lavery_driving_2013], recent decades of mobility-based practice (e.g., road and highway expansion) have been marked by increased travel cost (time, effort, energy, financial cost), often with limited impact on accessibility levels [e.g., @handyACCESSIBILITYVSMOBILITYENHANCING2002; @paez_healthcare_2010]. In response, transportation planning practice has begin to adopt accessibility planning approaches, via accessibility planning tools [@silvaAccessibilityInstrumentsPlanning2017; @paez_developing_2013] or through the traditional four-step transportation demand model [@ortuzar_2011_modelling]. However, institutional and conceptual barriers remain, many of which relate to the diversity of accessibility definitions [@handy2020] and interpretability and communicability of the outputs [@geursAccessibilityEvaluationLanduse2004; @ferreiraReenactingMobilityAccessibility2020].

<!-- Considering population-level methods in transportation and city planning research, accessibility measures have been used to tackle a wide variety of research questions. They have taken on numerous definitions and analytical expressions; from simpler cumulative opportunities measures, to measures considering more complex travel behaviour and trip weighting characteristics, measures of _potential of opportunities for interaction_ are varied. Summarizing these definitions across studies have been challenging; a testament to these unsettled classifications are present in influential accessibility review literature [@handyMeasuringAccessibilityExploration1997; @geursAccessibilityEvaluationLanduse2004; @wuUnifyingAccess2020; @millerAccessibilityMeasurementApplication2018]. -->

<!-- PAPER'S AIM: improve interpretation of accessibility measure outputs. We do this by, 1) assuming accessibility is more complete understanding of mobiltiy, and connected them both mobility and accessibility are both based in the Netownian gravitational anology, lets introduce balancing factors like those  Gravity Model.   -->
In adopting the perspective that accessibility is an evolution of mobility conceptually, this paper aims to re-unify accessibility measures with its spatial interaction-based roots. It proposes to do so by mapping accessibility onto Wilson's family of spatial interactions models [@wilson1971]. In this, we aim not only to clarify accessibility's interpretation as a measure of performance, but also to encourage future developments that draw from its gravity modelling siblings, and spatial interaction history. To this end, we begin by tracing the development of spatial interaction from @ravensteinLawsMigration1889 to its split into accessibility research from @hansen1959 to today. After this, we derive different types of accessibility measures, following the family of gravity models namely: unconstrained, total constrained, origin- and destination- constrained, composite destination-constrained, and doubly constrained. Then, we will provide empirical examples of the types of measures. Finally, we will discuss the use of each measure and broadly the implications of ignoring the role of constrains in accessibility analysis.

# Background

## The inquiry into spatial interaction traces to Newton's Universal Gravitation
<!--SUMMARY: Overview of the proportionality constant in Newton Law of Universal Gravitation - it takes the proportion relationship into one of equality. -->
The patterns of people's movement in space have been a subject of scientific inquiry for centuries. From as far back as Henry C. Carey's _Principles of Social Science_ [@careyPrinciplesSocialScience1858] there was already a concern with the scientific study of human interaction over space. It is in this work where Carey states that "man [is] the molecule of society [and their interaction is subject to] the direct ratio of the mass and the inverse one of distance" [@mckeanManual1883, pp. 37-38], which shows how investigations into human spatial interaction have often been explicitly coloured by the features of Newton's Law of Universal Gravitation [posited in _Principia Mathematica_ of 1687 and expressed in @eq-phys-grav-prop].

$$
F_{ij} \propto \frac{M_i M_j} {D_{ij}^{2}}
$${#eq-phys-grav-prop}

To be certain, the expression above, a proportionality, is one of the most famous in all of science. In brief, it states that the force of attraction $F$ between a pair of bodies $i$ and $j$ is directly _proportional_ to the product of their masses $M_i$ and $M_j$, and inversely _proportional_ to the square of the distance between them $D_{ij}$. Direct proportionality only means that as the product of the masses increases, so does the force. Likewise, inverse proportionality only means that as the distance increases, the force decreases. To quantify the magnitude of the force, an empirical factor, say $G$, is required to convert the proportionality into an equality, which ensures that the force $F$ matches empirical observations of the force of attraction between masses. Ultimately, the equation for the force is as seen in @eq-phys-grav, where $G$ is a proportionality constant obtained empirically:

$$
F_{ij} = G \frac{M_i M_j} {D_{ij}^{2}}
$${#eq-phys-grav}

Newton's initial estimate of $G$ was based on a speculation that the mean density of earth was between five or six times that of water, an assumption that Hutton's experiments of 1778 validated [@hutton_xxxiii_1778, p. 783]. Still, it took over a century from the publication of _Principia_ to refine the estimate of this constant to within 1\% accuracy, with Cavendish's 1798 experiment [@cavendish_xxi_1798].

## Early research on human spatial interaction: from Ravenstein (1889) to Stewart (1948)

<!-- SUMMARY: a review of spatial interaction literature from the 1880s to the 1940s. These researchers have theoretically and empirically attempted to characterise human spatial interaction as some force of attraction $F$ that is directly proportion to the masses $Mi$ and $Mj$ and inversely proportional by their separation distance. This concept was captured with different expressions, but all tie back to the same Newtonian gravity analogy. -->
Following Carey's _Principles_ of 1858, research into human spatial interaction continued in different contexts. In the late 1880s Ravenstein proposed his "Laws of Migration", based on his empirical analysis of migration flows in various countries [@ravensteinLawsMigration1885; @ravensteinLawsMigration1889]. In these works, Ravenstein posited a directly proportional relationship of migration flows with the size of the destination (i.e., centres of commerce and industry), and an inversely proportional relationship between the size of flows and separation between origin and destination. These propositions are similar to Newton's gravitational laws. Over time, other researchers discovered similar relationships. <!--Rilley does not cite Newton, nor Carey, nor Ravenstein, but I removed this curiosity as it's not central to our point here--> For example, @reilly1929methods formulated a law of retail gravitation, expressed in terms of equal attraction to competing retail destinations. Later, Zipf proposed a $\frac{P_1P_2}{D}$ hypothesis for the case of goods movement by railways @zipfHypothesisCaseRailway1946, intercity personal movement @zipfHypothesisIntercityMovement1946,and information @zipfDeterminantsCirculationInformation1946. The $\frac{P_1P_2}{D}$ hypothesis stated that the magnitude of flows was proportional to the product of the populations of settlements, and inversely proportional to the distance between them. 

A common theme among these early researchers of human spatial interaction is that a proportionality constant similar to $G$ in @eq-phys-grav is missing. Of the researchers cited, only Reilly and Zipf expressed their hypotheses in mathematical terms. Reilly's hypothesis was expressed as follows:
$$
B_a = \frac{(P_a\cdot P_T)^N}{D_{aT}^n}
$${#eq-reilly}

\noindent Where $B_a$ is the amount of business drawn to $a$ from $T$, $P_a$ and $P_T$ are the populations of the two settlements, and $D_{aT}$ is the distance between them. Quantity $N$ was chosen by Reilly in a somewhat _ad hoc_ fashion as 1, and he used empirical observations of shoppers to choose a value of $n = 2$. 

Zipf, on the other hand, wrote his hypothesis in mathematical form as:
$$
C^2 = \frac{P_1\cdot P_2}{D}
$${#eq-zipf}

\noindent Where $C$ is the volume of goods exchanged between $1$ and $2$, $P_1$ and $P_2$ are the populations of the two settlements, and  $D_{12}$ is the distance between them.

After Carey, it is in Stewart's work on the principles of demographic gravitation that we find the strongest connection yet to Newton's law [@stewartDemographicGravitationEvidence1948]. We suspect that this may relate to academic backgrounds; Stewart was a physicist, whereas Ravenstein, Reilly, and Zipf were social scientists. Besides awareness of preceding research, as he cites Reilly and Zipf as predecessors in the analysis of human spatial interaction, Stewart appears to have been the first author to express his theorized relationships for human spatial interaction with a proportionality constant $G$, as follows:
$$
F = G\frac{(N_1\mu_1)(N_2\mu_2)}{d_{12}^2}
$${#eq-stewart-force}

\noindent where:

- $F$ is the _demographic force_
- $N_1$ and $N_2$ are the numbers of people of in groups 1 and 2
- $\mu_1$ and $\mu_2$ are so-called _molecular weights_
- $d_{12}^2$ is the distance between $1$ and $2$
- And finally $G$, a constant that Stewart "left for future determination" [-@stewartDemographicGravitationEvidence1948, p. 34]

In addition to demographic force, Stewart defined a measure of "population potential" of $2$ with respect to $1$ as follows:
$$
V_1 = G\frac{M_2}{d}
$${#eq-stewart-population-potential}

For a system with more than 2 population bodies, Stewart formulated the population potential at $i$ as:
$$
V_i = \int\frac{D}{r} ds
$${#eq-stewart-population-potential-integral}

\noindent where $D$ is population density over an infinitesimal area $ds$, and $r$ is the distance to $i$. In more contemporary terms, this can be rewritten as:
$$
V_i = \sum_j \frac{M_j}{d_{ij}}
$${#eq-stewart-population-potential-sum}

\noindent which astute readers will identify as our modern definition of accessibility.

Stewart's formulation of demographic force, developed in the context of what he called "social physics" [@stewartPrinciples1947], was problematic. It had issues with inconsistent mathematical notation. For example, e.g., in @stewartDemographicGravitationEvidence1948, $G$ is used as a proportionality constant for both _demographic force_ and  _demographic energy_ on p. 34. Perhaps more seriously, Stewart's work was permeated by a view of humans as particles following physical laws, but with ideas that were afflicted by unscientific racism. For instance, the molecular weight $\mu$ was presumed to be one for the average American, but "presumably...much less than one....for an Australian aborigine" [p. 35]. Stewart's ideas about "social physics" fell out of favour among social scientists, but not before influencing the emerging field of accessibility research.

In summary: from the 1850s to the 1940s, researchers attempted to theoretically and empirically characterise human spatial interaction as some force of attraction $F$ that is directly proportion to the masses $M$ of a pair of locations ($i$ and $j$) and inversely proportional by some sort of separation distance $D_{ij}$. Those that captured the relationship empirically, approached the concept with different expressions, some including a proportionality constant and some not, but all tying back to the Newtonian gravity analogy. 

## Hansen's gravity-based accessibility to today
<!-- SUMMARY: Stewart 1948 made an important contribution methodologically: Hansen picked it up. Is now cited as the father of accessibility. However, Hansen work was applied, and he's use of Stewart's Population Potential measure included two crucial omissions that afflict the literature to this day. The first omission is 1) Stewart set the proportional constant $G$ to 1 _for future determination_, this constant is not explicitly addressed in @hansen1959 and accessibility continues to evolve without it. The second omission is 2) Stewart suggests that keeping the exponent value of $d_ij$ as 1 is sufficient. In @hansen1959, an exponent other than 1 for $d_ij$ is selected based on empirical findings, however, the issue of _opportunity potential_ units are never addressed. -->

From @stewartDemographicGravitationEvidence1948, we arrive to 1959 and Walter G. Hansen, whose work proved to be exceptionally influential in the accessibility literature [@hansen1959]. In his seminal paper, Hansen defined accessibility, i.e., "the potential of opportunities for interaction" [p.73], as "a generalization of the population-over-distance relationship or 'population potential' concept developed by Stewart [@stewartDemographicGravitationEvidence1948]" [p.73]. As well as being a student of city and regional planning at Massachusetts Institute of Technology, Hansen was also an engineer with the the Bureau of Roads, and likely preoccupied with applied research into the power of transportation to shape land uses. @hansen1959 focused on @stewartDemographicGravitationEvidence1948's _population potential_ (expressed in @eq-stewart-population-potential-sum), leaving Stewart's other formulaic contributions and objectionable aspects of "social physics" behind. @hansen1959 recast @eq-stewart-population-potential-sum to reflect accessibility, a model of human behaviour useful to capture regularities in mobility patterns . In this equation, @hansen1959 replaced $M_j$ with _opportunities_ to derive an _opportunity potential_, or more accurately, a _potential of opportunities for interaction_ as follows:
$$
S_{i} = \sum_j O_j \cdot d_{ij}^\beta \\
$${#eq-accessibility}

Alternatively, a more general form of this expression to account for different impedance functions:
$$
S_{i} = \sum_j O_j \cdot f(d_{ij})
$${#eq-accessibility-general}

$S_{i}$ in @eq-accessibility is a measure of the accessibility at $i$, whereas $O_j$ is the size of the activity at $j$ and $d_{ij}$ is the distance or travel time between $i$ and $j$ with $\beta$ describing the effect size. Today, Hansen is is frequently cited as the father of modern accessibility analysis [e.g., @reggianiGuestEditorialNew2011], and Hansen-type accessibility is commonly referred to today as the gravity-based accessibility measure.

Of note, however is that between @stewartDemographicGravitationEvidence1948 and @hansen1959 the proportionality constant $G$ in @eq-stewart-population-potential vanished. There is some evidence that @hansen1959 was aware of the importance of this constant as he wrote about _direct_ and _inversely proportional_ relationships between opportunities in one area, opportunities at another, and their separation distance. Furthermore, those reading @hansen1959 should remember that @stewartDemographicGravitationEvidence1948 set the proportionality constant $G$ to 1, with a note that"$G$ [was] left for future determination: a suitable choice of other units can reduce it to unity". 


Since @hansen1959, accessibility analysis has been widely employed across planning disciplines [@koenigIndicatorsUrbanAccessibility1980; @geursAccessibilityEvaluationLanduse2004; @millerAccessibilityMeasurementApplication2018; @wuUnifyingAccess2020]. However, to our knowledge, the proportionality constant has remained forgotten, with no notable developments to explicitly determining it. In this way, $G$ continues to be implicitly set to $1$ even when the fundamental relationship in accessibility is proportionality (e.g., $ S_{i}  \propto G \sum_j O_j \cdot f(d_{ij})$ and not equality [for instance, see the formula for accessibility at the top of Figure 1 in @wuUnifyingAccess2020]. Without a proportionality constant, however, the units of $S_i$ remain unclear: the unit of 'potential of opportunity for interaction' is left free to change as $\beta$ is calibrated for the population center with no discussion of a constant to balance the units.

However, it has been raised that there is a difficulty in interpreting gravity-based accessibility's meaning as anything other than a relative index of potential interaction (higher accessibility/lower accessibility) [@millerAccessibilityMeasurementApplication2018]. Interpretability issues plague this type of analysis, as implications beyond high-or-low access hotspots are often desired. What does the accessibility value mean? Difficultly in interpreting the output's tangible meaning contributes to resistance to its application in practice [@ferreiraReenactingMobilityAccessibility2020]. Furthermore, The majority of accessibility studies within the past few decades develop on the breath and geographic case study selection of the opportunity $O_j$ studied and potentially impacted population []; the accuracy of parameters that capture distance-decay $f(c_{ij})$ []; and additions to the opportunity $O_j$ attributes such as competitive demand considerations [@stoufferINTERVENINGOPPORTUNITIESCOMPETING1960; @weibull_axiomatic_1976; @shen1998; @allenMeasureCompetitiveAccess2020; @soukhovMultimodalSpatialAvailability2024]. Overall, due to the diverse range of questions accessibility measures have been applied to help clarify, a plethora of variations in @eq-accessibility-general are present in the literature. These variations also compounds the issue of interpretability across studies. 

A testament to this inconsistent interpretation are the unsettled classifications generated by influential review works of the accessibility literature; for instance, @handyMeasuringAccessibilityExploration1997 classifies studies into gravity- and utility-based measures, @geursAccessibilityEvaluationLanduse2004 introduces further classification by expanding categories into potential- (or gravity), utility-, location-, and person- based measures with different components. @curtis2010planning further classifies accessibility measures into spatial separation, contour-, gravity-, competition-, time-space, utility-, and network- based measures [@curtis2010planning], though methodologies may clearly overlap. Broader approaches have also been taken: @paez2012measuring categories indicators on how they have been normatively and positively applied, and @levineCenturyEvolutionAccessibility2020 reviews accessibility's evolution along definition-based and application-based dimensions throughout the years.

Among these reviews, we find @wuUnifyingAccess2020's contribution compelling for unifying accessibility measures: they demonstrate that most or all of these concepts can be unified into its main features: the relationship between travel-cost and corresponding reachable opportunities. Indeed, these authors demonstrate how previous classifications are special cases of travel-cost or opportunities constraints. From the initial Newtonian analogy, we interpret @wuUnifyingAccess2020's work as offering a positive contribution by circling back to re-unify mass $M$ and separation distance $D$; however, an important component is still missing, the proportionality constant $G$. 

As such, this paper's focus is on the proportionality constant. We wish to demonstrate the importance of transiting from proportionality to equality in @eq-accessibility-general, in order to balance the units of accessibility into more interpretable values with clear meanings. To address this matter, we need not reinvent the wheel: instead we refer to the spatial interaction model as developed by @wilson1971. In essence, in what follows, we reunite the accessibility indicators literature with the spatial interaction literature as developed by @wilson1971 based on entropy maximization concepts. Although Wilson's approach is based on a different conceptual foundation than the old reference to Newtonian gravity, the work succeeded at identifying the steps from proportionality to equality to yield variations of proportionality constants: including the one that eluded @stewartDemographicGravitationEvidence1948 and has been ignored in almost all subsequent accessibility research.

# Introducing a family of accessibility measures

## Gravity-based accessibility's cousin: Wilson's spatial interaction model

Today's gravity-based accessibility measures (@eq-accessibility-general) share the same early 20th century Newtonian-based origins as the model's of Reilly, Zipf, and Stewart, versions of which continue to be extensively used [@ortuzar_2011_modelling;@wilson1971]. However, in some ways the gravity model and spatial interaction continued to evolve independently from @eq-accessibility-general, the former being developed into formalized transportation demand modelling practice to 'predict-and-provide', and the later taken up to describe land-use and transportation interactions by geography and social science-adjacent researchers and planners. From the perspective of gravity-based accessibility measure, this paper's focus is on the proportionality constant of the spatial interaction model, which takes the following form after Wilson [-@wilson1971]: 
 
$$
T_{ij} = k W_i^{(1)} W_j^{(2)} f(c_{ij})
$${#eq-phys-gravity-model}


<!--Explain the features of the gravity model of today (Wilson) -->
Where $T_{ij}$ represents a $n$ x $m$ matrix of flows between an $n$ number of origins $i$ and an $m$ number of destinations $j$, $W_i^{(1)}$ and $W_j^{(2)}$ is a vector of mass attributes representing origin $i$ and destination $j$ respectively, and $f(c_{ij})$ is a $n$ x $m$ matrix representing some function of travel cost $c_{ij}$ which reflects travel impedance. In other words, $T_{ij}$ explicitly measures _interaction_ as a unit of trips and the single proportionality constant $k$ ensures the total sum of $T_{ij}$ represents the total flows in the data. It should be noted that the early analogy with the gravitational law proved too simplistic, and improvements to the gravity model (@eq-phys-gravity-model) are the use of total trip ends (number of originating trips from zone $i$ are $O_i$ and ending trips at zone $j$ are $D_j$) instead of total populations and separation distance calibrated by a power $n$ (such as $P_i$, $P_j$, and $n$ in @eq-zipf, @eq-reilly and @eq-stewart-force). Finally, and of most important note in this paper, $k$ is a scale parameter that makes the overall equation proportional to the rate characteristic of the modeled phenomenon.

Traditionally, the development of the gravity model has put an emphasis on the interpretability of the resulting units [@kirbyNormalizingFactorsGravity1970; @wilsonSTATISTICALTHEORYSPATIAL1967;@wilson1971]. But instead of relying on the heuristic Newtonian gravity analogy, entropy maximisation has emerged as a popular model building approach taken in the spatial interaction studies to generate the gravity model [@ortuzar_2011_modelling]. Namely, it is mathematically rigorousness and offers a sensible interpretation of the resulting model as a statistical averaging procedure [@wilson1971;@seniorGravityModellingEntropy1979]. As such, @eq-phys-gravity-model can be derived to account for additional information to include constraints that reflect known information about the system and is mathematically rigorous. The interaction variable $T_ij$ is often in the unit of trips, so additional knowledge can be the total trip flows originating at each zone $W_i^{(1)}$ and the total trip flows terminating at zone $W_j^{(2)}$. These pieces of information can constrain $T_{ij}$ as follows.

The total flow constraint: @eq-constraint0-gravitymodel, where the total number of flows in the region equals $T$: <!-- Along a similar region-wide perspective, the total flows multiplied by their travel cost in the region is constrained to equal $C$:-->
$$
\sum_i\sum_j T_{ij} = T
$${#eq-constraint0-gravitymodel}

<!-- $$ -->
<!-- \sum_i\sum_j T_{ij} c_{ij} = C -->
<!-- $${#eq-constraint0_5-gravitymodel} -->

The production constraint: the sum of trips ending at each $j$ is equal to the total flow originating from each $i$:
$$
\sum_j T_{ij} = W_i^{(1)}
$${#eq-constraint1-gravitymodel}

The attraction constraint: the sum of trips starting at each $i$ is equal to the total flow ending at each $j$:
$$
\sum_i T_{ij} = W_j^{(2)}
$${#eq-constraint2-gravitymodel}


The entropy maximization derivation is demonstrated in detail elsewhere (e.g., @ortuzar_2011_modelling, @wilsonSTATISTICALTHEORYSPATIAL1967). The basis of the approach is to accept that there are macro, meso, and micro states. In the case of trips being the interaction variable, a micro state is an individual trip maker, the meso state is the statistically representative zone representing a collection of individual trip makers, and the macro state is the entire study region. Using these assumptions, a set of $T_{ij}$ that maximizes the number of micro states in each meso state subject to some sensible macro-state constraints (@eq-constraint0-gravitymodel, @eq-constraint1-gravitymodel, and @eq-constraint2-gravitymodel). From this approach, the gravity model can be interpreted as the given the total number of individual trips (micro level) statistically represented at origin and destination zones (meso level), the cost of travelling (micro level, represented at the meso level), and the fixed total cost of travelling in the region (number of trips and cost of travel at the macro level). There is then a most probable distribution of trips between zones (meso-states) that stasis all the macro-state constraints.

Using these constraints, the gravity model @eq-phys-gravity-model is distinguished into four general cases. These cases are presented in increasing order of constraint restrictiveness and continued to be useful in classifying the gravity model in trip distribution modelling to this day [@ortuzar_2011_modelling]: 

- The unconstrained case: neither @eq-constraint0-gravitymodel, @eq-constraint1-gravitymodel, or @eq-constraint2-gravitymodel hold;
- The total constrained case: only @eq-constraint0-gravitymodel hold
- The singly-constrained case: either @eq-constraint1-gravitymodel holds (origin-constrained) <!-- production--> or @eq-constraint2-gravitymodel holds (destination-constrained)<!-- attraction-->; 
- The doubly-constrained case: both @eq-constraint1-gravitymodel and @eq-constraint2-gravitymodel hold simultaneously <!--production-attraction-->

In each of these four cases, the single proportionality constant $k$ is replaced by balancing factors $A_i$, $B_j$, and $K$ as follows to ensure the case-specific constraints are satisfied:
$$
A_i = \frac{1}{\sum_j B_j W_j^{(2)} f(c_{ij})}
$${#eq-bf-A-gravitymodel}

$$
B_j = \frac{1}{\sum_i A_i W_i^{(1)} f(c_{ij})}
$${#eq-bf-B-gravitymodel}
<!--PRETTY SURE YOU DON'T GET K FROM ENTROPY MAXIMAISATION...-->
$$
K = \frac{T}{\sum_i \sum_j W_i^{(1)} W_j^{(2)} f(c_{ij})}
$${#eq-bf-K-gravitymodel}

For the doubly-constrained case, $A_i$ and $B_j$ must be solved together along with $K$. For the singly-constrained cases, origin-constrained case replaces $B_j$ with 1 for all $j$ and $A_i$ is @eq-bf-A-gravitymodel, and the the destination-constrained case replaces $A_i$ with 1 for all $i$ and $B_j$ is @eq-bf-B-gravitymodel. For both singly-constrained cases, $K$ also holds. For the total constrained case, $A_i$ and $B_j$ are set to 1 and $K$ is the defining constraint. And for the unconstrained case, all other cases (the total constrained, singly-constrained and doubly-constrained cases) are simply constrained variations.

## Accessibilities' development seperate from the family of gravity models

Upon detailing the gravity model, we can now discuss how accessibility has been developed within that field and how it has not. Gravity modellers (interaction variable being trips, a model of spatial interaction - mobility) continued to use accessibility within transportation demand modelling. As succinctly summarized in @morrisAccessibilityIndicatorsTransport1979, "Mobility and accessibility together influence an individual’s capacity to travel in daily life". However, the gravity model literature that focuses on Hansen's accessibility is relatively scarce. To capture this sentiment, see @fig-Fig1 which demonstrates the bibliometric coupling of papers that cites @hansen1959, @wilson1971, and both @hansen1959 and @wilson1971. @fig-Fig1 is based on a SCOPUS search of papers that cite @hansen1959's DOI (2,134 documents) and another SCOPUS search of papers that cite @wilson1971's DOI (368 documents) conducted on November 9, 2024 and a bibliometric coupling matrix created using the {bibliometrix} R package [@bibliometrix2017].

```{r plot-figure1, out.width=600, out.height=600}
#| label: fig-Fig1
#| fig-cap: "The bibliometric coupling of papers that cite Hansen (1959), Wilson (1971) and both Hansen (1959) and Wilson (1971)."
include_graphics(glue(here(), "/data-raw/Han_Wilson_bib_coupling_plot.png"))
```

Many of the papers that cite both @hansen1959 and @wilson1971 (77 journal articles) are transportation modelling papers working on integrating accessibility within the gravity model (mobility). 

For instance, @battyMethodResiduesUrban1976 states that the relationship between the gravity model and Hansen's original accessibility-potential model may be worth exploring... There is a consistent acknowledgement that these two models are related. Specifically, that the Hansen-type accessibility model is embedded within the balancing factors [@harrisEquilibriumValuesDynamics1978; @leonardiOptimumFacilityLocation1978; @fotheringhamSPATIALSTRUCTUREDISTANCE1981; @fotheringhamSpatialCompetitionAgglomeration1985]. This is a "common sense" approach at integrating accessibility [@morrisAccessibilityIndicatorsTransport1979]. 

Though there are other approaches to consider accessibility with spatial interaction modelling beyond Hansen founded on micro-economic consumer behaviour [@morrisAccessibilityIndicatorsTransport1979]. For instance, others explore entropy maximising solutions (Wilson's framework and hence the balancing factors defined as Hansen's accessibility) when considering demand behavior described by random utility choice models [@leonardiRandomUtilityDemand1984].

Some work on location-allocation models also used both Hansen and Wilson. For instance, @leonardiOptimumFacilityLocation1978 and @beaumontLocationallocationProblemsPlane1981 define a location-allocation problem using the singly-constrained gravity model, and then defines one using Hansen-type accessibility as the objective function subject. 

Then, @fotheringhamSpatialCompetitionAgglomeration1985 demonstrated that destination's accessibility should be explicitly specified within Wilson's framework, citing Hansen measure as convenient formulation. Without the consideration for accessibility explicitly, unexplained spatial pattern remains. This later came to be the 'competition destination' model, and is one of a few techniques to address spatial variation in gravity models. [@oshanSpatialStructureDebate2021]. Implicitly, we gather that at this point: it was understood balancing factors in the gravity model could not be understood as capturing accessibility. We also gather that in this moment of growing complexity of spatial interaction modelling, accessibility branched off and sprouted in the medium of budding GIS technology and the emergence of space-time dimensions [@millerMeasuringSpaceTimeAccessibility1999; @occelli2000revisiting]. With the possibility for showcasing complex GIS methodologies for varied case studies, accessibility became mature enough to branch off on its own. 

In papers after @fotheringhamSpatialCompetitionAgglomeration1985, Hansen is typically cited as providing a definition of accessibility but how Wilson is cited changes through the years. Wilson is attributed for using different travel cost functions in depending on the context [@weibullNumericalMeasurementAccessibility1980; @handyMeasuringAccessibilityExploration1997; @kwan1998space; @shenLocationCharacteristicsInnercity1998;@ashiru2003space; @rau2012spatial; @pan2013impacts; @margaridacondecomelhoradoImpactMeasuringInternal2016; @caschili2015accessibility; @grengs2015nonwork; @pan2020measuring; @chia2020extending; @roblot2021participation; @sharifiasl2023incorporating; @kharel2024examining].

Othertimes, Wilson and Hansen measures were progressively incorrectly conflated throughout the years [ @giuliano2010accessibility; @grengs2010intermetropolitan; @grengs2010job; @grengs2012equity; @levine2012does; @levinson2012positive; @tong2015transportation; @liu2015spatial; @he2017measuring; @wuUnifyingAccess2020; @ng2022reflection; @naqavi2023mobility; @suel2024measuring] - indeed they both measure spatial interaction so are somewhat related, but they are not the same. They are also co-cited to refer to the concept of 'gravity' in models [@liu2004accessibility; @dai2017visualization; @shen2019segregation; @chia2020extending]

And finally, Wilson's balancing factors are interpreted as inverse Hansen-type accessibility, especially in the context of competition [@vickermanAccessibilityAttractionPotential1974; @karstEvaluationAccessibilityImpacts2003;@geurs2006accessibility; @willigers2007accessibility;@el2011place; @curtis2010planning; @manaugh2012makes; @chen2013regional; @alonso2014labour; @albacete2017measuring; @sahebgharani2019computing; @mayaud2019future; @allenMeasureCompetitiveAccess2020; @levinsonGeneralTheoryAccess2020; @marwal2022literature; @su2023untangling]. This interpretation is fraut, upon considering @fotheringhamSpatialCompetitionAgglomeration1985's demonstration, which many of these works do not contend with. 

THE SPATIAL STRUCTURE DEBATE: @oshanSpatialStructureDebate2021

Some papers also use gravity models to estimate trip or some other interaction flows alongside accessibility indicators [@clarke2002deriving; @grengs2004measuring; @turk2019socio] or integrate accessibility within the gravity model, in line with @fotheringhamSpatialCompetitionAgglomeration1985's demonstration and most often in context with retailing [@beckers2022incorporating].

Hansen is a relatively straightforward simple application, while Wilon's contribution is methodological and dense - must be carefully read. Many takeaways can be drawn, so with accessibilities changing applications throughout the years -- different things about Wilon's contribution becomes relevant. The most contemprary connection between the two is in the relam of competitive accessibility -- in the interpretation of Wilson's balancing factors as a way to consider competition. We fit this contribution in this literature. Competition fits on a spectrum - by introducing balancing factors trips are _constrained_ to equal regional or zonal totals. This same application can be applied to accessibility.


Some 
Additionally, trending research topics of the time such as space-time and more  []

previously mentioned in accessibility development: the breadth of opportunity $O_j$ that can be studied [] as well as the accuracy of parameters that capture distance-decay $f(c_{ij})$ []. Outside of these factors, accessibility literature that delves into competition, does not cite Wilson, with some exception... Soukhov for the balancing factor. 

Overall, work that cities Wilson is closer related to transportation demand modelling than accessibility. However there are a few works of the 77 documents that are in the realm of accessibility. ...

However there are a few papers that are accessibility focused that focus on 

<!-- REVIEW CSV OF PAPERS-->

There are plenty of insights to be shared across these sibling branches; they are both spatial interaction models. 


## A family of accessibility measures

Instead of the interaction variable being in the unit of trips, it is in the unit of potential interaction with opportunities. This focus is the preoccupation of accessibility measures. The same analytical framework to define the balancing factors $k$ can be used for the family of accessibility measures as in the family of gravity models, however with different interpretation. In this section, we explicitly define these cases. 

In this context, accessibility is our _interaction_ variable of choice, so $T_{ij}$ in @eq-phys-gravity-model is replaced with $V_{ij}$. As the interaction variable represents _potential_, i.e., the number of potential reachable opportunities, as opposed to trips:

<!-- W_i^{(1)} enters through k.. it is a quality of the destination -->

$$
V_{ij} = k W_j^{(2)} f(c_{ij}) = k O_j f(c_{ij})
$${#eq-access}

Where $V_{ij}$ consists of the same variables, however $V_{ij}$ explicitly measures _potential interaction_ as a unit of number of potentially reachable opportunities and the single proportionality constant $k$ ensures the total sum of $V_{ij}$ represents the total potential reachable opportunities in the data. Notably, the mass vectors $W_i^{(1)}$ and $W_j^{(2)}$ are replaced by $P_i$ and $O_j$, representing the weight of the origin (population) and destination (opportunities), the weights common in accessibility literature. As accessibility is the sum of opportunities for a $j$ from $i$, when the mass of the origin ($P_i$) is relevant, it enters @eq-access through the $k$ constant. Accessibility is also most often presented as a locational measure, so the value of $V_i$ is of most interest, e.g., the number of potentially reachable opportunities at a zone:

$$
V_{i} = k \sum_j O_j f(c_{ij})
$${#eq-access-sum}


Like with @eq-phys-gravity-model, we distinguish @eq-access into four cases based on versions of the gravity-model building constraints (@eq-constraint0-access,  @eq-constraint1-access, and @eq-constraint2-access) to reflect macro-level knowledge, i.e., the sum of the number of potential reachable opportunities. 

$$
\sum_i\sum_j V_{ij} = V
$${#eq-constraint0-access}
\noindent Where the sum of all potentially reached opportunities in the region is equal to a total opportunities in the region $V$.


$$
\sum_j V_{ij} = W_i^{(1)} = P_i
$${#eq-constraint1-access}
\noindent Where sum of all potentially reachable opportunities for all $j$ zones in the region is equal to the production weight at each $i$ in the region.

$$
\sum_i V_{ij} = W_j^{(2)} = O_j
$${#eq-constraint2-access}
\noindent Where sum of all potentially reachable opportunities for all $i$ zones in the region is equal to the attraction weight at each $j$ in the region.

All four cases are differentiated like:
- The unconstrained case: neither @eq-constraint0-access, @eq-constraint1-access, or @eq-constraint2-access hold;
- The total constrained case: only @eq-constraint0-access hold
- The singly-constrained case: either @eq-constraint1-access holds (origin-constrained) <!-- production--> or @eq-constraint2-access holds (destination-constrained)<!-- attraction-->; 
- The doubly-constrained case: both @eq-constraint1-access and @eq-constraint2-access hold simultaneously <!--production-attraction-->

<!-- - HYBRID CASE: @eq-constraint1-access or @eq-constraint2-access partly hold -- hybrid production constrained case <!-- (could be repeated for attraction constrained case... and doubly constrained case)-->

Like gravity model problem, we can solve these cases using spatial weights matrix and travel cost matrix, but with alternative meanings. $P_i$ (our $W_i^{(1)}$) is population at $i$ who seek opportunities. $O_j$ (our $W_j^{(2)}$) are the opportunities being sought. For this simple example, we can say that the opportunities are the population's jobs. In our region, each person has a job - but we only know at an aggregate how many people are at each $i$, the jobs that are located at $j$ and the travel cost $c_{ij}$. We assume the the travel impedance ($f(c_{ij})$) is the associated travel propensity of $f(c_{ij}) = 1/C$. 

The following is the known accessibility matrix. The $V_{ij}$, the number of jobs spatially accessible at $i$ from destination $j$. The TOTALs are the $V_i$ and $V_j$, the total number of jobs spatially available at $i$ and the number of jobs spatially available from $j$.
```{r}
known_matrix <- matrix(c(95,23,42, 27,378,45, 38,36,106), ncol = 3, byrow = TRUE)
#unknowns <- matrix(c(rep(NA,9)), ncol=3, byrow=TRUE)
P_i <- known_matrix |> rowSums()
O_j <- known_matrix |> colSums()
V <- ifelse(sum(P_i)==sum(O_j), sum(O_j),NA)
knowns_longer <- cbind(known_matrix,P_i)
knowns_longer <- rbind(knowns_longer,cbind(t(O_j),T))

rownames(knowns_longer) <- c("1","2","3", "TOTAL") 
colnames(knowns_longer) <- c("1","2","3", "TOTAL")

knowns_longer #|> as.data.frame() |> round() |> gt(rownames_to_stub=TRUE)
```

And the matrix of cost of travel from $i$ (rows) to $j$ (columns) is as follows:
```{r}
C <- matrix(c(2, 15, 5, 15, 2, 10, 5, 10, 2), ncol = 3, byrow = TRUE)
C_longer <-C
rownames(C_longer) <- c("1","2","3") 
colnames(C_longer) <- c("1","2","3") 
C_longer #|> as.data.frame() |> gt(rownames_to_stub=TRUE)
```

### Unconstrained accessibility 

This accessibility is standard practice. There is no explicit consideration of a proportionality constant ($k$). We can presume it is still set to 1 as @stewartPrinciples1947. No constraints hold, making the interpretation of the units of $V_{ij}$ simply some magnitude of $O_j$ weighted by some $f(c_ij)$, and $V_{i}$ the sum of these values for each $j$. $V_i$ reflects the magnitude of opportunity accessibility but it is not scaled to equal the number opportunities $O$ and/or population $P$.
$$
V_{ij} = O_j f(c_{ij})\\ 
V_{i} = \sum_j O_j f(c_{ij})
$$

Each origin (row) all the opportunities at each destination are available. Likewise, each destination (column) offers all opportunities to each origin: 
```{r}
O_P_unc <- t(matrix(rep(O_j, 3), 3, 3))
O_P_unc_longer <- O_P_unc
rownames(O_P_unc_longer) <- c("1","2","3") 
colnames(O_P_unc_longer) <- c("1","2","3")
O_P_unc_longer
```

The resulting matrix of $V_{ij}$ along with the $V_i$ and $V_j$ totals for this example:
```{r}
V_unc <- O_P_unc / C

P_i_unc <- V_unc |> rowSums()
O_j_unc <- V_unc |> colSums()
V_TOTAL_unc <- ifelse(sum(P_i_unc|>round())==sum(O_j_unc|>round()), sum(V_unc), NA)
V_unc_longer <- cbind(V_unc,P_i_unc)
V_unc_longer <- rbind(V_unc_longer, cbind(t(O_j_unc),V_TOTAL_unc))

rownames(V_unc_longer) <- c("1","2","3", "TOTAL") 
colnames(V_unc_longer) <- c("1","2","3", "TOTAL")

V_unc_longer |> round(digits = 2) #|> as.data.frame()  |> gt(rownames_to_stub=TRUE)
```

We'd report origin 1 as having 148 accessibility (i.e., $V_{i=1} = 148$), origin 2 as 248 accessibility, and origin 3 as 172 accessibility. The total accessibility in the region is 568 ($\sum_i V_{i} = 568$), not equal to any meaningful value. This value is not often reported in the accessibility literature for this reason. One could also report the accessibility values that destinations offers ($V_{j}$), namely destination 1 offers 123, destination 2 offer 291, and destination 3 offers 154. However, these values are also not reported in the literature currently... as they aren't constrained to match up to the number of opportunities at each j (i.e., 160, 437 and 193). Assuming $k=1$, $V_i$ and $V_j$ represent magnitudes of accessibility concepts, but in an unconstrained way. The population matrix is no incorporated in the $V_{ij}$ calculation, so $V_i$ cannot be directly compared to population. From a different perspective, $V_j$ values also cannot be compared to known $O_j$ values as the equation unconstrained. 

OF NOTE: in the context of spatial interaction modelling, the unconstrained model is not often useful. While the resulting $T_{ij}$ values are in units of 'trips' - the assumption of $k$ equaling 1 is practically meaningless. 

Accessibility, or the _potential_ for interaction is different than interaction ($V_{ij}$ vs. $T_{ij}$), namely since the number of opportunities that are accessible at an origin from a destination cannot be known in the same way as a trip from an origin to a destination. However, we would argue that getting closer to knowning this number and planning for it - is what accessibility research should strive to achieve. <!-- yeah? -->


### Total flow constrained accessibility

In the total constrained case, $k$ is replaced with $K$ (@eq-access satisfying only constraint @eq-constraint0-access) as follows for $V_{ij}$ and $V_{i}$:
$$
V_{ij}' = K O_j f(c_{ij})\\
V_{i}' = K\sum_j O_j f(c_{ij})
$$

Solved for our example, $K$ is equal to the total accessibility $V$, divided by the sum of the unconstrained accessibility:
$$
K = \frac{V}{\sum_{i}\sum_{j} O_j f(c_{ij})}\\
K = \frac{V}{\frac{O_1}{c_{1,1}}+\frac{O_1}{c_{2,1}}+\frac{O_1}{c_{3,1}}+\frac{O_2}{c_{1,2}} +... \frac{O_3}{c_{3,3}}
}\\
K = \frac{790}{568.4} \\
K = 1.389866
$$

```{r}
K <- V/sum(V_unc)
V_tot <- K * V_unc

P_i_tot <- V_tot |> rowSums()
D_j_tot <- V_tot |> colSums()
V_TOTAL_tot <- ifelse(sum(P_i_tot)==sum(D_j_tot), sum(V_tot), NA)
V_tot_longer <- cbind(V_tot,P_i_tot)
V_tot_longer <- rbind(V_tot_longer, cbind(t(D_j_tot),V_TOTAL_tot))

rownames(V_tot_longer) <- c("1","2","3", "TOTAL") 
colnames(V_tot_longer) <- c("1","2","3", "TOTAL")

V_tot_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE)
```

While we can see that the 'number of potentially reachable opportunities' `r V` results, the total access at a each $i$ or $j$ is not equal to the known known total access ends (because these constraints are not specified and thus not satisfied by the model). This approach is not yet seen in accessibility literature, but could be an intelligible way to compare accessibility values ($V_i$ or $V_j$) without considering the population matrix. 

### Singly-constrained case 

Similarly, singly-constrained can be either origin-constrained $V_i''^{(1)}$ or destination-constrained $V_i''^{(2)}$. For the origin- and destination- constrained versions, $k$ is replaced with $A_{ij}$ and $B_{ij}$ respectively (@eq-access enforcing constraint @eq-constraint1-access or @eq-constraint2-access, and implicitly @eq-constraint0-access):

$$
V_{ij}''^{(1)} = A_{ij} O_j f(c_{ij})\\
V_{ij}''^{(2)} = B_{ij} O_j f(c_{ij})\\
$${#eq-access-singlyconstrained-origin}

\noindent Where $A_{ij}$ and $B_{ij}$ are similar to the balancing factors of the gravity model for the singly-constrained cases, though with an addition to the numerator to maintain the associated enforcing constraints:
$$
A_{ij} = \frac{O_j}{\sum_j B_{ij} O_j f(c_{ij})}\\
B_{ij} = \frac{P_i}{\sum_i A_{ij} P_i f(c_{ij})}\\
$$
In solving the origin-constrained $V_{ij}^{''(1)}$ case (e.g., @eq-constraint1-access of $\sum_j V_{ij} = P_i$ is enforced), $B_{ij} = 1$. In solving the destination-constrained $V_{ij}^{''(2)}$ case (e.g., @eq-constraint2-access of $\sum_i V_{ij} = O_j$ is enforced), $A_{ij} = 1$. 

Solving for the destination-constrained case $V_{ij}^{''(2)}$ may be helpful in an example where the number of people seeking opportunities is known ($P_i$), along with the number of opportunities $O_j$ offered by a destination as in unconstrained and total accessibility. An example could be the number of people at each residence seeking hospital-beds (origin) and hospital-beds (opportunities) at each healthcare location (destination) to calculate the opportunity access at each origin. Another case could be calculating the opportunity access at each origin using the quantity of goods available to purchase (opportunities) at each commercial location (destination). 

From our review, related versions of this defined destination-constrained accessibility are formulaically similar to retail accessibility models e.g., decision model for shops to optimally spatially locate to maximize their potential consumer interaction. Starting with reilly's law of gravitational retail [@reilly1929methods], formalized later in @huffDefiningEstimatingTrading1964 and @lakshmananRetailMarketPotential1965. Other literature also demonstrates  similar _competition_ considerations through its analytical formulation; for instance, in the Intervening Opportunities model [@stoufferInterveningOpportunitiesTheory1940; @stoufferINTERVENINGOPPORTUNITIESCOMPETING1960] "axiomatically" @weibull_axiomatic_1976, and competition consideration expressed as a per population rate particularly in healthcare and job opportunity accessibility analysis [@shen1998], and 2FCA methods in general [@soukhovIntroducingSpatialAvailability2023]. Most of these works do not explicitly focus on balancing accessibility units; rather, they center on _competition_ considerations. We suspect this may be why they have been used in case studies examining access to opportunities that are inherently competitive or where the concept of supply and demand resonates. It was only until the recent work of [@soukhovIntroducingSpatialAvailability2023], where the units of accessibility given competition, e.g., the spatial availability, was introduced with the focus on both competition and balanced units. NOTE: See Appendix where I demonstrate how this destination-constrained case is equivalent to spatial availability

Returning to our simple example, the destination-constrained singly-constrained case would yield the following $B_{ij}$ values:
$$
B_{ij} = \frac{P_{i}}{\sum_i P_i f(c_{ij})}\\
B_{1,1} = \frac{P_{i}}{P_1 f(c_{1,1}) + P_2 f(c_{1,2}) + P_3 f(c_{1,3})}\\
...\\
B_{1,1} = 160 *\frac{1}{160/2+450/15+180/5} = 1.09589 \\ 
B_{2,1} = 450 *\frac{1}{160/2+450/15+180/5} =3.082192 \\
B_{3,1} = 180 * \frac{1}{160/2+450/15+180/5} =1.232877 \\
...\\
B_{1,2} = 160 *\frac{1}{160/15+450/2+180/10} =0.630749 \\
B_{2,2} = 450 *\frac{1}{160/15+450/2+180/10} =1.773982 \\
B_{3,2} = 180 * \frac{1}{160/15+450/2+180/10} =0.7095926 \\
...\\
B_{1,3} = 160 *\frac{1}{160/5+450/10+180/2} = 0.9580838\\
B_{2,3} = 450 *\frac{1}{160/5+450/10+180/2} = 2.694611  \\
B_{3,3} = 180 *\frac{1}{160/5+450/10+180/2} = 1.077844 \\
$$
```{r}
B_ij <- matrix(P_i) %*% (1/(t((matrix(P_i))) %*% (1/C))) 
B_ij_longer <- B_ij
rownames(B_ij_longer) <- c("1","2","3") 
colnames(B_ij_longer) <- c("1","2","3") 
B_ij_longer 
```

$V_{ij}$ values:
```{r}
V_dest <- (B_ij) *(V_unc) # V_unc = (1/C)* t(matrix(rep(W_j, 3), 3, 3)) 

P_i_dest <- V_dest |> rowSums()
O_j_dest <- V_dest |> colSums()

V_TOTAL_dest <- ifelse(sum(P_i_dest)==sum(O_j_dest), sum(V_dest), NA)
V_dest_longer <- cbind(V_dest,P_i_dest)
V_dest_longer <- rbind(V_dest_longer, cbind(t(O_j_dest),V_TOTAL_dest))

rownames(V_dest_longer) <- c("1","2","3", "TOTAL") 
colnames(V_dest_longer) <- c("1","2","3", "TOTAL")

V_dest_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE)
```

The $O_j$ values are equal to the known opportunities, whereas the $P_i$ values are not. The total accessibility in the region is maintained at 790. Each $V_{ij}$ can be interpreted as the number of opportunities accessible from each destination by anyone in the region all weighted by travel cost of course. 

### Doubly constrained case (origin-destination constrained)

(only when the units of the marginals are the same, therefore of more limited application)
ex. @hornerExploringMetropolitanAccessibility2004 and @allenMeasureCompetitiveAccess2020
<!-- this done'st work.. for now!-->
```{r}
doubly_constrained_gravity_model <- function(
    #CREDIT: I converted the python code from (https://github.com/SadraDaneshvar/Gravity_Model) to R
  P,  # Origin production weights vector (POPULATION)
  O,  # Destination attraction weights vector (OPPORTUNITIES)
  impedance_matrix,  # the resulting travel cost impedance matrix
  error_threshold = 0.001,  # Error threshold for stopping condition
  improvement_threshold = 1e-6  # Improvement threshold for stopping condition
) {
  
  # Normalize O and D
  sum_P <- sum(P)
  sum_O <- sum(O)
  cat("Checking population, opportunity balancing:\n")
  cat("Population: ", sum_P, "\n")
  cat("Opportunities: ", sum_O, "\n")
  
  if (sum_P != sum_O) {
    cat("Population and opportunities do not balance, scaling to match.\n")
    if (sum_P < sum_O) {
      P <- P * (sum_O / sum_P)
    } else {
      O <- O * (sum_P / sum_O)
    }
  } else {
    cat("Population, opportunities balancing OK.\n")
  }
  
  n <- length(P)  # Number of i
  V <- sum(P)  # Total access
  Ai <- rep(1, n)  # Initialize Ai
  Bj <- rep(1, n)  # Initialize Bj
  
  previous_error <- Inf
  iteration_count <- 0
  stop_reason <- ""
  
  while (TRUE) {
    iteration_count <- iteration_count + 1
    
    # Update Ai
    for (i in 1:n) {
      Ai[i] <- 1 / (sum(Bj * O * impedance_matrix[i, ]) + 1e-9)
    }
    
    # Update Bj
    Bj_new <- rep(1, n)
    for (j in 1:n) {
      Bj_new[j] <- 1 / (sum(Ai * P * impedance_matrix[, j]) + 1e-9)
    }
    
    # Calculate Vij
    #Vij <- outer(Ai * P, Bj_new * O) * impedance_matrix
    Vij <- Bj_new * Ai * O * impedance_matrix
    
    # Print Ai and Bj for this iteration
    cat("\nIteration:", iteration_count, "\n")
    cat("Ai:", round(Ai, 3), "\n")
    cat("Bj:", round(Bj_new, 3), "\n")
    
    # Calculate error
    error <- (sum(abs(P - rowSums(Vij))) + sum(abs(O - colSums(Vij)))) / V
    
    # Calculate change in error
    error_change <- abs(previous_error - error)
    
    # Check stopping conditions
    if (error < error_threshold) {
      stop_reason <- "Error threshold met"
      break
    } else if (error_change < improvement_threshold) {
      stop_reason <- "Slow improvement"
      break
    }
    
    previous_error <- error
    Bj <- Bj_new
  }
  
  # report stopping condition and final error threshold
  cat("\nStopping Condition: ", stop_reason, "\n")
  cat(sprintf("Final Error: %.3f%%\n", error * 100))
  
  return(list(Ai = Ai, Bj = Bj, Vij = Vij))
}

dc_results <- doubly_constrained_gravity_model(P=P_i, O=O_j, impedance_matrix = 1/C)
dc_results$Vij
```

The $A_i$ and $B_j$ matrices:
```{r}
A_i_doubly <- dc_results$Ai
B_j_doubly <- dc_results$Bj

A_i_doubly |> matrix()
B_j_doubly |> matrix() |> t()
```

The trip matrix (notice, all summed up opportunities and populations are equivalent to our knowns)
```{r}
V_doubly <- dc_results$Vij

P_i_doubly <- V_doubly |> rowSums()
O_j_doubly <- V_doubly |> colSums()
V_TOTAL_dest <- ifelse(sum(P_i_doubly)==sum(O_j_doubly), sum(V_doubly), NA)
V_doubly_longer <- cbind(V_doubly,P_i_dest)
V_doubly_longer <- rbind(V_doubly_longer, cbind(t(O_j_doubly),V_TOTAL_dest))

rownames(V_doubly_longer) <- c("1","2","3", "TOTAL") 
colnames(V_doubly_longer) <- c("1","2","3", "TOTAL")

V_doubly_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE)
```



### Hybrid singly-constrained case: 
<!--NOTE TO SELF: where does E2SFCA and 3SFCA fit?? Maybe here-->
Balanced floating catchment areas (not truly doubly constrained)

# Empirical examples

Use the TTS2016R package to illustrate every measure.

# Discussion

When to use each of these measures?

# Conclusions


# APPENDIX (some musings...)

## Singly-constrained case is spatial availability

The destination-constrained case is also spatial availability, see below! As follows then, this case is also related to 2SFCA - if the value is divided by per capita (OR $P_i$ from the numerator in $B_{ij}$ is removed).

Spatial availability is formulated like so:
$$
V_{ij}''^{(2)}  = O_j\frac{F^p_{ij} \cdot F^c_{ij}}{\sum_{i=1}^K F^p_{ij} \cdot F^c_{ij}}
$$
It turns out that the denominators of the Population balancing factor $F^p_{ij} = \frac{P_{i\in r}^\alpha}{\sum_{i=1}^K P_{i\in r}^\alpha}$ and Travel cost balancing factor $F^c_{ij} = F^c_{ij} = \frac{f(c_{ij})}{\sum_{i=1}^K f(c_{ij})}$ cancel out, so spatial availability can be expressed as:
$$
V_{ij}''^{(2)} =O_j \frac{ P_i  f(c_{ij})}{\sum_i P_i f(c_{ij})}\\
$$

Reformatted in the general family of accessibility measure form, it looks like:
$$
V_{ij}''^{(2)} =k O_j f(c_{ij})\\
V_{ij}''^{(2)} =\frac{ P_i}{\sum_i P_i f(c_{ij})} O_j f(c_{ij})\\
V_{ij}''^{(2)} =  O_j\frac{F^p_{ij} \cdot F^c_{ij}}{\sum_{i=1}^K F^p_{ij} \cdot F^c_{ij}} = O_j \frac{ P_i  f(c_{ij})}{\sum_i P_i f(c_{ij})}\\
$$
## Checking singly-constrained case against spatial availability
```{r}
sp_avail <- function(x, o_id, d_id, pop, opp, r, f, alpha = 1){

  o_id <- rlang::enquo(o_id)
  d_id <- rlang::enquo(d_id)
  pop <- rlang::enquo(pop)
  opp <- rlang::enquo(opp)
  r <- rlang::enquo(r)
  f <- rlang::enquo(f)

  sum_pop <- x %>%
    dplyr::distinct(!!o_id,
                    .keep_all = TRUE) %>%
    dplyr::mutate(sum_pop = !!r*(!!pop)^alpha) %>%
    dplyr::pull(sum_pop) %>%
    sum()

  f_p <- dplyr::pull(x, !!r) * dplyr::pull(x, !!pop)^alpha / sum_pop

  sum_impedance <- x %>%
    dplyr::group_by(!!d_id) %>%
    dplyr::summarize(sum_impedance = sum(!!f))

  x <- x %>%
    dplyr::left_join(sum_impedance,
                     by = rlang::as_name(d_id))

  f_c <- dplyr::pull(x, !!f) / x$sum_impedance

  x$f_c <- f_c
  x$f_p <- f_p

  sum_pa <- x %>%
    dplyr::group_by(!!d_id) %>%
    dplyr::summarize(sum_pa= sum(f_p * f_c))

  x <- x %>%
    dplyr::left_join(sum_pa,
                     by = rlang::as_name(d_id))
  f_t <- (f_p * f_c) / dplyr::pull(x, sum_pa)

  dplyr::pull(x, !!opp) * f_t
}
```


```{r}

df <- data.frame(i = c(1,1,1,2,2,2,3,3,3), 
                 j= c(1,2,3,1,2,3,1,2,3),
                 f = c(1/C[1,], 1/C[2,], 1/C[3,]),
                 pop = c(P_i[1], P_i[1], P_i[1], P_i[2], P_i[2], P_i[2], P_i[3], P_i[3], P_i[3]),
                 opp = c(O_j[1],O_j[2],O_j[3], O_j[1],O_j[2],O_j[3], O_j[1],O_j[2],O_j[3]),
                 catch = c(1,1,1,1,1,1,1,1,1))

calced <- sp_avail(df,
                         o_id = i,
                         d_id = j,
                         pop = pop,
                         opp = opp,
                         r = catch,
                         f = f)
df$V_ij <- calced

df |> group_by(j) |> summarise(V_j = sum(V_ij))
```


## Destination- (or ATTRACTION) constrained is the only singly-constrained case... population- (or PRODUCTION) constrained doesn't make sense!

Then the origin-constrained (singly-constrained) case $V_{ij}^{(1)}$, no $P_i$ values are needed only $O_j$ values. Using this method, V_i values equal P_i values...? while O_j values are unconstrained. This case may be helpful in an example where the number of opportunities available to an origin is known and fixed. This could be a normative minimum threshold, such as 100 opportunities at each origin. 

Returning to our simple example, the origin-constrained singly-constrained case would yield the following $A_{ij}$ values:
$$
A_{ij} = \frac{O_{j}}{\sum_j O_j f(c_{ij})}\\
A_{1,1} = \frac{O_{j}}{O_1 f(c_{1,1}) + O_2 f(c_{1,2}) + O_3 f(c_{1,3})}\\
...\\
A_{1,1} = 160 *\frac{1}{160/2+437/15+193/5} = 1.083032 \\ 
A_{2,1} = 160 *\frac{1}{160/15+437/2+193/10} =0.6439496 \\
A_{3,1} = 160 * \frac{1}{160/5+437/10+193/2} =0.9291521 \\
...\\
A_{1,2} = 437 *\frac{1}{160/2+437/15+193/5} =2.958032 \\
A_{2,2} = 437 *\frac{1}{160/15+437/2+193/10} =1.7587872 \\
A_{3,2} = 437 * \frac{1}{160/5+437/10+193/2} =2.5377468 \\
...\\
A_{1,3} = 193 *\frac{1}{160/2+437/15+193/5} = 1.306408 \\
A_{2,3} = 193 *\frac{1}{160/15+437/2+193/10} = 0.7767642 \\
A_{3,3} = 193 *\frac{1}{160/5+437/10+193/2} = 1.1207898 \\
$$

```{r}
A_ij <- matrix(O_j) %*% (1/(t((matrix(O_j))) %*% (1/C))) |> t()
A_ij_longer <- A_ij
rownames(A_ij_longer) <- c("1","2","3") 
colnames(A_ij_longer) <- c("1","2","3") 
A_ij_longer 
```
Starting off with this opportunity matrix, namely - at i=1, only a fixed number of opportunities are accessible to this origin. same for i=2, i=3.
```{r}
(matrix(rep(O_j, 3), 3, 3))
```

$V_{ij}$ values:
```{r}
V_orig <- (A_ij) * t(V_unc) # V_unc = (1/C)* t(matrix(rep(W_j, 3), 3, 3)) #if you transpose the matrix here, that's another way of generating the answer. 

P_i_orig <- V_orig |> rowSums()
O_j_orig<- V_orig |> colSums()
V_TOTAL_orig <- ifelse(sum(P_i_orig)==sum(O_j_orig), sum(V_orig), NA)
V_orig_longer <- cbind(V_orig,P_i_orig)
V_orig_longer <- rbind(V_orig_longer, cbind(t(O_j_orig),V_TOTAL_orig))

rownames(V_orig_longer) <- c("1","2","3", "TOTAL") 
colnames(V_orig_longer) <- c("1","2","3", "TOTAL")

V_orig_longer #|> as.data.frame()  |> gt(rownames_to_stub=TRUE)
```


# References

<!-- 
## QUESTIONS:
- what does k=1 mean? What does assuming k=1, so the units can be kept mean for the model? Is it meaningless?
- not sure if the singly-constrained (PRODUCTION case) makes sense.. It sort of does..? I believe this needs to be figured out before the doubly constrained case. Pi needs to be integrated somehow. 
- doubly constrained still needs to be solved.


## next steps
- grocery stores for example; maybe 2 grids?
- bibliometric analysis 
- - draft of this end of jan 2025

- (future) intervening opportunities ? radiation model - deep gravity
- (future) accessibility pyramids 
- (future) MAUP addressed
- (future) comparing cities 
-->

<!--the benefits of this formulation, and the inclusion of the propoartionality constant has been imense for spatial interaction modelling. For instance, the identification of the conovlution of spatial autocorrelation and and distance-decay @griffithSpatialStructureSpatial2007 -->

<!-- Wilson in @wilsonSTATISTICALTHEORYSPATIAL1967 was the first to connect accessibility measures to balancing factors-->

<!--
@wilson1971 (pg. 28) summarises the following checklist for spatial interaction model builders:
1. Nature of the spatial interaction variable; 
2. Nature of the mass terms
3. Measurement of mass terms
4. Measurement of interaction cost
5. Choice of cost function
6. Other terms
7. Design of spatial system
8. Calibration
9. Relation to general model framework
-->

<!-- (cool paper that explores this @kirbyNormalizingFactorsGravity1970 - he "shows that the Ai and Bj balancing factors are the mean values of the inverse of the function e^-N*F(c_ij) calculated by summing the function over i values for Ai factors and over j values for Bj factors." -->


<!--TO DISCUSS:
-- should we use entropy maximisation to actually derive the models? I'm hazy on that.
  -- relatedly, in the unconstrained case... is k=1 or does k just not exist..? I assume k=1 and say that the interpretation in reality is confusing. a consistent derivation of all cases can help address this.
  -- constraint 0 or 0.5..? a consistent derivation of all cases should help address this. -->


<!--THE FOLLOWING ARE SOLVED EXAMPLES OF ALL FOUR CASES OF THE GRAVITY MODEL -->
<!-- The following are simple numerical examples of each case assuming the following 1) $T_{ij}$ trip ends matrix, 2) $C_{ij}$ travel cost matrix, and 3) an assumed travel impedance function of $f(c_{ij}) = \frac{1}{c_{ij}}$. For all cases, we look to estimate each $T_{ij}$ value using these three inputs, we present the known trip matrix and the trip ends below: -->
<!-- ```{r} -->
<!-- known_trip_matrix <- matrix(c(95,23,42, 27,378,45, 38,36,106), ncol = 3, byrow = TRUE) -->
<!-- #unknowns <- matrix(c(rep(NA,9)), ncol=3, byrow=TRUE) -->
<!-- W_i <- known_trip_matrix |> rowSums() -->
<!-- W_j <- known_trip_matrix |> colSums() -->
<!-- T <- ifelse(sum(W_i)==sum(W_j), sum(W_j),NA) -->
<!-- knowns_longer <- cbind(known_trip_matrix,W_i) -->
<!-- knowns_longer <- rbind(knowns_longer,cbind(t(W_j),T)) -->

<!-- rownames(knowns_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(knowns_longer) <- c("1","2","3", "TOTAL") -->

<!-- knowns_longer #|> as.data.frame() |> round() |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- And the matrix of cost of travel from $i$ (rows) to $j$ (columns) is as follows: -->
<!-- ```{r} -->
<!-- C <- matrix(c(2, 15, 5, 15, 2, 10, 5, 10, 2), ncol = 3, byrow = TRUE) -->
<!-- C_longer <-C -->
<!-- rownames(C_longer) <- c("1","2","3")  -->
<!-- colnames(C_longer) <- c("1","2","3")  -->
<!-- C_longer #|> as.data.frame() |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- For examples of how each type of case is solved, see many of the cited literutre, like @Wilson and @ortuza. -->



<!-- ## Unconstrained interaction case -->

<!-- $k$ can be understood as being set to 1, so the model looks as follows, with no constraints and the trip matrix is as follows. For example, $T_{1,1} = 160*160*\frac{1}{2}$ -->

<!-- $$ -->
<!-- T_{ij} = W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- ```{r} -->
<!-- T_unc <- W_i %*% t(W_j) / C -->

<!-- W_i_unc <- T_unc |> rowSums() -->
<!-- W_j_unc <- T_unc |> colSums() -->
<!-- T_TOTAL_unc <- ifelse(sum(W_i_unc|>round())==sum(W_j_unc|>round()), sum(T_unc), NA) -->
<!-- T_unc_longer <- cbind(T_unc,W_i_unc) -->
<!-- T_unc_longer <- rbind(T_unc_longer, cbind(t(W_j_unc),T_TOTAL_unc)) -->

<!-- rownames(T_unc_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_unc_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_unc_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- As we can surmise, the trip ends do not add up to anything we know -- they do not add up to the known trip ends. Instead, they take on the assumptions of all balancing factors $k$ being equal to 1. When would this happen? It's hard to say... as the balancing factors themselves do not have practical meaning; what has meaning are the constraints. By satisfying the constraints, the model gains meaning. In this way, the resulting unconstrained interaction matrix is simply an expression of the magnitude of interaction of $W_i$ to $W_j$ assuming $f(c_{ij})$. In the context of spatial interaction modelling, this model is not entirely useful; it is in units of 'trips' but trips that satisify the macro constraint of $k$ equaling 1, which is practically meaningless.   -->

<!-- ## Total constrained interaction case -->

<!-- In the total constrained case, $k$ is replaced with $K$ (@eq-bf-K-gravitymodel satisfying only constraint @eq-constraint0-gravitymodel) so the model looks as follows: -->
<!-- $$ -->
<!-- T_{ij}' = K W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- \where Solved for our example, $K$ is equal to the total number of known trips divided by the sum of all the unconstrained trips made: -->
<!-- $$ -->
<!-- K = \frac{T}{\sum_{i}\sum_{j} W_i^{(1)} W_j^{(2)} f(c_{ij})}\\ -->
<!-- K = \frac{T}{\frac{W_1^{(1)}W_1^{(2)}}{c_{1,1}}+\frac{W_2^{(1)}W_1^{(2)}}{c_{2,1}}+\frac{W_3^{(1)}W_1^{(2)}}{c_{3,1}}+\frac{W_1^{(1)}W_2^{(2)}}{c_{1,2}} +... \frac{W_3^{(1)}W_3^{(2)}}{c_{3,3}} -->
<!-- }\\ -->
<!-- K = \frac{790}{166443} \\ -->
<!-- K = 0.00474636 -->
<!-- $$ -->

<!-- ```{r} -->
<!-- K <- T/sum(sum(T_unc)) -->
<!-- T_tot <- K * T_unc -->

<!-- W_i_tot <- T_tot |> rowSums() -->
<!-- W_j_tot <- T_tot |> colSums() -->
<!-- T_TOTAL_tot <- ifelse(sum(W_i_tot|>round())==sum(W_j_tot|>round()), sum(T_tot), NA) -->
<!-- T_tot_longer <- cbind(T_tot,W_i_tot) -->
<!-- T_tot_longer <- rbind(T_tot_longer, cbind(t(W_j_tot),T_TOTAL_tot)) -->

<!-- rownames(T_tot_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_tot_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_tot_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->
<!-- While we can see that the total trips `r T` results, the total trip ends are not equal to the known trip ends as these constraints are not specified and thus not satisfied by the model. -->

<!-- ## Singly-constrained -->

<!-- Two versions of this case, either origin-constrained or destination-constrained.  -->

<!-- For the origin-constrained model, where $k$ is replaced with $A_i$ (@eq-bf-A-gravitymodel satisfying only constraint @eq-constraint1-gravitymodel and implicitly @eq-constraint0-gravitymodel), the model looks as follows: -->
<!-- $$ -->
<!-- T_{ij}^{''(1)} = A_i W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- \where In our example, $A_i$ is: -->
<!-- $$ -->
<!-- A_i = \frac{1}{\sum_j W_j^{(2)} f(c_{ij})}\\ -->
<!-- A_1 = \frac{1}{W_1^{(2)} f(c_{1,1}) + W_2^{(2)} f(c_{1,2}) + W_3^{(2)} f(c_{1,3})}\\ -->
<!-- ...\\ -->
<!-- A_1 = \frac{1}{160/2+437/15+193/5} =0.006768953 \\ -->
<!-- A_2 = \frac{1}{160/15+437/2+193/10} =0.004024685 \\ -->
<!-- A_3 = \frac{1}{160/5+437/10+193/2} =0.005807201  -->
<!-- $$ -->

<!-- ```{r} -->
<!-- A_i <- 1/t((matrix(W_j))) %*% (1/C) -->
<!-- #A_i <- rowSums(known_trip_matrix)/rowSums(T_unc) #our answer with knowns -->
<!-- A_i<- diag(A_i|> as.numeric(), nrow=3, ncol=3) -->

<!-- T_orig <-  A_i%*%T_unc -->

<!-- W_i_orig <- T_orig |> rowSums() -->
<!-- W_j_orig <- T_orig |> colSums() -->
<!-- T_TOTAL_orig <- ifelse(sum(W_i_orig)==sum(W_j_orig), sum(T_orig), NA) -->
<!-- T_orig_longer <- cbind(T_orig,W_i_orig) -->
<!-- T_orig_longer <- rbind(T_orig_longer, cbind(t(W_j_orig),T_TOTAL_orig)) -->

<!-- rownames(T_orig_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_orig_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_orig_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- We can see that the $W_i^{(1)}$ values are equal to the trip ends, but not $W_j^{(2)}$ values.  -->

<!-- Similarly, the singly-constrained case can be flipped to be origin-constrained (@eq-bf-B-gravitymodel satisfying only constraint @eq-constraint1-gravitymodel and implicitly @eq-constraint0-gravitymodel): -->
<!-- $$ -->
<!-- T_{ij}^{''(2)} = B_j W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- \where $B_j$ is, and equal to: -->
<!-- $$ -->
<!-- B_j = \frac{1}{\sum_i W_i^{(1)} f(c_{ij})}\\ -->
<!-- $$ -->
<!-- ```{r} -->
<!-- B_j <- 1/(t(matrix(W_i))) %*% (1/C)  -->

<!-- B_j <- matrix(B_j) |> t() -->
<!-- B_j_longer <- B_j -->
<!-- colnames(B_j_longer) <- c("1","2","3") -->
<!-- B_j_longer  #|> as.data.frame()  |> gt() -->
<!-- #B_j <- colSums(known_trip_matrix)/colSums(T_unc) #our answer with knowns -->
<!-- ``` -->

<!-- And trips are: -->
<!-- ```{r} -->
<!-- B_j <- diag(B_j|> as.numeric(), nrow=3, ncol=3) -->

<!-- T_dest <-  (B_j)%*%t(T_unc) |> t() -->

<!-- W_i_dest <- T_dest |> rowSums() -->
<!-- W_j_dest <- T_dest |> colSums() -->
<!-- T_TOTAL_dest <- ifelse(sum(W_i_dest)==sum(W_j_dest), sum(T_dest), NA) -->
<!-- T_dest_longer <- cbind(T_dest,W_i_dest) -->
<!-- T_dest_longer <- rbind(T_dest_longer, cbind(t(W_j_dest),T_TOTAL_dest)) -->

<!-- rownames(T_dest_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_dest_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_dest_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->

<!-- And as we can observe, the $W_j^{(2)}$ values are equal to the known trip ends, while $W_i^{(1)}$ is not. -->

<!-- ## Doubly-constrained case -->

<!-- The parameter $k$ is replaced with both $A_i$ and $B_j$ (@eq-bf-A-gravitymodel and @eq-bf-B-gravitymodel satisfying all three constraints @eq-constraint1-gravitymodel,  @eq-constraint2-gravitymodel and implicitly @eq-constraint0-gravitymodel), the model looks as follows: -->
<!-- $$ -->
<!-- T_{ij}^{'''} = A_i B_j W_i^{(1)} W_j^{(2)} f(c_{ij}) -->
<!-- $$ -->
<!-- \where In our example, $A_i$ and $B_j$ is: -->
<!-- $$ -->
<!-- A_i = \frac{1}{\sum_j B_j W_j^{(2)} f(c_{ij})}\\ -->
<!-- B_j = \frac{1}{\sum_i A_i W_i^{(1)} f(c_{ij})} -->
<!-- $$ -->
<!-- ```{r} -->
<!-- doubly_constrained_gravity_model <- function( -->
<!--     #CREDIT: I converted the python code from (https://github.com/SadraDaneshvar/Gravity_Model) to R -->
<!--   O,  # Origin production weights vector -->
<!--   D,  # Destination attraction weights vector -->
<!--   impedance_matrix,  # the resulting travel cost impedance matrix -->
<!--   error_threshold = 0.001,  # Error threshold for stopping condition -->
<!--   improvement_threshold = 1e-6  # Improvement threshold for stopping condition -->
<!-- ) { -->

<!--   # Normalize O and D -->
<!--   sum_O <- sum(O) -->
<!--   sum_D <- sum(D) -->
<!--   cat("Checking production, attraction balancing:\n") -->
<!--   cat("Production: ", sum_O, "\n") -->
<!--   cat("Attraction: ", sum_D, "\n") -->

<!--   if (sum_O != sum_D) { -->
<!--     cat("Productions and attractions do not balance, scaling to match.\n") -->
<!--     if (sum_O < sum_D) { -->
<!--       O <- O * (sum_D / sum_O) -->
<!--     } else { -->
<!--       D <- D * (sum_O / sum_D) -->
<!--     } -->
<!--   } else { -->
<!--     cat("Production, attraction balancing OK.\n") -->
<!--   } -->

<!--   n <- length(O)  # Number of i -->
<!--   T <- sum(O)  # Total trips -->
<!--   Ai <- rep(1, n)  # Initialize Ai -->
<!--   Bj <- rep(1, n)  # Initialize Bj -->

<!--   previous_error <- Inf -->
<!--   iteration_count <- 0 -->
<!--   stop_reason <- "" -->

<!--   while (TRUE) { -->
<!--     iteration_count <- iteration_count + 1 -->

<!--     # Update Ai -->
<!--     for (i in 1:n) { -->
<!--       Ai[i] <- 1 / (sum(Bj * D * impedance_matrix[i, ]) + 1e-9) -->
<!--     } -->

<!--     # Update Bj -->
<!--     Bj_new <- rep(1, n) -->
<!--     for (j in 1:n) { -->
<!--       Bj_new[j] <- 1 / (sum(Ai * O * impedance_matrix[, j]) + 1e-9) -->
<!--     } -->

<!--     # Calculate Tij -->
<!--     Tij <- outer(Ai * O, Bj_new * D) * impedance_matrix -->

<!--     # Print Ai and Bj for this iteration -->
<!--     cat("\nIteration:", iteration_count, "\n") -->
<!--     cat("Ai:", round(Ai, 3), "\n") -->
<!--     cat("Bj:", round(Bj_new, 3), "\n") -->

<!--     # Calculate error -->
<!--     error <- (sum(abs(O - rowSums(Tij))) + sum(abs(D - colSums(Tij)))) / T -->

<!--     # Calculate change in error -->
<!--     error_change <- abs(previous_error - error) -->

<!--     # Check stopping conditions -->
<!--     if (error < error_threshold) { -->
<!--       stop_reason <- "Error threshold met" -->
<!--       break -->
<!--     } else if (error_change < improvement_threshold) { -->
<!--       stop_reason <- "Slow improvement" -->
<!--       break -->
<!--     } -->

<!--     previous_error <- error -->
<!--     Bj <- Bj_new -->
<!--   } -->

<!--   # report stopping condition and final error threshold -->
<!--   cat("\nStopping Condition: ", stop_reason, "\n") -->
<!--   cat(sprintf("Final Error: %.3f%%\n", error * 100)) -->

<!--   return(list(Ai = Ai, Bj = Bj, Tij = Tij)) -->
<!-- } -->

<!-- dc_results <- doubly_constrained_gravity_model(O=W_i, D=W_j, impedance_matrix = 1/C) -->
<!-- ``` -->

<!-- The $A_i$ and $B_j$ matrices: -->
<!-- ```{r} -->
<!-- A_i_doubly <- dc_results$Ai -->
<!-- B_j_doubly <- dc_results$Bj -->

<!-- A_i_doubly |> matrix() -->
<!-- B_j_doubly |> matrix() |> t() -->
<!-- ``` -->

<!-- The trip matrix (notice, all trip ends are equivalent to the known trip ends) -->
<!-- ```{r} -->
<!-- T_doubly <- dc_results$Tij -->

<!-- W_i_doubly <- T_doubly |> rowSums() -->
<!-- W_j_doubly <- T_doubly |> colSums() -->
<!-- T_TOTAL_dest <- ifelse(sum(W_i_doubly)==sum(W_j_doubly), sum(T_doubly), NA) -->
<!-- T_doubly_longer <- cbind(T_doubly,W_i_dest) -->
<!-- T_doubly_longer <- rbind(T_doubly_longer, cbind(t(W_j_doubly),T_TOTAL_dest)) -->

<!-- rownames(T_doubly_longer) <- c("1","2","3", "TOTAL")  -->
<!-- colnames(T_doubly_longer) <- c("1","2","3", "TOTAL") -->

<!-- T_doubly_longer |> round() #|> as.data.frame()  |> gt(rownames_to_stub=TRUE) -->
<!-- ``` -->


<!-- ## Mean absolute percentage error (MAPE) between all cases -->

<!-- ```{r} -->
<!-- #unconstrained -->
<!-- ((sum(abs(W_i_unc - rowSums(known_trip_matrix))) + sum(abs(W_j_unc - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->

<!-- #unconstrained -- rescaled! -->
<!-- W_i_unc_rescaled <- T_unc |> scales::rescale() |> rowSums() -->
<!-- W_j_unc_rescaled <- T_unc |> scales::rescale() |> colSums() -->

<!-- W_i_rescaled <- known_trip_matrix |> scales::rescale() |> rowSums() -->
<!-- W_j_rescaled <- known_trip_matrix |> scales::rescale() |> colSums() -->

<!-- ((sum(abs(W_i_unc_rescaled - W_i_rescaled)) + sum(abs(W_j_unc_rescaled - W_j_rescaled))) / T) |> scales::percent(0.01) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- #total constrained -->
<!-- ((sum(abs(W_i_tot - rowSums(known_trip_matrix))) + sum(abs(W_j_tot - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->

<!-- #singly-constrained (orig) -->
<!-- ((sum(abs(W_i_orig - rowSums(known_trip_matrix))) + sum(abs(W_j_orig - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->

<!-- #singly-constrained (dest) -->
<!-- ((sum(abs(W_i_dest - rowSums(known_trip_matrix))) + sum(abs(W_j_dest - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->

<!-- #doubly-constrained (dest) -->
<!-- ((sum(abs(W_i_doubly - rowSums(known_trip_matrix))) + sum(abs(W_j_doubly - colSums(known_trip_matrix)))) / T) |> scales::percent(0.01) -->
<!-- ``` -->

<!-- - doubly c is lowest error -->
<!-- - singly constrained error is mid -->
<!-- - total constrained has high error -->
<!-- - notably, unconstrained unscaled is obviously much higher in error - there are no constraints! But if you scale the matrices, the error is both low (interesting!! why is this?). However as mentioned, the unconstrained case is hard to interpret literally -- in what situations would k=1..?  -->


<!-- So... our dear Mac alumni Fotheringham, in the early 1980s as a fresh PhD graduate demonstrates that the gravity model is misspecified. Responding to other authors at the time saying there is a 'map pattern' left over in estimated gravity models -- he demonstrated that this residual spatial variation can be reduced by including an additional independent variable into the gravity model, accessibility at the destination! This is the 'competing destination' model. In transport modelling, the CD model is one of a few ways they address this spatial In the wake of the debate, four generalizable approaches were proposed to account for the spatial structure effect (others include: the Box–Cox transform, spatial econometric models, and eigenvector spatial filtering (ESF)). Failing to account for destination accessibility when spatial structure effects are present generally biases origin-specific distance-decay parameter estimates upwards for accessible origins and downward for inaccessible origin. The strength of this bias is shown by Fotheringham (1984) to depend on the strength of two relationships: that between the volume of flows and destination accessibility and that between destination accessibility and distance from the origin to each destination. It is this bias that causes the unintuitive spatial patterns observed in origin-specific distance-decay parameter estimates, such as positive estimates for the most accessible origins (Fotheringham, 1981) -->

<!-- So Aij is a relevant explanatory variable that can increase the accuracy of a Tij model! There's a relationship there. It makes me wonder if those spatial effects would be there if you used a constrained accessibility measure. Maybe using Aij (Hansen-type accessibility) doesn't completely solve this issue. -->
