---
title: "A family of accessibility measures derived from spatial interaction principles"
format:
  docx:
    toc: false
  plos-pdf:
    number-sections: false
    keep-tex: true
    journal:
      id: plosone
    header-includes:
      - \usepackage{float}
      - \floatplacement{table}{H}
      - \floatplacement{figure}{H}
      - \usepackage{pdflscape}
      - \newcommand{\blandscape}{\begin{landscape}}
      - \newcommand{\elandscape}{\end{landscape}}
    #include-in-header:
    #  text: |
    #    % Remove comment for double spacing
    #    % \usepackage{setspace} 
    ##    % \doublespacing
    #    % \usepackage{pdflscape}
    #    % \newcommand{\blandscape}{\begin{landscape}}
    #    % \newcommand{\elandscape}{\end{landscape}}
author:
  - name: Anastasia Soukhov
    email: soukhoa@mcmaster.ca
    affiliations:
        - name: McMaster University
          department: School of Earth, Environment & Society
          city: Hamilton, Canada
  - name: Rafael H. M. Pereira
    email: rafael.pereira@ipea.gov.br
    affiliations:
        - name: Institute for Applied Economic Research - Ipea
          department: Data Science Division
          city: Brasília, Brazil
  - name: Christopher D. Higgins
    email: cd.higgins@utoronto.ca
    affiliations:
        - name: University of Toronto Scarborough
          department: Department of Human Geography
          city: Toronto, Canada
    attributes:
        corresponding: true
  - name: Antonio Páez
    email: paezha@mcmaster.ca
    affiliations:
        - name: McMaster University
          department: School of Earth, Environment & Society
          city: Hamilton, Canada

author-notes:
  equal-contributor: These authors contributed equally to this work.
  deceased: Deceased
  group: Membership list can be found in the Acknowledgments sections

abstract: |
  Transportation planning has long prioritized the efficiency of movement, or mobility. However, the concept of accessibility represents a more comprehensive evolution, shifting focus from mere movement to the potential to reach (i.e., spatially interact) with desired destinations. Despite growing recognition of accessibility-based planning approaches, the concept remains fragmented, with inconsistent definitions and unclear interpretations. This work's aim is to clarify and unify the concept of accessibility by connecting it into spatial interaction modeling. We demonstrate that widely used mobility and accessibility models, such as gravity-based accessibility and spatial interaction models, share common theoretical roots. From this foundation, this paper offers three contributions: (A) we introduce a family of accessibility measures within the principles of spatial interaction, and (B) formally define four members of the family, namely the 'unconstrained' measure (i.e., Hansen-type accessibility), the 'total constrained' measure (i.e., a constrained version of the Hansen-type accessibility), the 'singly constrained' measure (i.e., related to the popular two step floating catchment approach - 2SFCA), and the 'doubly constrained' measure representing realized interactions or 'access', effectively equal to the doubly constrained spatial interaction model; and (C) we demonstrate the interpretability advantages of the family, as these constrained accessibility measures yield values in units of the number of potential "opportunities for spatial interaction" or "population for spatial interaction" for each zone and zonal flow. The family of accessibility measures proposed here clarifies the concept of 'potential' in accessibility, demonstrates theoretical and formulaic linkages across popular accessibility and spatial interaction models, and reintroduces measurement units into accessibility measures. By doing so, we believe this family of measures can unlock a clearer, more interpretable, and cohesive foundation for accessibility analysis. 

bibliography: bibliography.bib 
---

```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.pos = 'H', #to print figures on the line specified in knitted output
  comment = '', 
  out.width = "1\\linewidth")
```

```{r load-packages, include=FALSE, cache=FALSE}
library(bibliometrix) # Comprehensive Science Mapping Analysis
library(dplyr) # A Grammar of Data Manipulation
library(flextable) # Functions for Tabular Reporting
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggraph) # An Implementation of Grammar of Graphics for Graphs and Networks
library(glue) # Interpreted String Literals
library(gt) # Easily Create Presentation-Ready Display Tables
library(here) # A Simpler Way to Find Your Files
library(knitr) # A General-Purpose Package for Dynamic Report Generation in R
library(tidytext) # Text Mining using 'dplyr', 'ggplot2', and Other Tidy Tools
```

```{r options}
suppressMessages(library(gt))
options(gt.html_tag_check = FALSE)
```

# Introduction

<!-- SUMMARY *AND OUTLINE FOR ABSTRACT*: Transportation planning, historically, has been mobility-oriented. Accessibility, however, should be the primary focus, and institutionalized mobility-based transportation practice has treated accessibility as its proxy. This has had problematic consequences. Conceptually, accessibility is a more complete and comprehensive evolution of mobility: from movement, to the potential movement to destinations. As such, there has been recognition that the adoption of accessibility planning approaches are needed; however there are too many definitions and uncertainty in meaning of the outputs. This work's goal is to enhance interpretation of values, clarify the concept of accessibility, and unify other measures of accessibility such as the popular Hansen-type measure the 2SFCA. 

To do so, this work demonstrates that accessibility and mobility oriented models (i.e., gravity-based accessibility and the spatial interaction model) share the same roots in spatial interaction modelling, and a family of accessibility measures can be specified within the spatial interaction modelling principles. In demonstrating these developments, three significant contributions emerge: A) we demonstrate numerically how constrained accessibility can be specified, and doing so brings interpretable units to each accessibility value, units of 'number of potential opportunities for spatial interaction'. B) we provide a clarifying framework for understanding the concept of 'potential' through constraints. Namely, demonstrating accessibility's maximum potential is captured by the the 'total constraint' (constrained version of Hansen-type measure), a restricted amount of potential is captured by the 'single constraint' (i.e., competition, such as the 2SFCA), and potential is fully restricted in the 'double constraint', effectively restricting potential such that this case is equivalent to access or simply spatial interaction. C) Demonstrate how the two most popular accessibility measures, the Hansen-type measure (non-competitive) and the 2SFCA (competitive), link into the family of accessibility measures. 

In fewer words: this work makes an important contribution to accessibility literature, by providing accessibility with a more interpretable, clarified and unified definition through the introduction of constraints from spatial interaction modelling, that reintroduce units to enhance interpretability of raw values, clarify the concept of potential, and loops the most popular forms of accessibility measures into the family. -->

In the early nineteenth century, industrializing cities grew rapidly: so did traffic congestion and the development of transportation planning practice focused primarily on mobility. In this newly founded practice, access to destinations was treated as a by-product of movement. Following the rise of the automobile and significant investments in transportation infrastructure after World War II, this mobility-oriented approach has led to some problematic outcomes. Specifically, the car became seen as the ultimate mobility tool, helping to foster the development of low-density, single-use residential neighborhoods and entrenching an automobility mono-culture within transportation systems [@miller_collaborative_2011; @lavery_driving_2013]. Decades of planning for this automobility mono-culture, still often characterized by road and highway expansion, have been marked by increased travel costs and environmental burdens, with limited impact on enhancing the ease with which people can reach destinations [@farber_running_2011; @handyACCESSIBILITYVSMOBILITYENHANCING2002; @paez_healthcare_2010]. In response, transportation researchers have increasingly advocated for the adoption of accessibility as a planning criterion, in contrast to traditional mobility-oriented transportation planning approaches which translate into indicators that benchmark movement (e.g., vehicle kilometres traveled, intersection through traffic, etc.) which are not necessarily linked to improved accessibility [@silvaAccessibilityInstrumentsPlanning2017; @paez_developing_2013; @handy2020; @elgeneidyMakingAccessibilityWork2022]. 

Accessibility may be defined as the "potential of opportunities for [spatial] interaction" [@hansen1959], in contrast to mobility which is simply, movement in itself or 'spatial interaction'. Mobility has been the basis of traditional transportation planning approaches [@ortuzar_2011_modelling]. While accessibility brings a more holistic understanding of combined transportation and land use systems, incorporating both the explicit consideration of destination as opportunity and the concept of _potential_ [@handyMeasuringAccessibilityExploration1997].

The growing interest in accessibility has been accompanied by a boom in scholarly research using different methods and focusing on different research contexts; it has grown to include studies of access to employment [e.g., @karstEvaluationAccessibilityImpacts2003; @grengs2010job; @paez_jobs_2013; @merlin2017competition; @tao_investigating_2020], health care [e.g., @luo2003; @paez_healthcare_2010; @wan2012three; @delamater2013spatial; @boisjoly2017informality; @pereira_2021_geographic], green spaces [@reyesAccessibility2014; @rojas_accessibility_2016; @liang_novel_2024], schools [e.g., @williams_disparities_2014; @romanillosAccessibilitySchoolsSpatial2018; @marques_accessibility_2021], social contacts [e.g., @neutens_human_2007; @farberActivitySpacesMeasurement2012; @farber_2013_social], and regional economic analysis [e.g., @vickermanAccessibility1999; @lopezMeasuring2008; @ribeiro_road_2010; @gutierrez_evaluating_2011] among many other domains of application. In other words, accessibility analysis is used today to broadly understand the potential to reach (or spatially interact with) opportunities that are important to people [@ferreiraReenactingMobilityAccessibility2020]. However, despite its growth in popularity in scholarly works, challenges remain with respect to the more widespread adoption of accessibility in planning practice. For instance, the diversity of accessibility definitions has been flagged by van Wee [@vanweeAccessible2016], Handy [@handy2020], and Kapatsila et al. [@kapatsila_resolving_2023]. Further, difficulties in the interpretability and communicability of outputs has also been noticed by many authores, including Geurs and van Wee [@geursAccessibilityEvaluationLanduse2004], van Wee [@vanweeAccessible2016], and Ferreira and Papa [@ferreiraReenactingMobilityAccessibility2020]. 

The adoption of accessibility in planning practice is not necessarily made easier when potential adopters have to contend with a plethora of definitions, each seemingly more sophisticated but less intuitive than the last [@kapatsila_resolving_2023]. At a high level, Geurs and van Wee [@geursAccessibilityEvaluationLanduse2004] identify four families of accessibility measures: infrastructure-, place-, person-, and utility-based. Of the place-based family, which is the focus of this paper, the menu has grown to include gravity-based accessibility [e.g., @hansen1959; @pirie_measuring_1979], cumulative opportunities [e.g., @wachs_physical_1973; @pirie_measuring_1979; @ye_spatial_2018], modified gravity [e.g., @SchuurmanMeasuring2010], 2-Step Floating Catchment Areas [e.g., @luo2003], Enhanced 2-Step Floating Catchment Areas [e.g., @luoEnhanced2009], 3-Stage Floating Catchment Areas [e.g., @wan2012three], Modified 2-Step Floating Catchment Areas [e.g., @delamater2013spatial], inverse 2-Step Floating Catchment Areas [e.g., @wang_2sfca_2021], and n-steps Floating Catchment Areas [@liang_novel_2024]. How is a practitioner to choose among this myriad options? What differences in accessibility scores should matter, and how should they be communicated? [see @vanweeAccessible2016 p. 14].

Here, we seek to address the breath of place-based accessibility's definitions and lack of interpretability by demonstrating that mobility-oriented models--such as the commonly used gravity-based accessibility [e.g., @hansen1959] and the spatial interaction model [e.g., @wilson1971]-- are rooted in the same spatial interaction modeling foundation. In fact, we propose that accessibility can be specified using spatial interaction principles as a _family of measures_, akin to the family of spatial interaction models introduced in Wilson [@wilson1971] that can be defined using balancing factors that constrains values based on known information about the land-use.

This work aims to offer three contributions: (1) it introduces a family of accessibility measures within the principles of spatial interaction; (2) it formally defines three _constrained_ accessibility measures by reintroducing Wilson-analogous balancing factors. These measures are the total constrained accessibility measure, the singly constrained accessibility measure, and the doubly constrained measure, which are explicitly connected to popular measures such as the Hansen-type accessibility [@hansen1959], the popular competition approach of the 2-Step Floating Catchment Area (2SFCA) [@shenLocationCharacteristicsInnercity1998; @luo2003], and the concept of market potential [@harris_market_1954; @vickermanAccessibilityAttractionPotential1974]. These Wilson-analogous balancing factors introduced are also defined in order of increasing restrictiveness to shed light on the role of _potential_ in accessibility and access. (3) This work also demonstrates that the introduction of balancing factors makes accessibility measures easier to interpret and to communicate by restoring the measurement units to the resulting raw accessibility values. Each zonal and zonal flow value from a constrained accessibility measure is always in interpretable units, namely the number of 'opportunities for spatial interaction' or 'population for spatial interaction'. This is in contrast to conventional accessibility measures, particularly gravity based measures, that yield values in units of 'opportunities weighted by some representation of travel friction'.

<!--Motivated by the challenge of incorporating competition into a unified framework for accessibility -->To achieve these stated objectives, this paper contends that accessibility research must reconnect with its spatial interaction origins. Particularly, we argue that an important aspect of spatial interaction modelling--namely, constraining the results to match empirical observations--was never effectively reincorporated into accessibility analysis. Empirical constraints were embraced by early spatial interaction literature following the work of Wilson [@wilson1971], but this stream of literature tended to flow separately from research inspired by Hansen's [@hansen1959] accessibility. The application of Wilson's [@wilson1971] empirical constraints supported the development of various spatial interaction models that remain relevant in research and practice today [@ortuzar_2011_modelling]. However, the same cannot be said of the contemporary accessibility literature, where empirical constraints were not explicitly adopted. We argue that the absence of empirical constraints (and their attendant proportionality constants) has contributed to some of accessibility analysis' interpretability issues; for instance, the fuzziness of insights beyond simple proportional statements like 'higher-than' or 'lower-than' [@millerAccessibilityMeasurementApplication2018]. Moreover, without constraints we lose track of what accessibility measures, that is, the number of opportunities that can be spatially interacted with. Without a clear sense of measurement units, comparability between accessibility measures, across cities, and transport modes, may also become compromised.

Fortunately, accessibility and spatial interaction modelling literature share common headwaters, and the latter has given careful attention to measurement units and their interpretability. It is by looking to the past that we believe accessibility analysis can newly wade into the future. We continue this work in the following section by tracing the development of accessibility from its origins in spatial interaction: from the Newtonian gravitational expression in Eavenstein [@ravensteinLawsMigration1889] through to the seminal accessibility work of Hansen [@hansen1959]. We then present evidence for a narrative highlighting the marked divergence between accessibility and spatial interaction modelling research after the work of Wilson [@wilson1971]. Next, we hark back to Wilson's [@wilson1971] spatial interaction models, and use them to derive a family of accessibility measures based on analogous constraints. We illustrate members of this family of constrained accessibility measures with a simple numerical example. We then conclude by discussing the uses of these measure and their interpretation.

# Newtonian's roots of human spatial interaction research

<!--SUMMARY: Overview of the proportionality constant in Newton Law of Universal Gravitation - it takes the proportion relationship into one of equality. -->
The patterns of people's movement in space have been a subject of scientific inquiry for at least a century and a half. From as far back as Henry C. Carey's *Principles of Social Science* [@careyPrinciplesSocialScience1858], a concern with the scientific study of human spatial interaction can be observed. It was in this work where Carey stated that "man \[is\] the molecule of society \[and their interaction is subject to\] the direct ratio of the mass and the inverse one of distance" [@mckeanManual1883, pp. 37-38]. This statement shows how investigations into human spatial interaction have often been explicitly coloured by the features of Newton's Law of Universal Gravitation, first posited in 1687's *Principia Mathematica* and expressed as in @eq-phys-grav-prop.

$$
F_{ij} \propto \frac{M_i M_j} {D_{ij}^{2}}
$$ {#eq-phys-grav-prop}

To be certain, the expression above is one of proportionality, and is also the most famous in all of science. It states that the force of attraction $F$ between a pair of bodies $i$ and $j$ is directly *proportional* to the product of their masses $M_i$ and $M_j$, and inversely *proportional* to the square of the distance between them $D_{ij}$. Direct proportionality means that as the product of the masses increases, so does the force. Likewise, inverse proportionality means that as the distance increases, the force decreases. @eq-phys-grav-prop, however, does not quantify the magnitude of the force. To do so, an empirical constant, a.k.a. the gravitational constant, is required to convert the proportionality into an equality, ensuring that values of the force $F$ in @eq-phys-grav-prop match the observed force of attraction between masses. In other words, @eq-phys-grav-prop needs to be *constrained* using empirical data. Ultimately, the equation for the force is as seen in @eq-phys-grav, where $G$ is an empirically calibrated proportionality constant:

$$
F_{ij} = G \frac{M_i M_j} {D_{ij}^{2}}
$$ {#eq-phys-grav}

Newton's initial estimate of $G$ was based on a speculation that the mean density of earth was between five or six times that of water, an assumption that received support after Hutton's experiments of 1778 [@hutton_xxxiii_1778, p. 783]. Still, it took over a century from the publication of *Principia* to refine the estimate of the proportionality constant to within 1% accuracy, with Cavendish's 1798 experiment [@cavendish_xxi_1798].

# Early research on human spatial interaction: from Ravenstein (1889) to Stewart (1948)
<!-- 
SUMMARY: a review of spatial interaction literature from the 1880s to the 1940s. A number of researchers theoretically and empirically attempted to characterise human spatial interaction as some force of attraction $F$ that is directly proportion to the masses $Mi$ and $Mj$ and inversely proportional by their separation distance. This concept was captured with different expressions, but all tie back to the same Newtonian gravity analogy, although not all of them included a proportionality constant in their formulation.
-->
Since the 1880s to the 1940s, a number of researchers theoretically and empirically attempted to characterise human spatial interaction as some force of attraction $F$ that is directly proportion to the masses $M_i$ and $M_j$ and inversely proportional by their separation distance. This concept was captured with different expressions, but all tie back to the same Newtonian gravity analogy, although not all of them included a proportionality constant in their formulation.

Following Carey's *Principles* of 1858, research into human spatial interaction continued in different contexts. In the late 1880s, Ravenstein proposed some "Laws of Migration" based on his empirical analysis of migration flows in various countries [@ravensteinLawsMigration1885; @ravensteinLawsMigration1889]. In these works, Ravenstein posited 1) a directly proportional relationship between migration flows and the size of destinations (i.e., centres of commerce and industry), and 2) an inversely proportional relationship between the size of flows and the separation between origins and destinations. As with Carey, these propositions echo Newton's gravitational laws. Over time, other researchers discovered similar relationships. <!--Rilley does not cite Newton, nor Carey, nor Ravenstein.--> For example, Reilly [@reilly1929methods] formulated a law of retail gravitation, expressed in terms of equal attraction to competing retail destinations that could be understood as 'potential trade territories'. Later, Zipf proposed a $\frac{P_1P_2}{D}$ hypothesis for the case of information [@zipfDeterminantsCirculationInformation1946], intercity personal movement [@zipfHypothesisIntercityMovement1946], and goods movement by railways [@zipfHypothesisCaseRailway1946]. The $\frac{P_1P_2}{D}$ hypothesis stated that the magnitude of flows was proportional to the product of the populations of settlements, and inversely proportional to the distance between them.

A common feature of these early investigations of human spatial interaction is that a proportionality constant similar to $G$ in @eq-phys-grav was never considered. Of the researchers cited above, only Reilly and Zipf expressed their hypotheses in mathematical terms. Reilly's hypothesis was presented in the following form:

$$
B_a = \frac{(P_a P_T)^N}{D_{aT}^n}
$$ {#eq-reilly}

\noindent where $B_a$ is the amount of business drawn to $a$ from $T$, $P_a$ and $P_T$ are the populations of the two settlements, and $D_{aT}$ is the distance between them. Quantity $N$ was chosen by Reilly in a somewhat *ad hoc* fashion as 1, and he used empirical observations of shoppers to choose a value of $n = 2$.

Zipf, on the other hand, wrote his hypothesis in mathematical form as:

$$
C^2 = \frac{P_1 P_2}{D_{12}}
$$ {#eq-zipf}

\noindent where $C$ is the volume of goods exchanged between $1$ and $2$, $P_1$ and $P_2$ are the populations of the two settlements, and $D_{12}$ is the distance between them.

After Carey, it is in Stewart's work on the principles of demographic gravitation that we find the strongest connection yet to Newton's law [@stewartDemographicGravitationEvidence1948]. This may relate to academic backgrounds; where Stewart was a physicist while Ravenstein, Reilly, and Zipf were social scientists. Besides awareness of preceding research (he cites both Reilly and Zipf as predecessors in the analysis of human spatial interaction), Stewart appears to have been the first author to express his theorized relationships for human spatial interaction with a proportionality constant $G$, as follows:

$$
F = G\frac{(\mu_1N_1)(\mu_2N_2)}{d_{12}^2} = G\frac{M_1 M_2}{d_{12}^2} 
$$ {#eq-stewart-force}

\noindent Where:

-   $F$ is the *demographic force*
-   $N_1$ and $N_2$ are the numbers of people of in groups 1 and 2
-   $\mu_1$ and $\mu_2$ are so-called *molecular weights*, the attractive weight of groups 1 and 2
-   $M_1 = \mu_1N_1$ and $M_2 = \mu_2N_2$ are the demographic masses at 1 and 2
-   $d_{12}^2$ is the distance between $1$ and $2$
-   And finally $G$, a constant that Stewart "left for future determination" [@stewartDemographicGravitationEvidence1948, p. 34]

In addition to demographic force, Stewart defined a measure of the "population potential" of group $2$ with respect to group $1$. In other words, the potential number of people from location $2$ that could visit location $1$, as follows:

$$
V_1 = G\frac{M_2}{d_{12}}
$$ {#eq-stewart-population-potential}

For a system with more than two population bodies, Stewart formulated the population potential at $i$ as follows (after arbitrarily assuming that $G=1$): 

$$
V_i = \int\frac{D}{r} ds
$$ {#eq-stewart-population-potential-integral}

\noindent where $D$ is the population density over an infinitesimal area $ds$ and $r$ is the distance to $i$. In @eq-stewart-population-potential-integral, $D ds$ gives an infinitesimal count of the population, say $dm$, and so, after discretizing space, @eq-stewart-population-potential-integral can be rewritten as: 

$$
V_i = \sum_j M_jd_{ij}^{-1}
$$ {#eq-stewart-population-potential-sum}

Alerted readers will notice that @eq-stewart-population-potential-sum, with some re-organization of terms, is formally equivalent to our modern definition of accessibility popularized by Hansen [@hansen1959] in the late 1950s.

Stewart's formulation of demographic force, developed in the context of what he called "social physics" [@stewartPrinciples1947], was problematic. It had issues with inconsistent mathematical notation. <!--For example, in @stewartDemographicGravitationEvidence1948, $G$ is used as a proportionality constant p. 34 and then later as _demographic energy_ on p. 53.--> More seriously though, Stewart's work was permeated by a view of humans as particles following physical laws, but tinted by unscientific and racist ideas. For instance, he assumed that the molecular weight $\mu$ of the average American was one, but "presumably...much less than one....for an Australian aborigine" \[p. 35\]. Stewart's ideas about "social physics" soon fell out of favour among social scientists, but not before influencing the nascent field of accessibility research, as detailed next.

# Hansen's gravity-based accessibility to today {#grav-to-today}

<!-- SUMMARY: Stewart 1948 made an important contribution methodologically: Hansen picked it up and is now cited as the father of accessibility. However, Hansen work was applied, and he's use of Stewart's Population Potential measure included two crucial omissions that afflict the literature to this day. The first omission is 1) Stewart set the proportional constant $G$ to 1 _for future determination_, this constant is not explicitly addressed in @hansen1959 and accessibility continues to evolve without it. The second omission is 2) Stewart suggests that keeping the exponent value of $d_ij$ as 1 is sufficient. In @hansen1959, an exponent other than 1 for $d_ij$ is selected based on empirical findings, however, the issue of _opportunity potential_ units are never addressed. -->

From Stewart [@stewartDemographicGravitationEvidence1948], we arrive to 1959 and Walter G. Hansen, whose work proved to be exceptionally influential in the accessibility literature [@hansen1959]. In this seminal paper, Hansen defined accessibility as "the potential of opportunities for interaction... a generalization of the population-over-distance relationship or *population potential* concept developed by Stewart [@stewartDemographicGravitationEvidence1948]" (p. 73). As well as being a student of city and regional planning at the Massachusetts Institute of Technology, Hansen was also an engineer with the Bureau of Roads, and preoccupied with the power of transportation to shape land uses in a very practical sense. Hansen [@hansen1959] focused on Stewart's [@stewartDemographicGravitationEvidence1948] *population potential* (expressed in @eq-stewart-population-potential-sum), and not on the other formulaic contributions and objectionable aspects of "social physics". Hansen [@hansen1959] recast Stewart's population potential to reflect accessibility, a model of human behaviour useful to capture regularities in mobility patterns. Hansen [@hansen1959] replaced $M_j$ in @eq-stewart-population-potential-sum with *opportunities* to derive an *opportunity potential*, or more accurately, a *potential of opportunities for interaction* as follows:

$$
S_{i} = \sum_j \frac{O_j }{d_{ij}^\beta}
$$ {#eq-accessibility}

A contemporary rewriting of @eq-accessibility accounts for a variety of impedance functions beyond the inverse power $d^{-\beta}$:

$$
S_{i} = \sum_j O_j  f(d_{ij})
$$ {#eq-accessibility-general}

$S_{i}$ in @eq-accessibility is a measure of the accessibility from site $i$. This is a function of $O_j$ (the mass of opportunities at $j$), $d_{ij}$ (the cost, e.g., distance or travel time, incurred to reach $j$ from $i$), and $\beta$ (a parameter that modulates the friction of cost). Today, Hansen is frequently cited as the father of modern accessibility analysis [e.g., @reggianiGuestEditorialNew2011], and Hansen-type accessibility is commonly referred to as the gravity-based accessibility measure.

However, Hansen's use of Stewart's *population potential* measure included one crucial omission that afflicts the literature to this day. The omission is that between Stewart [@stewartDemographicGravitationEvidence1948] and Hansen [@hansen1959], the proportionality constant $G$ in @eq-stewart-population-potential vanished. This constant was not explicitly addressed in Hansen [@hansen1959] and accessibility research continues to evolve without it. Since Hansen [@hansen1959], accessibility analysis has been widely used in numerous disciplines but, to our knowledge, the proportionality constant has remained forgotten, with no notable developments to explicitly acknowledge or determine it. 

The omission of this constant generates a fundamental problem for the measurement unit of accessibility estimates, which undermines the interpretation, communication and comparability of accessibility analysis. Those reading Hansen [@hansen1959] must recall that Stewart [@stewartDemographicGravitationEvidence1948] had set the proportionality constant $G$ to 1, with a note that "$G$ \[was\] left for future determination: a suitable choice of other units can reduce it to unity" [p. 34]. In practice, the persistent omission of the constant in accessibility analyses means that $G$ continues to be implicitly set to $1$, even when the fundamental relationship in accessibility is proportionality (e.g., $S_{i} \propto \sum_j g(O_j)f(d_{ij})$) and not equality [for instance, see the formula for accessibility at the top of Figure 1 in Wu and Levinson [@wuUnifyingAccess2020]]. The direct consequence is that without a proportionality constant, the units of $S_i$ remain unclear: the unit of "potential of opportunity for interaction" is left free to change as $\beta$ is calibrated. For example, if $c_{ij}$ is distance in meters, it will be number of opportunities per $m^{\beta}$ when $f(c_{ij}) = d^{-\beta}$ but number of opportunities per $e^{-\beta m}$ when $f(c_{ij}) = e^{-\beta m}$. This undermines the comparability of accessibility metrics with different decay functions, and renders their results difficult to understand and communicate. The Hansen-style accessibility estimates found in the literature, therefore, are better thought of as ordinal measures of potential that can only be interpreted in terms of higher and lower accessibility, but which has not palpable meaning [@millerAccessibilityMeasurementApplication2018].

# Wilson's family of spatial interaction models

<!--SUMMARY: Introduce Wilson's spatial interaction model. Then discuss how it could relate to gravity analogy -- but is tactically derived using entropy-maximisation, obtaining the interaction variable as a statistical average. Then introduce the constraints and cases. -->

On the other side of the Atlantic, Alan G. Wilson was developing related, yet parallel work. In his groundbreaking study [@wilson1971], Wilson defined a general spatial interaction model as follows. While accessibility was characterised as an associated concept of 'potential', the primary focus was on modelling observed spatial interaction:
$$
T_{ij} = k W_i^{(1)} W_j^{(2)} f(c_{ij})
$$ {#eq-phys-gravity-model}

The model in @eq-phys-gravity-model posits a quantity $T_{ij}$ that represents a value in a matrix of flows of size $n \times m$, that is, between $i = 1,s, n$ origins and $j = 1,s, m$ destinations. The quantities $W_i^{(1)}$ and $W_j^{(2)}$ are proxies for the masses at $i=1,s,n$ origins and $j=1,s,m$ destinations. The super-indices $(1)$ and $(2)$ are meant to indicate that these masses could be different things, i.e., $W_i^{(1)}$ could be populations, and $W_j^{(2)}$ hectares of park space. Finally, $f(c_{ij})$ is some function of travel cost $c_{ij}$ which reflects travel impedance. In this way, $T_{ij}$ explicitly measures *interaction* in the unit of trips, and the role of $k$ is to ensure that the system-wide sum of $T_{ij}$ represents the total flows in the data. In other words, $k$ is a scale parameter that makes the overall amount of flows identical to the magnitude of the phenomenon being modeled. In other words, it balances the units, in a conceptually similar sense as the gravitational constant in Newton’s Law of Universal Gravitation.

Traditionally, the development of the spatial interaction model put an emphasis on the interpretability of the results [@kirbyNormalizingFactorsGravity1970; @wilsonSTATISTICALTHEORYSPATIAL1967; @wilson1971]. But instead of relying on the heuristic of Newtonian gravity (e.g., some interaction between a mass at $i$ and a mass at $j$ separated by some distance), Wilson's approach was to maximise the entropy of the system. Entropy maximisation in this case achieves stable results as a statistical average that represents the population. The approach works by assuming undifferentiated individual interactions, and assessing their probabilities of making a particular journey. The result of @eq-phys-gravity-model then is a statistical average [@wilson1971; @seniorGravityModellingEntropy1979].

To ensure that $T_{ij}$ in @eq-phys-gravity-model is in the unit of trips (our unit of origin-destination spatial interaction), additional knowledge about the system is required. At the very least, this framework assumes that the total number of trips in the system $T$ is known, and therefore:

$$
\sum_i\sum_j T_{ij} = T
$$ {#eq-constraint0-gravitymodel}

Additional information can be introduced. For example, when information is available about the total number of trips produced by each origin, $W_i^{(1)}$ is represented as $O_i$ and the following constraint can be used:

$$
\sum_j T_{ij} = O_i
$$ {#eq-constraint1-gravitymodel}

Alternatively, if there is information available about the total number of trips attracted by each destination, $W_j^{(2)}$ is represented as $D_j$ and the following constraint can be used: 

$$
\sum_i T_{ij} = D_j
$$ {#eq-constraint2-gravitymodel}

It is also possible to have information about both $O_i$ and $D_j$, in which case both constraints could be imposed on the model at once.

Using information about the system that satisfy these constraints fully, partially or not at all, a family of spatial interaction models can be derived based on @eq-phys-gravity-model. $K$ is specified depending on the applied constraint(s). In the framework introduced in Wilson [@wilson1971], three constrained versions are specified: the first being a case where to results only match the total volume of interaction, the second being a singly constrained case, and the third a doubly constrained case.

In the first, @eq-constraint1-gravitymodel and @eq-constraint2-gravitymodel do not hold. In practical terms, this means that the total number of trips predicted by the model must be equal to sum of all flows from origins i to destinations j. The balancing constant $K$ in this case is [see @cliff_evaluating_1974; @fotheringham_spatial_1984]:

$$
K=\frac{T}{\sum_i\sum_j T_{ij}}
$$ {#eq-total-flow-balancing-factor}

In the second case, only one of @eq-constraint1-gravitymodel or @eq-constraint2-gravitymodel hold. The resulting models are, in Wilson's terms, singly constrained. When only @eq-constraint1-gravitymodel holds, entropy maximisation leads to the following production-constrained model:

$$
T_{ij} = A_i O_i W_j^{(2)} f(c_{ij})
$$ {#eq-production-constrained-gravitymodel}

Notice how, in this model, the proxy for the mass at the origin $W_i^{(1)}$ is replaced with $O_i$, representing what we know about the system, the spatial interaction outbound flow, i.e., outbound trips produced at $i$. Also, there is no longer a single system-wide proportionality constant, but rather a set of proportionality constants (i.e., balancing factors) specific to origins. For this model, the balancing factors ensure that @eq-constraint1-gravitymodel is satisfied, meaning that the sum of predicted flows from one origin going to all destinations must equal the known mass at that origin $O_i$ i.e., the total number of outbound trips. Satisfying this constraint also implicitly fulfills the total constraint (@eq-constraint0-gravitymodel), since the sum of $O_i$ values across all origins equals the total number of trips. This model is useful when trips ends are unknown but the number of trips originating from each location is known and the total of these trips represents all trips in the system. The balancing factors for the production-constrained model are solved for each origin $A_i$, and according to Wilson are:

$$
A_i = \frac{1}{\sum_j W_j^{(2)} f(c_{ij})}
$$ {#eq-production-constrained-balancing-factor}

The attraction-constrained model is similar to the production-constrained model as it is also singly constrained but from the perspective of the mass at the destination. From the attraction-constrained model, the proxy for the mass at the destination $W_j^{(2)}$ is now replaced with $D_j$, representing the spatial interaction inbound flow, i.e., trips attracted at the destination and takes the following form:

$$
T_{ij} = B_j D_j W_i^{(1)} f(c_{ij})
$$ {#eq-attraction-constrained-gravitymodel}

In this model (@eq-attraction-constrained-gravitymodel), the balancing factors ensure that @eq-constraint2-gravitymodel is satisfied (hence the total constraint @eq-constraint0-gravitymodel is as well), meaning that the sum of predicted flows going to one destination from all origins must equal the known mass of that destination $D_j$ i.e., the total number of inbound trips to $j$. This should hold for all destinations. As before, destination-specific proportionality constants (i.e., balancing factors) $B_j$ were derived by Wilson as:

$$
B_j = \frac{1}{\sum_i W_i^{(1)} f(c_{ij})}
$$ {#eq-attraction-constrained-balancing-factor}

The third case in the family of spatial interaction models is the production-attraction constrained model. In this case, both @eq-constraint1-gravitymodel and @eq-constraint2-gravitymodel hold simultaneously. These constraints ensure that the sum of predicted flows from one origin to all destination, and the predicted flows going to one destination from all origins must equal the known mass of the origin $O_i$ and of the destination $D_j$. This should hold for all origins and destinations. The resulting model is, in Wilson's terms, doubly constrained, and takes the following form:

$$
T_{ij} = A_i B_j O_i D_j f(c_{ij})
$$ {#eq-doubly-constrained-gravitymodel}

In this model, both proxies for the masses are replaced with the known masses, that is, the trips produced by the origin and the trips attracted by the destination. There are now two sets of mutually dependent proportionality constants:

$$
\begin{array}{l}
A_i = \frac{1}{\sum_j B_j D_j f(c_{ij})}\\
B_j = \frac{1}{\sum_i A_i O_i f(c_{ij})}
\end{array}
$$ {#eq-doubly-constrained-balancing-factors}

Derivation of these models is demonstrated in detail elsewhere [e.g., @ortuzar_2011_modelling; @wilsonSTATISTICALTHEORYSPATIAL1967]. It is worth noting, however, that although Wilson's approach is built on a different conceptual foundation than the old reference to Newtonian gravity, the work succeeded at identifying the steps from proportionality to equality to yield variations of proportionality constants, including the one that eluded Stewart [@stewartDemographicGravitationEvidence1948] and that has been overlooked in almost all subsequent accessibility research. Why was this key element of spatial interaction models potentially ignored in accessibility research? In the next section we aim to address this question.

# Accessibility and spatial interaction modelling: two divergent research streams

<!--
SUMMARY: Accessibility developed separate from SIM.

SIM focuses on trips and was institutionalized to develop the US Interstate highway systems. Many guidelines and practical training was done - a lot of funding. SIM development has integrated accessibility in a few ways: 1) within the SIM itself as a balancing factor, 2) as an additional independent variable in the SIM, 3) SIM and HAM in parallel in the context of location allocation problems and within the steps of transportation demand modelling (trip distribution or trip generation). 

Accessibility research has separated SIM almost entirely. When Wilson is cited: 1) typically when using a different impedance function, 2) when using the SIM to predict trip flows for accessibility input or vice versa, 3) a few exceptional papers that interpret the doubly-constraints as an inverse HAM in the context of competitive accessibility, and 4) it was only until recently, that a singly-constrain was introduced in Soukhov et al. 2023. -->

```{r}
#| label: load-data

load(glue::glue(here::here(),
                "/data/corpus.rda"))
```

```{r}
#| label: calculate-cocMatrix
#| cache: true

# $A$ is a sparse adjacency matrix with sources cited by each document in the corpus
A <- cocMatrix(corpus, 
               Field = "CR", 
               sep = ";")
```

```{r}
#| label: coupling-matrix

# The product of $A$ and its transpose gives the bibliographical coupling by cited references $B = A A^T$

# $B$ is a square symmetric matrix where element $b_{ij}$ is the total number of cited references in common between document $i$ and document $j$. A higher value of $b_{ij}$ indicates a stronger relationship between documents $i$ and $j$ (more references in common). A value of zero indicates no references in common.
B <- tcrossprod(A)
```

```{r}
#| label: clean-coupling-matrix

# Remove the diagonal (papers cited within a single source)
B_nd <- B - Matrix::band(B, 0, 0)
```

```{r}
#| label: create-coupling-network

#These matrices are sparse symmetric matrices of "adjacencies" between documents in the corpus. Convert `B` to an `igraph` network without the diagonal
coupling_net <- igraph::graph_from_adjacency_matrix(B, 
                                            mode = "directed", 
                                            weighted = TRUE,
                                            diag = FALSE)
```

```{r}
#| label: remove-A-memory

rm(A)
```

```{r}
#| label: convert-to-tidygraph

# For convenience, convert the [{igraph}](https://r.igraph.org) object to a [{tidygraph}](https://www.data-imaginist.com/posts/2017-07-07-introducing-tidygraph/) object:
coupling_net <- tidygraph::as_tbl_graph(coupling_net)
```

```{r}
#| label: add-corpus-label-to-coupling-network

# Add the `corpus` variable to `coupling_net`. Remember to activate the nodes.
coupling_net <- coupling_net |>
  tidygraph::activate("nodes") |>
  left_join(tibble::rownames_to_column(corpus, 
                                       var = "rowname") |> 
              transmute(rowname, 
                        corpus = corpus),
            by = c("name" = "rowname"))
```

```{r}
#| label: corpus-summary

summary_coupling_network <- coupling_net |>
  tidygraph::activate("nodes") |>
  as_tibble() |>
  mutate(corpus = factor(corpus)) |>
  group_by(corpus) |>
  summarize(n = n())

# Number of documents in each corpus
# Hansen
n_h <- summary_coupling_network |> 
  filter(corpus == "Hansen") |> 
  pull(n)
# Wilson
n_w <- summary_coupling_network |> 
  filter(corpus == "Wilson") |> 
  pull(n)
# Both
n_b <- summary_coupling_network |> 
  filter(corpus == "Both") |> 
  pull(n)
```

The work of Hansen [@hansen1959] and Wilson [@wilson1971] responded to important developments, in particular a need "to meet the dictates and needs of public policy for strategic land use and transportation planning" [@battyChronicleScientificPlanning1994]. These dictates and needs were far from trivial. In the United States alone, the Federal-Aid Highway Act of 1956 authorized the creation of the U.S. Interstate Highway System, with a budget that ultimately exceeded one hundred billion dollars (equivalent to over $600 billion in 2023) [@weinerUrbanTransportationPlanning2016; @mdotMnDOTJoins2007]. Spatial interaction modelling was incorporated into institutional modelling practices meant to "predict and provide", i.e., predict travel demand and supply transportation infrastructure [@kovatch1971modeling; @weinerUrbanTransportationPlanning2016]. Accessibility, at the time, did not quite have that power, as it did not quantify trips, but rather something somewhat more elusive: it predicts the less tangible "potential" for spatial interaction with opportunities. In this way, where spatial interaction modelling became a key element of transportation planning practice, accessibility remained a somewhat more academic pursuit, and the two streams of literature only rarely connected.

```{r}
#| label: plot-docs-per-year
#| include: false

docs_per_year_plot <- ggplot(data = corpus |> 
         group_by(corpus, PY) |> 
         summarize(n = n()),
         .groups = "drop") + 
  geom_col(aes(x = PY, 
               y = n,
               fill = corpus),
           color = "black") + 
  xlab("Publication year") + 
  ylab("Number of documents") +
  theme_minimal()

ggsave(filename = glue::glue(here::here(), 
                             "/figures/docs_per_year_plot.png"))
```

```{r}
#| label: fig-docs-per-year
#| out-width: 70%
#| fig-cap: "Historical pattern of publication: documents per year."

docs_per_year_plot
```

To illustrate this point, we conducted a bibliographic analysis of the literature that cites Hansen [@hansen1959], Wilson [@wilson1971], or both. We retrieved all relevant documents using the Web of Science "Cited References" functionality, and the digital object identifiers of Hansen [@hansen1959] and Wilson [@wilson1971]. As a result of this search, we identified `r n_h |> prettyNum(big.mark = ",")` documents that cite Hansen [@hansen1959], only `r n_w |> prettyNum(big.mark = ",")` documents that cite Wilson [@wilson1971], and `r n_b |> prettyNum(big.mark = ",")` that cite both. The earliest document in this corpus dates to `r min(corpus$PY)` and the most recent is from `r max(corpus$PY)`. The number of documents per year appears in @fig-docs-per-year, where we see the frequency of documents over a span of almost fifty years. In particular, we notice the remarkable growth in the number of papers that cite Hansen [@hansen1959] compared to those that cite Wilson [@wilson1971] since the year 2000.

As noted, literature that cites both Wilson [@wilson1971] and Hansen [@hansen1959] are sparse (only `r (n_b / (n_b+n_h+n_w) )|> scales::percent(0.1)` of the corpus, visualised in pink in @fig-docs-per-year). After reading the works, we can also discern that they too are divergent, with one stream focused on developing accessibility (i.e., *potential for* spatial interaction) and another on spatial interaction. The focuses of these divergent streams contribute this paper's broader hypothesis that the concepts of accessibility and spatial interaction have remained largely disconnected, and at times, improperly conflated. 

On one hand, the stream of literature focused on spatial interaction models inspired by Wilson [@wilson1971] and which cite both Hansen [@hansen1959] and Wilson [@wilson1971], tends to contribute to understanding how accessibility is interpreted and incorporated in spatial interaction models. These works treat separate spatial interaction and accessibility as a seperate but related phenomenon. Specifically, some early works interpret the spatial interaction model's balancing factors (@eq-production-constrained-balancing-factor or @eq-doubly-constrained-balancing-factors) as the inverse of Hansen's [@hansen1959] model [@harrisEquilibriumValuesDynamics1978; @leonardiOptimumFacilityLocation1978; @fotheringhamSPATIALSTRUCTUREDISTANCE1981; @fotheringhamSpatialCompetitionAgglomeration1985], recognizing it as a "common sense" approach [@morrisAccessibilityIndicatorsTransport1979, p. 99] to including accessibility in the spatial interaction model, though further exploration of its relationship is warranted [@battyMethodResiduesUrban1976]. Some authors have explored this relationship, for instance as in Fotheringham [@fotheringhamSpatialCompetitionAgglomeration1985] who demonstrates how the spatial interaction model may insufficiently explain spatial patterns, and suggests that explicitly defining destinations' accessibility as a variable within the model may remedy the issue (e.g., the *competition destination* model). Other works used both Hansen [@hansen1959] and Wilson's [@wilson1971] framework in conjunction, such as in defining location-allocation problems in operations research [@leonardiOptimumFacilityLocation1978; @beaumontLocationallocationProblemsPlane1981], estimating trip flows (or some other spatial interaction flows) alongside accessibility [e.g., @clarke2002deriving; @grengs2004measuring; @turk2019socio], or considering accessibility within spatial interaction models, in line with Fotheringham's [@fotheringhamSpatialCompetitionAgglomeration1985] demonstration [e.g., @beckers2022incorporating]. Other works departed from Hansen's [@hansen1959] definition and aligned with spatial interaction in different ways, such as using micro-economic consumer behaviour concepts to express potential for spatial interaction [@morrisAccessibilityIndicatorsTransport1979; @leonardiRandomUtilityDemand1984].

<!-- rafa 1: no need to keep all references in each citation block. AS: I'll keep them for now. -->

<!-- rafa 2: no need to keep all references in each citation block. AS: I'll keep them for now. -->

On the other hand, there is another subset of literature that cite both Hansen [@hansen1959] and Wilson [@wilson1971] that is accessibility-focused. We categorise their citation of Wilson [@wilson1971] for three general reasons. Firstly, a group of these works cite Wilson [@wilson1971] as attribution for using context-dependent travel cost functions [e.g., @weibullNumericalMeasurementAccessibility1980; @handyMeasuringAccessibilityExploration1997; @kwan1998space; @shenLocationCharacteristicsInnercity1998; @ashiru2003space; @rau2012spatial; @pan2013impacts; @margaridacondecomelhoradoImpactMeasuringInternal2016; @caschili2015accessibility; @grengs2015nonwork; @pan2020measuring; @chia2020extending; @roblot2021participation; @sharifiasl2023incorporating; @kharel2024examining]. These works do not necessarily comment on spatial interaction explicitly. Secondly, another group of this accessibility-focused "both" citing literature _does_ associate spatial interaction as defined in Wilson [@wilson1971] with accessibility's potential for spatial interaction more explicitly [e.g., @millerMeasuringSpaceTimeAccessibility1999; @giuliano2010accessibility; @grengs2010intermetropolitan; @grengs2010job; @grengs2012equity; @levine2012does; @levinson2012positive; @tong2015transportation; @liu2015spatial; @he2017measuring; @wuUnifyingAccess2020; @ng2022reflection; @naqavi2023mobility; @suel2024measuring]. We agree accessibility and spatial interaction are related topics: accessibility is an expression of its *potential* and the Wilson [@wilson1971] paper briefly touches on the concept. However, in some of this literature, Hansen [@hansen1959] and Wilson [@wilson1971] are co-cited as both being 'gravity models' [e.g., @liu2004accessibility; @dai2017visualization; @shen2019segregation; @chia2020extending], perhaps revealing the murkiness of the distinction between spatial interaction and the *potential for* spatial interaction in the literature. Thirdly, there is a group of accessibility-focused works that interpret Hansen's [@hansen1959] model as the singly- or doubly- constrained spatial interaction model's inverse balancing factor [e.g., @vickermanAccessibilityAttractionPotential1974]. This group cities the earlier spatial interaction works that make this connection and is especially prominent in the investigation of competitive accessibility topics [e.g., @karstEvaluationAccessibilityImpacts2003; @geurs2006accessibility; @willigers2007accessibility; @el2011place; @curtis2010planning; @manaugh2012makes; @chen2013regional; @alonso2014labour; @albacete2017measuring; @sahebgharani2019computing; @mayaud2019future; @allenMeasureCompetitiveAccess2020; @levinsonGeneralTheoryAccess2020; @marwal2022literature; @su2023untangling]. As outlined in preceding sections, we argue interpreting the singly- or doubly- constrained spatial interaction model's balancing factor as accessibility yields output values that are similarly plagued by interpretability issues. 

Lastly, as an extension of the third reason within this group, only the works of Soukhov et al. [@soukhovIntroducingSpatialAvailability2023; @soukhovMultimodalSpatialAvailability2024] use Wilson's [@wilson1971] balancing factors as a method for maintaining constraints on opportunities within the context of competitive accessibility. These works introduce the balancing factors as a mechanisms to ensure that opportunities at each destination are proportionally allocated to each zone (based on the proportion of population seeking opportunities and the relative travel impedance). This is to ensure that each zonal accessibility value is the sum of this proportional allocation from each destination, and that all zonal values ultimately sum to the total number of opportunities in the region. However, these balancing factors were deduced intuitively. These works do not explicitly state that the mathematical formulation of the equations are effectively equivalent to Wilson’s singly constrained model (derived from entropy maximization). This equivalence is only discovered in hindsight, as will be demonstrated in this study. These two works also do not discuss other constrained cases that will be addressed in the next section.

# A family of accessibility measures

In this section, we introduce a family of accessibility measures inspired by Wilson's spatial interaction modelling framework. At the end of this section, Table 1 presents a summary, where each member of the family of accessibility measure is explained in plain language, alongside their balancing factor, proportional allocation factor and mathematical equation and value interpretations.

As argued in the preceding section, the streams of research on accessibility and spatial interaction modelling have evolved as largely separate streams with little contact since Hansen [@hansen1959] and Wilson [@wilson1971]. This may explain why the constraints and associated balancing factors of spatial interaction models did not cross over to accessibility analysis. This is intriguing since Wilson made an effort to connect developments in spatial interaction modelling to accessibility, noting for instance, the denominator of the proportionality constants specific to origins (@eq-production-constrained-balancing-factor) is the inverse of balancing factor $A_i$ [@wilson1971 p. 10]:

$$
S_i = \frac{1}{A_i} = \sum_j W_j^{(2)} f(c_{ij})
$$ {#eq-Ai-as-accessibility}

Understanding $S_i$ as the inverse of Wilson's $A_i$ does not uncover any new meaning for $S_i$ itself. Indeed, mathematically it is true, $A_i$'s role in Wilson's general model $T_{ij} = k W_i^{(1)} W_j^{(2)} f(c_{ij})$ is that of a balancing factor $k$ i.e., keeping units balanced and proportionality based on constraints. Understanding $S_i$ itself as a balancing factor is not wholly helpful as Hansen and (Stewart before him) defined accessibility as a partial sum of the demographic force $F$ or the system-wide population potential of opportunities for spatial interaction (i.e., @eq-stewart-population-potential-sum representing $V_i = \sum_j \frac{M_j}{d_{ij}}$ after losing $G$).

Hence, we propose stepping back to introduce a revised definition of accessibility: the _constrained_ potential for spatial interaction. Once we bring back Wilson's proportionality constant $k$ into the picture, we can define the *potential for spatial interaction* between two locations $i$ and $j$ is as follows:

$$
V_{ij} = k W_j^{(2)} f(c_{ij})
$$ {#eq-access-01}


\noindent where $V_{ij}$ is the potential for interaction from $i$ to $j$. The accessibility from origin $i$ can then be summarised as as a partial sum of the potential at $i$:

$$
V_{i} = k \sum_j W_j^{(2)} f(c_{ij})
$$ {#eq-accesssibility-01}

Similar to @eq-phys-gravity-model, $W_j^{(2)}$ above is the mass at the destination and the sub-indices are for $i = 1,s, n$ origins and $j = 1,s, m$ destinations.

The market potential variant can also be generally defined, which is effectively the transpose of $i$ and $j$ in @eq-access-01 and @eq-accesssibility-01 as follows:
$$
M_{ji} = k W_i^{(1)} f(c_{ij})
$$ {#eq-market-01}

$$
M_{j} = k \sum_j W_i^{(1)} f(c_{ji})
$$ {#eq-market-potential-01}

Similar to @eq-phys-gravity-model, $W_j^{(2)}$ above is the mass at the destination and the sub-indices are for $i = 1,s, n$ origins and $j = 1,s, m$ destinations.

To detail the anatomy of $V_{ij}$ and $M_{ji}$ along with the partial sums of $V_i$ and $M_j$, Figure @fig-analytical-device-conc-accessibility illustrates the accessibility analytical framework we propose using a simple 3 zone system. Each measure's most disaggregate value is $X_{ij}$, potential for spatial interaction from $i$ to $j$. The $X$ is a stand in for the $ij$ values of all the cases and their variants that will be described (i.e., $V_{ij}^0, M_{ji}^0, V_{ij}^T, M_{ji}^T, V_{ij}^S, M_{ji}^S$ and $V_{ij}^D, M_{ji}^D$). The single marginals represent the origin-side and destination-side weights of the zones. The total marginal represent the sum of a single marginal. 

```{r}
#| label: fig-analytical-device-conc-accessibility
#| out-width: 70%
#| fig-cap: "The family of accessibility measures analytical framework: labelling and associating ij flows, zonal weights, the single marginals, and the total marginal."

knitr::include_graphics(glue::glue(here::here(),
                                   "/figures/access-analytical-device.png"))
```

As an additional overview, we define four distinct members of the constrained accessibility measure family, all delineated based on their constant $k$, which takes the form of either balancing factors $K^T$, $B_j$, $A_i$ depending on the indicator:

1. **The unconstrained case** with variants $V_i^0$ and $M_i^0$. This case is equivalent to Hansen's [@hansen1959] formulation (first variant) and Reilly's [@reilly1929methods] market potential formulation (second variant), whereby a balancing factor is neglected, so units of zonal values are in units of 'opportunities-by-travel-impedance-value' and 'population-by-travel-impedance-value'. In this case, no constraints are introduced to ensure that values of marginals are preserved.

2. **The total constrained case** with variant $V_i^T$ and variant $M_j^T$. The first variant $V_i^T$--the _total constrained accessible opportunities measure_--resembles Hansen's [@hansen1959] formulation but with an additional regional balancing factor $K^T$ term, defined as the ratio of the total number of opportunities in the region to the total sum of unconstrained accessibility values in the region. In this way, $K^T$ ensures that each zonal accessibility value is a proportion of the total opportunities in the region (i.e., the total marginal in @fig-analytical-device-conc-accessibility), requires no information about the population seeking opportunities, and is in units of 'opportunities' accessible. The second variant $M_j^T$ is the transpose of $i$ to $j$ of the first variant, effectively a constrained version of market potential and is referred to as _total constrained accessible population measure_. In this variant, each zonal accessibility value is a proportion of the total population in the region (maintained by $\hat K^T$), requires no information about the opportunities that are sought, and each zonal value is in units of 'population' accessible. 
  - When conceptualising _potential_ for spatial interaction--whether with opportunities or population--the total constrained case reflects the lowest level of restriction and hence maximum potential. The balancing factors $K^T$ and $\hat K^T$ only ensure that $V_{ij}^T$ and $M_{ji}^T$ values end up matching the _total sum_ of one of the single marginals, not the individual marginals themselves. For example, $K^T$ does not guarantee that all the opportunities accessibility at $V_{i=1}^T$ reflect a proportional allocation of the destination mass (i.e., _number_ of opportunities) at $j=1, 2, 3$. In some cases, an allocation of opportunities from a destination $j$ to $i=1$ could _exceed_ the number of opportunities at that $j$ (i.e., meaning that destination $j$ is very attractive and reachable for an $i$, relative other flows in the region). However, what $K^T$ _does_ ensure is that each $V_{ij}^T$ does not exceed the overall number of opportunities in the region--the total marginal. In other words, $V_{i=1}^T$ expresses the number of opportunities that origin $i=1$ could potentially interact with, as drawn from the entire regional opportunity mass, rather than constrained by individual destination totals. In this way, the _total constrained_ case reflects the maximum amount of _potential_ while still maintaining interpretable units. 
  
3. **The singly constrained case**, with two variants $V_i^S$ (opportunity-constrained) and $M_j^S$ (population-constrained). The first variant is mathematically equivalent to the spatial availability measure [@soukhovIntroducingSpatialAvailability2023], and this variant's per capita form is equivalent to the popular 2SFCA measure [@luo2003; @shen1998]. Both variants can also be defined using either Hansen's [@hansen1959] or the market potential formulation but with balancing factor $B_j$ for $V_i^S$ or $A_i$ for $M_j^S$. These balancing factors ensure that the total marginal (green box in @fig-analytical-device-conc-accessibility) is maintained _as well as_ the values at one of the single marginals (destination-mass marginal for opportunity-constrained and origin-mass marginal for population constrained in @fig-analytical-device-conc-accessibility). In this way, the singly constrained case reflects a medium amount of potential, restricted by either values fitting the single destination-mass marginal or the single origin-mass marginal. 
  - The first variant $V_i^S$ includes a set of destination-side balancing factors $B_j$ which ensure opportunities (or destination masses) are allocated to each origin $i$ based on the population (i.e, origin mass) of the origin $i$ and travel impedance from that $j$ to all $i$s. Hence, $B_j$ ensures that each $V_i^S$ is the product sum of a _proportional share_ of opportunities allocated from each destination $j$ implicitly also being a share of the total opportunities in the region. Similar to the total constrained case, each $V_i^S$ and $V_ij^S$ accessibility value is expressed in units of 'opportunities' accessible. But unlike the total constrained case, the singly constrained case explicitly incorporates population by allocating a balanced share of a destination's total opportunities to populations at reachable origins.
  - The second variant $M_j^S$ includes a set of opportunity-side balancing factors $A_i$ which ensure population (or origin masses) are allocated to each destination $j$ based on the destination mass of the destination $j$ and all possible travel impedance from that $i$ to all $j$s. $A_i$ ensures similar, but transposed, so constraints are satisfied. Specifically, each $M_j^S$ represents both a share of the total regional population and the sum of balanced proportions of population from all origins, allocated to each destination based on the opportunities sought and travel impedance. Each zonal value is expressed in units of 'population' accessible.
  
4. **The doubly constrained case**. It is constrained simultaneously by population (origin masses) and opportunities (destination masses), so each $V_{ij}^D$ (equivalent to $M_{ji}^D$) is expressed in units of 'population-opportunity capacity' that is accessible between $i$ to $j$. This case requires the number of opportunities and population to match, e.g., the analyst must know the matching spatial interaction capacity of the population (demand) and opportunities (supply). By using this one-to-one matching data and the double constraints (i.e., $A_i$ and $B_j$ at once, ensuring both the double constraint maintains both marginals in @fig-analytical-device-conc-accessibility), this case restricts the _potential_ to spatially interact completely. In other words, the doubly constrained accessibility values reflect the number of predicted interactions between the opportunities and population, effectively, this case is equivalent formulaically as Wilson's doubly constrained spatial interaction model (i.e., _attraction-production constrained_). It can be understood as predicting a value of 'access', and not accessibility. 

And as a summary: each member of the family of accessibility measure is named, explained in plain language, alongside their balancing factor(s), proportional allocation factor(s), and mathematical equation and value interpretations in Table 1.

`\blandscape`{=latex}

::: {=latex}
\input{summary-family-access-measures-table.tex}
:::
Table 1: Summary of constrained accessibility measure types and interpretations

`\elandscape`{=latex}

## Setup of the simple numeric example

```{r}
#| label: simple-numerical-example-opportunities-and-population
id <- c("1", "2", "3")
O_i <- c(4, 10, 6) 
D_j <- c(160, 150, 180)
LU <- data.frame(id, O_i, D_j)
```

Consider a simple region as shown in @fig-analytical-device-conc-accessibility, with zone IDs 1, 2 and 3. Each zone is both an origin $i$ and a destination $j$. The following three pieces of information are defined: zonal population and opportunities, zonal cost matrix, and travel impedance functions for three types of travel behaviour. In this example, the population are people, the opportunities are physicians, and the region can be described by three possible travel behaviours.

Firstly, @tbl-small-system-land-use summarises the population (in units of 10,000s of people) and the opportunities (the number of physicians) per zone. For reference, considering @tbl-small-system-land-use's values, the Provider-to-Population-Ratio (PPR) in this system is `r sum(LU$D_j) / sum(LU$O_i)`. The number of physicians per 10,000 in Canada in 2022 was 24.97 [@whoMedicalDoctors102025]. Secondly, to pair the zonal population and opportunity information, the assumed cost of movement (in minutes of travel time) between origins and destinations is as shown in @tbl-small-system-cost. 

```{r}
#| label: tbl-small-system-land-use
#| tbl-cap: "Simple system with three zones (ID 1, 2 and 3). Population is in 10,000 persons and opportunities in number of physicians."

LU |>
  gt() |>
  # tab_spanner("{{W[_i^(1)]}}",
  #             columns = 2) |>
  # tab_spanner("{{W[_j^(2)]}}",
  #             columns = 3) |>
  cols_label(id = "ID (i or j)",
             O_i = "Population", 
             D_j = "Opportunities")  |>
  cols_align(align = "center",
             columns = 2:3) |>
  tab_footnote(footnote = md("Population is *Wi^(1)^* when used as a proxy for the mass at the origin, and *Oi* when used as a constraint."),
               locations = cells_column_labels(columns = O_i)) |>
  tab_footnote(footnote = md("Opportunities is *Wj^(2)^* when used as a proxy for the mass at the destination, and *Dj* when used as a constraint."),
               locations = cells_column_labels(columns = D_j)) |>
  tab_options(table.font.size = px(10))|>
  as_latex()
```

```{r}
#| label: simple-numerical-example-cost

C <- expand.grid(oid = c("1", "2", "3"),
                  did = c("1", "2", "3")) |>
  mutate(cost = c(10, 30, 15, 30, 10, 25, 15, 25, 10)) |>
  mutate(f1 = cost^-3,
         f2 = cost^-2,
         f3 = cost^-0.1)
```

```{r}
#| label: tbl-small-system-cost
#| tbl-cap: "Cost matrix for system with three zones (travel time in minutes)."

C |> 
  select(oid, did, cost) |>
  tidyr::pivot_wider(names_from = did, values_from = cost) |>
  gt() |>
  tab_spanner(label = "Destination ID",
              columns = 2:4) |>
  cols_label(oid = "Origin ID")  |>
  cols_align(align = "center",
             columns = 2:4) |>
  tab_options(table.font.size = px(10))|>
  as_latex()
```

From both @tbl-small-system-land-use and @tbl-small-system-cost, Zone 3 and 1 can be interpreted as of an urban core with major healthcare institutions and a healthcare cluster on the edge of the city respectively, each with a moderate residing population (with zone 3 having both a higher population and physician count). Zone 2, can be interpreted as a more distant bedroom community, with a relatively high population and fewer physicians. In sum, Zones 1 and 3 are more proximate to each other than to Zone 2, and together match Zone 2’s population while offering more than twice the physician availability.

And lastly, in @eq-travel-behaviour-scenarios we distinguish accessibility measure values for the following three impedance functions that represent the potential for spatial interaction travel behaviour of the population to opportunities. Accessibility will be calculated three times for each case, one assuming the most decay ($f_1(c_{ij})$), another assuming medium decay ($f_2(c_{ij})$), and a third assuming the least decaying travel behaviour ($f_3(c_{ij})$) for the entire region. A helpful analogy may be tying travel behaviour to the used mode's mobility potential, i.e., the most decaying travel behaviour ($f_1(c_{ij})$) would assume all travel in the region being done by foot, while calculating accessibility assuming the least decay ($f_3(c_{ij})$) would assume unfettered automobility. Or alternatively, these functions could represent travel behaviour on snowstorm-affected day ($f_1(c_{ij})$) for the entire region versus a clear, ideal travel day ($f_3(c_{ij})$). As an example of a discussion on how travel behaviour has been considered in accessibility measures cost of travel see Páez et al. [@paez2012measuring].

$$
\begin{array}{l}
f_1(c_{ij}) = \frac{1}{c_{ij}^3}\\
f_2(c_{ij}) = \frac{1}{c_{ij}^2}\\
f_3(c_{ij}) = \frac{1}{c_{ij}^{0.1}}
\end{array}
$$ {#eq-travel-behaviour-scenarios}

Any set of concepts representing population, opportunities, and their associated travel behaviour, whether representing the entire region uniformly (as we will demonstrate) or representing specific subgroups, can be substituted into our simple example, depending on the research question. The purpose of the following simple example is to demonstrate the calculation of each member of the accessibility measure family, interpret the values, and compare them both within and across travel behaviour groups and members of the family of accessibility measures.

## Unconstrained accessibility

Setting the balancing factor $k$ to 1 or omitting it completely in @eq-access-01 results in the unconstrained accessibility case:

$$
V^0_{ij} = 1 *W_j^{(2)} f(c_{ij})
$$ {#eq-unconstrained-access}

In this case, the partial sum of spatial interaction is simply identical to Hansen's accessibility $S_i$ [@hansen1959], the current standard practice in accessibility measurement:

$$
V^0_i = \sum_j V^0_{ij} = \sum_j W^{(2)}_jf(c_{ij}) = S_i
$$ {#eq-unconstrained-accessibility}

The sum of the unconstrained accessibility values for each origin $V^0_{i}$ generally does not equal the total number of opportunities $O$ (e.g., $\sum_i V^0_{i} \not= O$), since arbitrarily setting $k$ to 1 (or neglecting $k$ all together) strips the values of any meaningful unit-based interpretation, the units are in 'summed opportunities by some travel impedance value'. Moreover, comparisons of these $V^0_{i}$ values across different contexts such as different impedance functions $f(c_{ij})$ or varying number of zones exacerbates this issue as the units between $V^0_{i}$ values change i.e., comparisons between a value of 'summed opportunities by a travel impedance value' to a value of 'summed opportunities by another travel impedance value' are not directly interpretable. From this perspective, the raw unconstrained accessibility scores are not intuitively comparable across different contexts and decay functions. They should more appropriately be used as an ordinal variable to make comparisons of size (i.e., greater than, less than, equal to), not to calculate ratios or intervals (i.e., the magnitude of differences).

Returning to our numeric example, the calculated unconstrained accessibility $V^0_{i}$ for each origin, a sum of all the travel impedance weighted opportunities at each destination ($\sum_i V^0_{i}$), in displayed in @tbl-simple-example-unconstrained-accessibility.

```{r}
#| label: simple-numerical-example-OD-table

OD <- C |>
  left_join(LU |>
              select(-D_j),
            by = c("oid" = "id")) |>
  left_join(LU |>
              select(-O_i),
            by = c("did" = "id"))

```

```{r}
#| label: tbl-simple-example-unconstrained-accessibility
#| tbl-cap: "Simple system: unconstrained accessibility."

unc_acc_ij <- OD |>
  group_by(oid) |>
  reframe(V_unc_ij_1 = D_j * f1,
          V_unc_ij_2 = D_j * f2,
          V_unc_ij_3 = D_j * f3)

unc_acc <- unc_acc_ij |>
  group_by(oid) |>
  summarize(V_unc_i_1 = sum(V_unc_ij_1),
            V_unc_i_2 = sum(V_unc_ij_2),
            V_unc_i_3 = sum(V_unc_ij_3))


unc_acc |>
  gt(rowname_col = "oid") |>
  tab_stubhead(label = "Origin") |>
  tab_spanner(label = "{{V[_i^0]}}",
              columns = 2:4,
              level = 2) |>
  tab_spanner(label = "{{f_1 (c_ij ) = 1/c[_ij^3]}}", 
              columns = 2,
              level = 1) |>
  tab_spanner(label = "{{f_2 (c_ij ) = 1/c[_ij^2]}}",
              columns = 3,
              level = 1) |>
  tab_spanner(label = "{{f_3 (c_ij ) = 1/c[_ij^0.1]}}",
              columns = 4,
              level = 1) |>
  fmt_number(decimals = 3) |>
  # cols_label(V_unc_i_1 = md("units: *f<sub>1</sub>(c<sub>ij</sub>)-weighted physicians*"),
  #            V_unc_i_2 = md("units: *f<sub>2</sub>(c<sub>ij</sub>)-weighted physicians*"),
  #            V_unc_i_3 = md("units: *f<sub>3</sub>(c<sub>ij</sub>)-weighted physicians*"),
  #            .fn = md)  |>
  cols_label(V_unc_i_1 = md("units: *physicians-minute^-3*"),
             V_unc_i_2 = md("units: *physicians-minute^-2*"),
             V_unc_i_3 = md("units: *physicians-minute^-0.1*"),
             .fn = md)  |>
  cols_align(align = "center",
             columns = 2:4) |>
  #cols_width(
  #  stub() ~ px(60),
  #  everything() ~ px(180)
  #) |>
  grand_summary_rows(
    columns = c(V_unc_i_1, V_unc_i_2, V_unc_i_3),
    fns = list(label = "Sum", fn = "sum")) |> 
  tab_options(column_labels.font.size = "small",
              table.font.size = px(8)) |>
  as_latex()
```

As the different impedance functions represent different travel behaviours, comparing the raw unconstrained accessibility values across groups is meaningless beyond notions of higher or lower. For instance, at zone 1 the difference between the least decay ($f_3(c_{ij})$) and most decay ($f_1(c_{ij})$) groups is `r round(unc_acc$V_unc_i_3[1] - unc_acc$V_unc_i_1[1], 2)`, but in what units? These two values are a product of different impedance functions, making the comparison uninterpretable in absolute terms. Likewise, we could compare values within the same travel behaviour scenario across different zones, as they are in the same units, however the issue of unit interpretability will also be apparent. Considering the most decaying scenario $f_1(c_{ij})$ and zone 1 (the zone with a healthcare cluster at the edge of the city): zone 1 captures `r unc_acc$V_unc_i_1[3] - unc_acc$V_unc_i_1[1]` fewer physicians-minute$^{-1}$ than zone 3 (urban core). Again, the fundamental uninterpretability of what is a _physicians-minute$^{-1}$_ or _opportunity-weighted-travel-impedance_ unit remains. 

While one could attempt to adjust the units post-calculation (e.g., scaling, population normalization) or select impedance functions to facilitate comparison across scenarios (potentially at the expense of accurately reflecting travel behavior), such adjustments may introduce bias. Hence, the raw unconstrained accessibility values themselves are challenging to compare due to their units. To enable more meaningful comparison, the following sections will detail the introduction of constraining constants to ensure consistent units across scenarios and demonstrate results on the same numeric example.

## Total constrained accessibility

In the total constrained accessibility case, a total balancing factor proportionally adjusts unconstrained zonal accessibility values $V^0_i$ based on the regional sum of $V^0_i$ and the total population or opportunities in the region. Alternatively, we reformulate this case using a proportional allocation constant, which allocates opportunities (or population) proportionally based on the the travel impedance and the total population or opportunities in the region. In both formulations, all zonal values become a proportion of a known system total, be it the regional opportunities or regional population depending on the variant.

We define two variants for this case: (a) $V_i^T$ where accessibility is constrained by the total number of opportunities (total constrained accessible opportunity) and which is interpreted as Hansen's accessibility with a constraining constant, and (b) $M_j^T$, where $i$ and $j$ of the first variant is transposed, yielding a measure constrained by the total number of population and to be interpreted as constrained 'market potential'.

### Total constrained accessible opportunities: Hansen's accessibility with a total constraint

Unlike in @eq-access-01, the proportionality constant $k$ is retained. For the total constrained case, it is represented as $K^T$:

$$
V^T_{ij} = K^T  W_j^{(2)}  f(c_{ij})
$$ {#eq-total-constrained-access}

In this way, the total constrained accessibility measure now becomes Hansen's accessibility with a balancing factor $K^T$:

$$
V^T_i = \sum_j V^T_{ij} = K^T \sum_j W^{(2)}_jf(c_{ij}) = K^T  V^0_i
$$ {#eq-total-constrained-accessibility}

Imagine that the only system known is the total number of opportunities $D$ in the region. Accordingly, the constant we impose in this case ensures the regional sum of total constrained accessibility is equal to the total number of opportunities as follows:
$$
\sum_i V^T_{i} = \sum_i\sum_j V^T_{ij} = D
$$ {#eq-total-constraint-accessibility}

This constraint is analogous to the total constraint of @eq-constraint0-gravitymodel, congruent with Wilson's framework. Given the total number of opportunities in the region, we can then substitute @eq-total-constrained-accessibility in @eq-total-constraint-accessibility to solve for $K^T$:

$$
K^T =\frac{D}{\sum_i\sum_j V^0_{ij}} = \frac{D}{\sum_i\sum_j W^{(2)}_jf(c_{ij})}
$$ {#eq-total-opportunity-balancing-factor}

Which is also congruent with Wilson's framework as it comparable to the total flow spatial interaction model (e.g., Equation 2.11 in [@cliff_evaluating_1974]). Hence, rearranging the equation to have opportunities and the proportional constant distinctly represented, our total constrained accessibility model is:

$$
V^T_i = K^T\sum_j W^{(2)}_jf(c_{ij}) = \sum_j D\frac{W^{(2)}_j f(c_{ij})}{\sum_i\sum_j W^{(2)}_jf(c_{ij})}
$$

Further, we can see that, since $D$ and $W^{(2)}_j$ are both in units of opportunities, the proportional allocation factor for the total constrained opportunity case $\kappa_{ij}^T$ is dimensionless:

$$
\kappa_{ij}^T = \frac{W^{(2)}_j f(c_{ij})}{\sum_i\sum_j W^{(2)}_jf(c_{ij})}
$$

\noindent and therefore $V^T_i$ is now in the units of $D$, that is, the mass at the destination ($V^T_i = \sum_j \kappa_{ij}^T D$). The role of $\kappa_{ij}^T$ in this reformulation of accessibility is to transform between units and to adjust the number of opportunities accessible from $i$ so they represent a proportion of the total number of opportunities in the region $D$. $\kappa_{ij}^T$ then assigns opportunities in proportion to the impedance between $i$ and $j$. This is why we refer to $\kappa_{ij}^T$ as a proportional allocation factor. On the other hand, the proportionality constant $K^T$ balances the units of $V^0_i$, the Hansen-type accessibility values, and is an alternative expression of the total constrained accessibility measure.

Referring back to our simple numeric example, balancing factor $K^T$ for the most decay travel behaviour scenario $f_1(c_{ij}) = 1/c_{ij}^3$ would then be: 

$$
\begin{array}{l}
K^T = \frac{D}{\sum_{i}\sum_{j} W_j^{(2)} f(c_{ij})}\\
K^T = \frac{D}{\frac{W_1^{(2)}}{c_{11}^3}+\frac{W_1^{(2)}}{c_{21}^3} + \frac{W_1^{(2)}}{c_{31}^3} + s + \frac{W_3^{(2)}}{c_{31}^3} + \frac{W_3^{(2)}}{c_{32}^3} + \frac{W_3^{(2)}}{c_{33}^3}
}\\
K^T = \frac{490}{0.6233422} \\
K^T = 786.085
\end{array}
$$

```{r}
# Calculate the balancing factors/proportionality constants for each of three impedance functions
k_tot <- unc_acc_ij |> 
  summarize(k1 = sum(LU$D_j)/sum(V_unc_ij_1), # f_1
            k2 = sum(LU$D_j)/sum(V_unc_ij_2), # f_2
            k3 = sum(LU$D_j)/sum(V_unc_ij_3)) # f_3
```

Using the calculated proportionality constants for all zones and multiplying them by the unconstrained accessibility value $V^0_i$, the total opportunity constrained accessibility values for all zones and different travel behaviour scenarios is presented in @tbl-simple-example-total-opportunity-accessibility. $\kappa_{ij}^T$ for each zone is not shown, but can be understood to be the unitless proportion of opportunities (of the total opportunities) allocated to each zone based on travel impedance. 

```{r}
#| label: tbl-simple-example-total-opportunity-accessibility
#| tbl-cap: "Simple system: total constrained accessible opportunities."

tot_acc_ij <- unc_acc_ij |>
  mutate(V_tot_ij_1 = k_tot$k1 * V_unc_ij_1,
         V_tot_ij_2 = k_tot$k2 * V_unc_ij_2,
         V_tot_ij_3 = k_tot$k3 * V_unc_ij_3) 

tot_acc <- tot_acc_ij |>
  group_by(oid) |>
  summarize(V_tot_i_1 = sum(V_tot_ij_1),
            V_tot_i_2 = sum(V_tot_ij_2),
            V_tot_i_3 = sum(V_tot_ij_3))

# tot_acc_containing_kappa <- unc_acc_ij |>
#   mutate(V_tot_ij_1 = k_tot$k1 * V_unc_ij_1,
#          V_tot_ij_2 = k_tot$k2 * V_unc_ij_2,
#          V_tot_ij_3 = k_tot$k3 * V_unc_ij_3) |>
#   left_join(LU |> rename("oid" = "id") |> select(-c("O_i")), by = "oid") |>
#   group_by(oid) |>
#   summarize(V_tot_i_1 = sum(V_tot_ij_1),
#             V_tot_i_2 = sum(V_tot_ij_2),
#             V_tot_i_3 = sum(V_tot_ij_3),
#             D_j = first(D_j)) |>
#   mutate(kappa_tot_i_1 = V_tot_i_1/D_j, 
#          kappa_tot_i_2 = V_tot_i_2/D_j, 
#          kappa_tot_i_3 = V_tot_i_3/D_j) 
  
tot_acc |>
  select(oid, starts_with("V_")) |>
  gt(rowname_col = "oid") |>
  tab_stubhead(label = "Origin") |>
  tab_spanner(label = "{{V[_i^T]}}",
              columns = 2:4,
              level = 2) |>
  tab_spanner(label = "{{f_1 (c_ij ) = 1/c[_ij^3]}}",
              columns = 2,
              level = 1) |>
  tab_spanner(label = "{{f_2 (c_ij ) = 1/c[_ij^2]}}",
              columns = 3,
              level = 1) |>
  tab_spanner(label = "{{f_3 (c_ij ) = 1/c[_ij^0.1]}}",
              columns = 4,
              level = 1) |>
  fmt_number(decimals = 3) |>
  cols_label(V_tot_i_1 = md("units: *physicians*"),
             V_tot_i_2 = md("units: *physicians*"),
             V_tot_i_3 = md("units: *physicians*"))  |>
  cols_align(align = "center",
             columns = 2:4) |>
  #cols_width(
  #  stub() ~ px(60),
  #  everything() ~ px(180)
  #) |>
  tab_options(column_labels.font.size = "small",
              table.font.size = px(8)) |>
  grand_summary_rows(
    columns = c(V_tot_i_1, V_tot_i_2, V_tot_i_3),
    fns = list(label = "Sum", fn = "sum")) |> 
  as_latex()
```

In contrast to unconstrained accessibility $V^0_i$, imposing a constraint -in this case a total opportunity constraint for this variant- allows for the comparison of differences and ratios between regions and across different travel behaviour scenarios as well. Each value is effectively in units of physicians, with the impedance units already accounted for by $\kappa_{ij}^T$.

Considering the highest decay scenario ($f_1(c_{ij})$), zone 1 (a healthcare cluster at the edge of the city) captures an intermediate amount of physicians (`r tot_acc$V_tot_i_1[1]`) like in the unconstrained accessibility case. However, unlike in the unconstrained case, we can say that this value is out of the `r tot_acc$V_tot_i_1 |> sum()` physicians in the region, which allows us also to deduce that zone 1 captures `r tot_acc$V_tot_i_1[1]/tot_acc$V_tot_i_1[2]` and `r tot_acc$V_tot_i_1[1]/tot_acc$V_tot_i_1[3]` times more than zone 2 and 3. Values for the lesser decay ($f_2(c_{ij})$) and lowest decay ($f_3(c_{ij})$) scenarios are calculated separately, with decay scenario values also summing to equal `r tot_acc$V_tot_i_2 |> sum()` physicians accessible in the region.

One can also directly compare values at a specific zone due to the consistent units. For instance, zone 1 remains intermediate in capturing accessible physicians relative to zones 2 and 3 across scenarios, similar to the unconstrained case. However, the difference between travel behaviour scenarios differ in direction. Specifically, Zone 1 captures `r tot_acc$V_tot_i_2[1]- tot_acc$V_tot_i_1[1]` more and `r tot_acc$V_tot_i_1[1]- tot_acc$V_tot_i_3[1]` fewer opportunities than the lesser decay scenarios $f_2(c_{ij})$ and $f_3(c_{ij})$ respectively. Why? $\kappa_{ij}^T$ ensures proportional allocation for each travel behaviour scenario. Meaning, while the unconstrained accessibility increases, $\kappa_{ij}^T$ adjusts the values to remain proportional to the total number of opportunities (`r tot_acc$V_tot_i_2 |> sum()` physicians accessible in the region). As the decay behaviour decreases, more opportunities are accessible for all zones. In the medium decay scenario $f_2(c_{ij})$, zone 1 sees a slight increase in values (relative to the highest decay scenario) as the zone can accessible more opportunities relative to increases seen in other zones. However, in the lowest decay scenario, zone 1 sees a decrease, as it is outpaced by increases in other zones - namely zone 2 (recall: zone 2 has the lowest number of opportunities, hence the increases in opportunity gains is much higher in a low decay scenario).

Using the total opportunity constrained formulation of accessibility offers a solution to the unit interpretability issue of Hansen's [@hansen1959] accessibility measure. Intuitively, the use of the constraint illustrates how the differences and ratios of values between zones and decay groups can be compared. This is true for other constrained cases of the family of accessibility measures. 

### Total constrained accessible population: Reilly's potential trade territories with a total constraint

Another variant of the total constrained accessibility measure is the _total constrained accessible population measure_, which represents the transpose of $i$ to $j$ of the total constrained accessible opportunities measure. This variant, expressed in @eq-total-constrained-market, represents an expression of the concept of market potential (i.e., potential users) as proposed in Harris [@harris_market_1954] and Vickerman [@vickermanAccessibilityAttractionPotential1974], and which Reilly earlier referred to as 'potential trade territories' [@reilly1929methods]. This unconstrained form of market potential $M_j^0$ (@eq-unconstrained-market), effectively the $i$ to $j$ transpose of $V^0_{ij}$, has been used in recent research to express the potentially accessible population (i.e., users) as a result of regional transportation infrastructure investment projects [e.g., @gutierrezLocationEconomicPotential2001; @holl2007twenty; @condecco2018road]. Put another way, market potential can also be thought of as a form of _passive accessibility_, indicating the number of people that can reach each destination. However, like $V_{ij}^0$, issues of unit interpretability arise in $M_j^0$'s unconstrained form. To address this, the constrained variant, the total constrained accessible population measure $M^T_{j}$, is introduced. To formulate this variant, the total balancing factor $K^T$ is applied to the mass of the *population* at $i$ ($W_i^{(1)}$) instead of the opportunities at $j$.

$$
M^T_{ji} = \hat K^T  W_i^{(1)} f(c_{ij}) = \hat K^T  M_{ji}^0
$$ {#eq-total-constrained-market}

\noindent with $M_j^0$ being the $i$ $j$ transpose of $V^0_{ij}$:

$$
M_j^0 = W_i^{(1)} f(c_{ij})
$$ {#eq-unconstrained-market}

The total constrained accessible population measure (market potential) then becomes:

$$
M^T_j = \sum_i M^T_{ji} = \hat K^T \sum_i W^{(1)}_if(c_{ij})
$$

Where we impose the total system known as a constraint, i.e., that the total market potential equals the total population $O$ in the region:

$$
\sum_j M^T_{j} = \sum_i\sum_j M^T_{ji} = O
$${#eq-total-constraint-market}

Substituting @eq-total-constrained-market in @eq-total-constraint-market, and solving for $\hat K^T$, we obtain:

$$
\hat K^T=\frac{O}{\sum_i\sum_i M^T_{ji}} = \frac{O}{\sum_i\sum_j W^{(1)}_i f(c_{ij})}
$${#eq-total-population-balancing-factor}

The constrained market potential then takes the following form:
$$
M^T_j = \hat K^T \sum_i W^{(1)}_if(c_{ij}) = O \sum_i \frac{W_i^{(1)} f(c_{ij})}{\sum_i\sum_j W^{(1)}_i f(c_{ij})}
$$ 

Where the following $\hat\kappa_{ji}^T$ proportional allocation factor is dimensionless, reflecting the proportional allocation of population in the region $O$ (i.e., $M^T_j = \sum_i \hat \kappa_{ji}^T O$) 
$$
\hat \kappa_{ji}^T = \frac{W^{(2)}_i  f(c_{ij})}{\sum_i\sum_j W^{(2)}_if(c_{ij})}
$$

Returning back to the numerical example, the balancing factor $\hat K^T$ is solved for each travel behaviour scenario, and the market potential of each zone $M^T_j$ is expressed as units of population (e.g., the number of people accessible from each origin at that destination) in @tbl-simple-example-total-population-accessibility. 

```{r}
# Calculate the balancing factors/proportionality constants for each of three impedance functions
unc_market_ij <- OD |>
  mutate(M_unc_ij_1 = O_i * f1,
         M_unc_ij_2 = O_i * f2,
         M_unc_ij_3 = O_i * f3)
  
k_tot_pop <- unc_market_ij |> 
  summarize(k1 = sum(LU$O_i)/sum(M_unc_ij_1), # f_1
            k2 = sum(LU$O_i)/sum(M_unc_ij_2), # f_2
            k3 = sum(LU$O_i)/sum(M_unc_ij_3)) # f_3
```

```{r}
#| label: tbl-simple-example-total-population-accessibility
#| tbl-cap: "Simple system: total constrained accessible population."

tot_pop_ij <- unc_market_ij |>
  mutate(M_tot_ij_1 = k_tot_pop$k1 * M_unc_ij_1,
         M_tot_ij_2 = k_tot_pop$k2 * M_unc_ij_2,
         M_tot_ij_3 = k_tot_pop$k3 * M_unc_ij_3)

tot_market <- tot_pop_ij |>
  group_by(did) |>
  summarize(M_tot_i_1 = sum(M_tot_ij_1),
            M_tot_i_2 = sum(M_tot_ij_2),
            M_tot_i_3 = sum(M_tot_ij_3))
  
tot_market |>
  select(did, starts_with("M_")) |>
  gt(rowname_col = "did") |>
  tab_stubhead(label = "Destination") |>
  tab_spanner(label = "{{M[_i^S]}}",
              columns = 2:4,
              level = 2) |>
  tab_spanner(label = "{{f_1 (c_ij ) = 1/c[_ij^3]}}",
              columns = 2,
              level = 1) |>
  tab_spanner(label = "{{f_2 (c_ij ) = 1/c[_ij^2]}}",
              columns = 3,
              level = 1) |>
  tab_spanner(label = "{{f_3 (c_ij ) = 1/c[_ij^0.1]}}",
              columns = 4,
              level = 1) |>
  fmt_number(decimals = 3) |>
  cols_label(M_tot_i_1 = md("units: *population in 10,000s*"),
             M_tot_i_2 = md("units: *population in 10,000s*"),
             M_tot_i_3 = md("units: *population in 10,000s*"))  |>
  cols_align(align = "center",
             columns = 2:4) |>
  #cols_width(
  #  stub() ~ px(90),
  #  everything() ~ px(150)
  #) |>
  grand_summary_rows(
    columns = c(M_tot_i_1, M_tot_i_2, M_tot_i_3),
    fns = list(label = "Sum", fn = "sum")) |> 
  tab_options(column_labels.font.size = "small",
              table.font.size = px(8)) |>
  as_latex()
```

Readers may note the difference in trends in accessible population (@tbl-simple-example-total-population-accessibility) and accessible physicians (i.e., the preceding subsection, @tbl-simple-example-total-opportunity-accessibility). In @tbl-simple-example-total-opportunity-accessibility, zone 1, 2, 3 represent destinations and the accessibility values reflect the number of accessible people from the vantage of physicians. Zone 1, in its role as a destination, is no longer intermediately-ranked relative to other zones; it now attracts the fewest number of people across all three travel behaviour scenarios. However, similar to the total constrained opportunity case, as travel decay reduces, the availability of population begins to converge (though Zone 1 continues as the lowest-ranked) for similar reasons. As decay reduces, the population's travel impedance to all zones become more similar, making the relative location of the zones less important and all people in the region more equally accessible. Overall: like the total constrained accessible opportunities case, this variant allows for the interpretation of both ordinal and interval comparisons of the raw values themselves. 

## Singly constrained accessibility

Similar to the total constrained accessibility measure, the singly constrained case includes a balancing factor that adjusts the unconstrained zonal accessibility values $V^0_i$ such that a _single_ constraint is satisfied. Two variants are defined: (a) the _singly constrained accessible opportunities_ case (an alternative formula to spatial availability in Soukhov et al. [@soukhovIntroducingSpatialAvailability2023]), and (b) the _singly constrained accessible population_ case, its transpose, or singly constrained market potential.

Unlike the total constraint (i.e., @eq-total-constraint-accessibility), the single constraint--as will be defined in @eq-opportunity-constraint and @eq-population-constraint for the first and second variants-- incorporates additional information. In the opportunities-accessible variant, the associated balancing factor constrains the 'potential' for spatial interaction by ensuring that only a proportional amount of opportunities at each destination are allocated to 'demanding' origins. This allocation is informed by demand, or the relative amount of population, and associated travel impedance connecting the zones. In the population-accessible variant (i.e., the $i$ -> $j$ transpose of the first variant), population at each origin is proportionally allocated to destinations based on the share of opportunities and travel impedance.

In both variants, the singly constrained accessibility measure introduces population-based (or opportunity-based) competition at the zonal level, unlike the total constraint, which more simply allocates a fixed regional total of opportunities (or population depending on the variant). In sum, all singly constrained zonal accessibility values are both a proportion of the known regional opportunity (or population) total _and_ a sum of a _balanced_ proportion of opportunities allocated from each destinations (or population allocated from each origin). Each zonal value remains in units of opportunities accessible (or population accessible).

### Singly constrained accessible opportunities: spatial availability

To demonstrate this variant formulaically, we begin with the opportunity constraint (@eq-opportunity-constraint) as our known piece of information. Namely, the sum of accessible opportunities from a destination should equal the number of opportunities $D_j$ at that destination. As the number of opportunities at each $j$ are known, it is represented as $D_j$ instead of $W_j^(2)$ as in the total constrained case. This constraint should hold for all destinations in the region. This is comparable to the single attraction-constraint (@eq-constraint2-gravitymodel) from Wilson's framework.

$$
\sum_i V^S_{ij} =  D_j
$$ {#eq-opportunity-constraint}

The underlying spatial interaction model is now the attraction-constrained model in @eq-attraction-constrained-gravitymodel, and our accessibility measure becomes:

$$
V^S_{i} = \sum_j B_j D_j W_i^{(1)} f(c_{ij})
$$ {#eq-opportunity-constrained-accessibility}

\noindent where $W_i^{(1)}$ is a measure of the mass at origin $i$ (i.e., the opportunity-seeking population). The corresponding balancing factor, as per Wilson, is:

$$
B_j = \frac{1}{\sum_i W_i^{(1)} f(c_{ij})}
$$ {#eq-opportunity-constrained-proportionality-constants}

Introducing the balancing factor in @eq-opportunity-constrained-accessibility, we obtain:

$$
V^S_{i} = \sum_j D_j \frac{W_i^{(1)} f(c_{ij})}{\sum_i W_i^{(1)} f(c_{ij})}
$$ {#eq-opportunity-constrained-accessibility-with-balancing-factor}

Further, we define the following proportional allocation factor:

$$
\kappa^S_{ij} = \frac{W_i^{(1)} f(c_{ij})}{\sum_i W_i^{(1)} f(c_{ij})}
$$ {#eq-opportunity-constrained-proportional-allocation-factor}

After this, it is possible to rewrite @eq-opportunity-constrained-accessibility-with-balancing-factor as an origin summary expression of proportionally allocated known opportunities (i.e., $D_j$).

$$
V^S_{i} = \sum_j \kappa^S_{ij} D_j
$$ {#eq-attraction-constrained-accessibility-with-proportional-allocation-factor}

Soukhov et al. [@soukhovIntroducingSpatialAvailability2023] have shown that the role of $\kappa^S_{ij}$ is to allocate opportunities $D_j$ proportionally to the mass at each origin $i$ and the impedance between $i$ and $j$. As in the total constrained opportunity case, $\kappa^S_{ij}$ is dimensionless and $V_i^S$ is in the units of opportunities $D_j$. The singly constrained accessibility measure in @eq-attraction-constrained-accessibility-with-proportional-allocation-factor is called spatial availability by Soukhov et al. [@soukhovIntroducingSpatialAvailability2023], because it represents the number of opportunities that can be reached *and* are available, in the sense that accessible opportunities have been proportionally allocated based on relative demand, travel impedance and the regional total number of opportunities, i.e., spatial competition for them has been considered. These authors also show that the following expression (accessibility per capita) is a constrained version of the popular two-stage floating catchment area measure of Shen [@shen1998] and Luo and Wang [@luo2003]:

$$
v^S_{i} = \frac{V^S_{i}}{W^{(1)}_i}
$${#eq-opportunity-constrained-accessibility-per-capita}

<!-- To reinforce this point, @eq-opportunity-constraint also implies that the total constraint (e.g., $\sum_i V^S_{i} = \sum_i\sum_j  V^S_{ij} = D$ in @eq-total-constraint-accessibility) is maintained. -->
<!-- Due to the constraints, $\frac{V_i^S}{O}$ can be interpreted as the proportion of opportunities accessible *and* available to location $i$ out of the total number of opportunities in the system. -->

Returning to the simple numeric example, the opportunity-constrained case would yield the following $B_{j}$ for $f_1(c_{ij})$:

$$
\begin{array}{l}
B_{j} = \frac{1}{\sum_i W_i^{(1)} f(c_{ij})}\\
B_{1} =  \frac{1}{\frac{4}{10^3} + \frac{10}{30^3} + \frac{6}{15^3}} = 162.6506\\ 
B_{2} =  \frac{1}{\frac{4}{30^3} + \frac{10}{10^3} + \frac{6}{25^3}} = 94.9474\\
B_{3} =  \frac{1}{\frac{4}{10^3} + \frac{10}{25^3} + \frac{6}{10^3}} = 93.9850
\end{array}
$$

```{r}
B_j <- OD |> 
  group_by(did) |>
  summarize(B_j_1 = 1/sum(O_i * f1),
            B_j_2 = 1/sum(O_i * f2),
            B_j_3 = 1/sum(O_i * f3))
# B_j_longer <- B_j
# colnames(B_j_longer) <- c("ID","B_1","B_2","B_3")
# B_j_longer |> as.data.frame()  |> gt(rownames_to_stub=FALSE)
```

The balancing factors $B_j$ for the $f_2(c_{ij})$ decay group for zones 1, 2 and 3 is `r B_j$B_j_2[1]`, `r B_j$B_j_2[2]` and `r B_j$B_j_2[3]`, and for $f_3(c_{ij})$ decay group is `r B_j$B_j_3[1]`, `r B_j$B_j_3[2]` and `r B_j$B_j_3[3]`. Using these these balancing constants, we can calculate the singly constrained opportunity accessibility (@tbl-simple-example-attraction-constrained-accessibility).

```{r}
#| label: tbl-simple-example-attraction-constrained-accessibility
#| tbl-cap: "Simple system: singly constrained accessible opportunities."

opp_acc_ij <- OD |>
  left_join(B_j,
            by = "did") |>
  mutate(k_opp_ij_1 = B_j_1 * O_i * f1 /3,
         k_opp_ij_2 = B_j_2 * O_i  * f2 /3,
         k_opp_ij_3 = B_j_3 * O_i  * f3 /3,
         V_opp_ij_1 = B_j_1 * O_i * D_j * f1,
         V_opp_ij_2 = B_j_2 * O_i  * D_j * f2,
         V_opp_ij_3 = B_j_3 * O_i  * D_j * f3)

opp_acc <- opp_acc_ij |>
  group_by(oid) |>
  summarize(O_i = first(O_i) |> as.character(), 
            V_opp_i_1 = sum(V_opp_ij_1),
            V_opp_i_2 = sum(V_opp_ij_2),
            V_opp_i_3 = sum(V_opp_ij_3), 
            .groups = "drop")

opp_acc_with_ks <-  opp_acc_ij |>
  group_by(oid) |>
  summarize(O_i = first(O_i) |> as.character(), 
            k_opp_ij_1 = sum(k_opp_ij_1),
            k_opp_ij_2 = sum(k_opp_ij_2),
            k_opp_ij_3 = sum(k_opp_ij_3))

opp_acc |>
  #select(oid, O_i, starts_with("V_")) |>
  gt(rowname_col = "oid") |>
  tab_stubhead(label = "Origin") |>
  
  tab_spanner(label = "{{V[_i^S]}}",
              columns = 3:5,
              level = 2) |>
  tab_spanner(label = "{{f_1 (c_ij ) = 1/c[_ij^3]}}",
              columns = 3,
              level = 1) |>
  tab_spanner(label = "{{f_2 (c_ij ) = 1/c[_ij^2]}}",
              columns = 4,
              level = 1) |>
  tab_spanner(label = "{{f_3 (c_ij ) = 1/c[_ij^0.1]}}",
              columns = 5,
              level = 1) |>
  fmt_number(decimals = 3) |>
  
  cols_label(O_i = md("Population (10k)"),
             V_opp_i_1 = md("units: *physicians*"),
             V_opp_i_2 = md("units: *physicians*"),
             V_opp_i_3 = md("units: *physicians*"),
             )  |>
  cols_align(align = "center",
             columns = 2:5) |>
  #cols_width(
  #  stub() ~ px(60*0.8),
  #  everything() ~ px(180*0.8)
  #) |>
  grand_summary_rows(
    columns = c(V_opp_i_1, V_opp_i_2, V_opp_i_3),
    fns = list(label = "Sum", fn = "sum")) |> 
  tab_options(column_labels.font.size = "small",
              table.font.size = px(8)) |>
  as_latex()
```

Imposing the single proportional allocation factor $\kappa^S_{ij}$ allows for the comparison of differences and ratios of the accessibility values, like previously discussed in the total constrained accessible opportunities case. The proportional allocation factor ensures that resulting values are in units of _physicians_, with the impedance units already accounted for in the allocation process.

However, unlike the total constrained opportunity case, $\kappa^S_{ij}$ reflects zonal competition based on the mass of the origin, i.e., population. Again, consider the highest decay scenario $f_1(c_{ij})$. Under this scenario, zone 1 no longer captures a medium amount of physicians as in the total constrained opportunity case: it now captures the fewest in the region i.e., `r opp_acc$V_opp_i_1[1]` at zone 1, `r opp_acc$V_opp_i_1[2]` at zone 2, and `r opp_acc$V_opp_i_1[3]` at zone 3. Why may zone 1 (healthcare cluster at the edge of the city) capture `r (opp_acc$V_opp_i_1[1]/opp_acc$V_opp_i_1 |> sum()) |> scales::percent()` of the physicians regionally while this same zone captures `r (tot_acc$V_tot_i_1[1]/tot_acc$V_tot_i_1 |> sum()) |> scales::percent()` in the total opportunity constrained case?

This difference is due to the single-opportunity factor $\kappa^S_{ij}$'s role in $V_i^S$. The only inputs required in the total-opportunity factor $\kappa^T_{ij}$ is the total number of opportunities in the region $D$ as well as the associated opportunities at each $j$ and travel impedance. Opportunities are allocated to $i$s, regardless of the mass weights of origin. Whereas the single opportunity constraint $\kappa^S_{ij}$ requires the population at $i$ as an input. In fact, $\kappa^S_{ij}$ is calculated as the proportion of impedance-weighted population at an $i$ to the sum of impedance-weighted population for the entire region. Hence, since zone 1 has the lowest population in the region, is in close proximity to a more populated zone (zone 3, the 'urban core'), and is not well connected (in terms of travel impedance) to other zones with opportunities, $V_{1}^S$ values, or the number of physicians accessible, is lowest. 

Readers may also notice the change in the proportion of opportunities drawn from different zones depending on the travel behaviour scenarios considered. For instance, consider Zone 2 which has the highest population. It is more evident in the $f_3(c_{ij})$ scenario than in higher decay scenarios that this zone does not have an exceptionally large population for the region - Zone 2 only represents `r (opp_acc$O_i[2] |> as.numeric() / opp_acc$O_i |> as.numeric() |>sum()) |>scales::percent()` of the population in the three zone region. In this sense, other zones are not *that* disadvantaged, and in this scenario with unfettered travel cost, Zones 1 and 3 also take opportunities from Zone 2 (i.e., Zone 1 and Zone 3 takes `r ((opp_acc_ij$k_opp_ij_3[4])-(opp_acc_ij$k_opp_ij_1[4]) )|> scales::percent()` and `r ((opp_acc_ij$k_opp_ij_3[6])-(opp_acc_ij$k_opp_ij_1[6]))|> scales::percent()` more from Zone 2 between $f_3(c_{ij})$ and $f_1(c_{ij})$ scenarios hence $\kappa_{2,2}^S$ decreases by `r -((opp_acc_ij$k_opp_ij_3[5])-(opp_acc_ij$k_opp_ij_1[5])) |> scales::percent()`). Zones 1 and 3 are allocated opportunities at relates similar to their relative population size.

Readers may also notice the change in the proportion of opportunities drawn from different zones depending on the travel behaviour scenarios considered. For instance, Zone 2 has the highest zonal population, representing 50% of the 200,000 regional population. However, due to its high relative travel distance from the other zones, its population is less competitive in capturing opportunities in the high-decay travel scenario ($f_1(c_{ij})$): Under this scenario, zone 2 captures almost exclusively opportunities from its own zone. However, in $f_3(c_{ij})$, the scenario with unfettered travel cost, Zone 2 captures by far the most number of physicians. But in this scenario, Zones 1 and 3 also take opportunities from Zone 2 (i.e., Zone 1 and Zone 3 takes `r ((opp_acc_ij$k_opp_ij_3[4])-(opp_acc_ij$k_opp_ij_1[4]) )|> scales::percent()` and `r ((opp_acc_ij$k_opp_ij_3[6])-(opp_acc_ij$k_opp_ij_1[6]))|> scales::percent()` more from Zone 2 between $f_3(c_{ij})$ and $f_1(c_{ij})$ scenarios hence $\kappa_{2,2}^S$ decreases by `r -((opp_acc_ij$k_opp_ij_3[5])-(opp_acc_ij$k_opp_ij_1[5])) |> scales::percent()`). Zones 1 and 3 are allocated opportunities at rates similar to their relative population size.

In this way, the consideration of constrained accessibility *per capita* may be clarifying. Often, accessibility values are reported as raw scores without the consideration for population. But, as we introduced constraints, these constrained accessibility values can be normalized using anything that is relevant to the zone. In @tbl-simple-example-attraction-constrained-accessibility-per-capita, we present per capita accessibility for the numeric example, simply in units of number of physicians accessible per population at each zone. Notably, these per capita rates are equivalent to the 2SFCA values.

```{r}
#| label: tbl-simple-example-attraction-constrained-accessibility-per-capita
#| tbl-cap: "Simple system: singly constrained accessible opportunities per capita."

opp_acc_percapita <- opp_acc |>
  transmute(
    oid = id,
    O_i = O_i,
    v_opp_i_1 = V_opp_i_1 / (O_i|>as.numeric()),
    v_opp_i_2 = V_opp_i_2 / (O_i|>as.numeric()),
    v_opp_i_3 = V_opp_i_3 / (O_i|>as.numeric()))
  
opp_acc_percapita  |>
  gt(rowname_col = "oid") |>
  tab_stubhead(label = "Origin") |>
  
  tab_spanner(label = "{{v[_i^S]}}",
              columns = 3:5,
              level = 2) |>
  tab_spanner(label = "{{f_1 (c_ij ) = 1/c[_ij^3]}}",
              columns = 3,
              level = 1) |>
  tab_spanner(label = "{{f_2 (c_ij ) = 1/c[_ij^2]}}",
              columns = 4,
              level = 1) |>
  tab_spanner(label = "{{f_3 (c_ij ) = 1/c[_ij^0.1]}}",
              columns = 5,
              level = 1) |>
  fmt_number(decimals = 3) |>
  
  cols_label(O_i = md("Population (10k)"),
             v_opp_i_1 = md("units: *physicians per capita*"),
             v_opp_i_2 = md("units: *physicians per capita*"),
             v_opp_i_3 = md("units: *physicians per capita*"),
             )  |>
  cols_align(align = "center",
             columns = 2:5) |>
  #cols_width(
  #  stub() ~ px(60*0.8),
  #  everything() ~ px(180*0.8)
  #) |>
  #grand_summary_rows(
  #  columns = c(v_opp_i_1, v_opp_i_2, v_opp_i_3),
  #  fns = list(label = "Sum", fn = "sum")) |> 
  tab_options(column_labels.font.size = "small",
              table.font.size = px(8))  |>
  as_latex()
```

This simple example was constructed so that the regional average equals `r (opp_acc$V_opp_i_1|>sum()) /(opp_acc$O_i|>as.numeric()|>sum())` physicians per 10,000 people. As distance decay decreases and becomes _relatively_ uniform (all zones can reach all zones), the effect of population drives the proportional allocation of opportunities. Consequently, per capita accessibility values begin to stabilise to the regional per capita average (e.g., in the lowest distance decay $f_3(c_{ij})$, per capita values are all around 24 physicians accessible per capita). 

This trend mirrors how the accessibility values in the total constrained opportunity case stabilises to the $V_i^T$ regional average (e.g., the accessible opportunities allocated to each of the three zones approaches a third of 490 physicians, or 163.33, under the unfettered mobility scenario $f_3(c_{ij})$). These patterns make intuitive sense: the balancing factors act as regional and/or zonal averaging mechanisms. In distance decay travel behaviour scenarios that are more relatively uniform (i.e., low for all zones like in $f_3(c_{ij})$), what remains is the relative effect of the other variables in the balancing factor. In the total constrained case, this is the proportion of opportunities relative to the regional opportunities, and in the case of the single opportunity constrained case, this is the population at a zone relative to the regional population.

### Singly constrained accessible population: market availability

Similar to @eq-total-population-balancing-factor in transposing the origins and destinations, we can define a *singly constrained* measure of market potential that preserves the known population (i.e., the mass weight at the origin $W_i^{(1)}$ is now represented by $O_i$). In it's per-capita expression, i.e., equivalent to 2SFCA, this constrained concept of market potential been used to express "facility crowdedness" as in Wang [@wang_inverted_2018].

The underlying spatial interaction model is now the production-constrained model in @eq-production-constrained-gravitymodel, and our market potential measure $M^S_j$ becomes:

$$
M^S_j = \sum_i A_i O_i W_j^{(2)} f(c_{ij})
$$ {#eq-population-constrained-accessibility}

In this case, the measure is singly constrained by the population *by origin* (i.e., $O_i$), like @eq-constraint2-gravitymodel from Wilson's framework:

$$
\sum_j M^S_{ji} =  O_i 
$$ {#eq-population-constraint}

And the corresponding balancing factor, as per Wilson, is: 

$$
A_i = \frac{1}{\sum_j W_j^{(2)} f(c_{ij})}
$$ {#eq-population-constrained-proportionality-constants}

Following the same logic as in the preceding section on total constrained market potential, one arrives at the following expression: 

$$
M^S_{j} = \sum_i \hat \kappa^S_{ji} O_i
$$ {#eq-production-constrained-accessibility-with-proportional-allocation-factor}

\noindent with:

$$
\hat \kappa^S_{ji} = \frac{W_j^{(2)} f(c_{ij})}{\sum_i W_j^{(2)} f(c_{ij})}
$$ {#eq-attraction-constrained-proportional-allocation-factor}

As well, the single (population) constraint in @eq-population-constraint ensures that the the total constraint (e.g., $\sum_j M^S_{j} = \sum_i\sum_j  M^S_{ji} = O$) is maintained.

With these constraints, $\frac{M_j^S}{O}$ can be interpreted as the proportion of the total population serviced by location $j$.

For the sake of brevity, we'll move forward onto the doubly constrained case.

## Doubly constrained accessibility

This accessibility case requires zonal populations and opportunities to match one-to-one, like the doubly constrained spatial interaction model. In this way, doubly constrained accessibility can be thought as "access" or simply spatial interaction (no potential).

To contextualize this point, the total and singly constrained accessibility measures discussed thus far have used either $O_i$, $D_j$, or the regional sums of either, but never both simultaneously. For example, when opportunities $D_j$ are used to constrain @eq-opportunity-constrained-accessibility in the _singly constrained accessible opportunities measure_, the specific mass of the population at origin $i$ demanding only those opportunities at that $j$ is unknown. Instead, only the population at $i$ demanding opportunities in the region is known, and this is more generally represented as $W_i^{(1)}$ (as in @eq-opportunity-constrained-proportionality-constants). Similarly, when the population $O_i$ is used as a constraint in @eq-population-constrained-accessibility in the _singly constrained accessible population measure_, the mass at the destination is given by $W_j^{(2)}$ (also in @eq-population-constrained-proportionality-constants) since only the mass of opportunities at each $j$ is known and information on what opportunities are allocated to what zone is unknown. 

By contrast, the double-constrained accessibility case requires that both populations and opportunities match. Meaning, opportunities at each destination can be accessed by all populations, while at the same time, the population at each origin can be accessed by all opportunities. However, this requirement is often unintuitive in traditional accessibility analysis. Namely, the distinction between population (origin masses) and opportunities (destination masses) typically represent different entities without a shared unit of measurement. On the population side, we usually count people; on the opportunity side, we may be referring to physicians, clinics, grocery stores, schools, parks, or libraries. In a few cases, a one-to-one correspondence or their own capacities at which they interact and are interacted with may exist e.g., one person with one job. Another similar opportunity type example is healthcare, e.g., one person and one unit of capacity, e.g. a vaccine shot.

A doubly constrained approach to accessibility calculation needs a one-to-one relationships between population and opportunities to be present. Mathematically, this model requires the simultaneous imposition of both the population- and opportunity- constraints in the preceding singly constrained variants (@eq-opportunity-constraint and @eq-population-constraint), namely the sum of population in all origins should match the sum of opportunities in all destinations (@eq-opportunity-population-equality):

$$
\sum_i O_i = \sum_j D_j
$$ {#eq-opportunity-population-equality}

As before, the simultaneous imposition of both constraints ensures the total system constraint is maintained i.e., the sum of all doubly constrained accessibility values $\sum_i V^D_{i} = \sum_i\sum_j  V^D_{ij} = D$ remains equal to the total number of opportunities in the region $O$ as shown in @eq-total-constraint-accessibility.

As the doubly constrained accessibility measure $V_{ij}^D$ takes the form of the production-attraction (doubly constrained) spatial interaction model, as shown in @eq-doubly-constrained-gravitymodel, $V_{i}^D$ is as follows:

$$
V_{ij}^D = A_i B_j O_i D_j f(c_{ij})
$$ {#eq-doubly-constrained-accessibility}

\noindent where the corresponding balancing factors $A_i$ and $B_j$, as per Wilson, are:

$$
\begin{array}{l}
A_i = \frac{1}{\sum_j B_j D_j f(c_{ij})}\\
B_j = \frac{1}{\sum_i A_i O_i f(c_{ij})}
\end{array}
$$

Calibration of the two sets of proportionality constants is accomplished by means of iterative proportional fitting, whereby the values of $A_i$ are initialized as one for all i to obtain an initial estimate of $B_j$. The values of $B_j$ are used to update the underlying $V_{ij}^D$ matrix, before calibrating $A_i$. This process continues to update $A_i$ and $B_j$ until a convergence criterion is met [see @ortuzar_2011_modelling, p. 193-195]. The proportional allocation factor $\kappa_{ij}^D$ would then be: 

$$
\kappa_{ij}^D = \sum_j \frac{1}{\sum_j B_j D_j f(c_{ij})} \frac{1}{\sum_i A_i O_i f(c_{ij})} O_i f(c_{ij})
$$

One could rewrite @eq-doubly-constrained-accessibility as an origin summary expression of proportionally allocated opportunities:

$$
V^D_{i} = \sum_j \kappa^D_{ij} D_j
$$ {#eq-doubly-constrained-accessibility-w-paf}

However, $V^D_{i}$ is not wholly helpful, as it will simply equal the origin-mass marginal. In this way, only $V^D{ij}$ values are interpretable. Furthermore, unlike in the total and singly constrained cases, the doubly-constrained case does not have an interpretable per capita version. For instance, representing $V_{ij}^D$ per capita is not meaningful, as the value *already* matches population to opportunities. Following this logic, the market potential form $M^D_{ij}$ is effectively equivalent to $V_{ij}^D$, but can be read with a different interpretation: i.e., the opportunities accessed from $j$ at an $i$ vs. the population accessed from $i$ at a $j$. The inputs of 'opportunities accessed' and 'accessed population' can already be interpreted as inherently being sensitive to both opportunities and population. 

```{r}
#| label: simple-numerical-example-doubly constrained

# Same as before
id <- c("1", "2", "3")
O_i2 <- c(4, 10, 6) #in units of 10,000 people
#D_j <- c(160, 150, 180) #the old
#D_j2 <- c(6.530612, 6.122449, 7.346939) #this would be exactly linearly scaled down.
D_j2 <- c(7, 5, 8) #in units of 10,000 physician-capacity
LU2 <- data.frame(id, O_i2, D_j2)
```

To calculate doubly constrained accessibility, the interpretation of the population data and the counts of the opportunity data in the numeric example must be modified. Namely, a count of physician _capacity_ per destination is needed instead of just the number of physicians, as used to calculated total and singly constrained cases. We also must be able to clearly state that the population is a count of people seeking opportunities at the new capacities, i.e., the population must reflect the _capacity_ of the population to interact with opportunities. 

So, this adjusted simple example is summarised in @tbl-small-system-land-use-doubly-constrained-case: with the population (in units of 10,000s of people seeking physicians) and the opportunities (in units of 10,00s of physician-capacity) per zone. For the population, we leave this unchanged numerically but theoretically know that each person interacts with one physician capacity (i.e., our opportunities with a _capacity_). Hence, the number of opportunities per destination is new: the example is modified such that the physician-capacity at each zone is an approximately scaled version of the number of destination-side physicians at each zone from the unmodified example (@tbl-small-system-land-use). To emphasis the new definition of 'provider' as physician capacity, the new system PPR is simply `r sum(LU2$D_j2) / sum(LU2$O_i2)`, this is compared to the unmodified example which yields system PPR of`r sum(LU$D_j) / sum(LU$O_i)`. We keep the same zonal cost matrix, and travel impedance functions for three types of travel behaviour as before (@tbl-small-system-cost and @eq-travel-behaviour-scenarios). 

```{r}
#| label: tbl-small-system-land-use-doubly-constrained-case
#| tbl-cap: "Modified simple system with three zones reflecting matched population and opportunities. Population is in 10,000 persons and opportunities in 10,000 of physician-capacity."

LU2 |>
  gt() |>
  # tab_spanner("{{W[_i^(1)]}}",
  #             columns = 2) |>
  # tab_spanner("{{W[_j^(2)]}}",
  #             columns = 3) |>
  cols_label(id = "ID (i or j)",
             O_i2 = "Population", 
             D_j2 = "Opportunities")  |>
  cols_align(align = "center",
             columns = 2:3) |>
  tab_options(table.font.size = px(10)) |>
  as_latex()
```

```{r}
#| label: simple-numerical-example-OD-table-doubly constrained

OD2 <- C |># mutate(f3=100) |>
  left_join(LU2 |>
              select(-D_j2),
            by = c("oid" = "id")) |>
  left_join(LU2 |>
              select(-O_i2),
            by = c("did" = "id"))
```

However, despite the modifications to the example, our objective remains the same as in previous cases: to measure accessibility under different travel behavior scenarios. Specifically, we aim to quantify the number of _potential_ spatial interactions between the physician-seeking population in each zone $i$ to the physician capacity in a zone $j$ i.e., $V_{ij}^D$. The highest decay travel behaviour scenario ($f_1(c_ij)$) is presented in @tbl-adjusted-small-system-land-use-doubly-constrained-case-f1cij-access-values. 

```{r, quiet = TRUE}
doubly_constrained_gravity_model <- function(
    #CREDIT: I converted the python code from (https://github.com/SadraDaneshvar/Gravity_Model) to R
  O,  # Origin production weights vector
  D,  # Destination attraction weights vector
  impedance_matrix,  # the resulting travel cost impedance matrix
  error_threshold = 0.001,  # error threshold for stopping condition
  improvement_threshold = 1e-6  # improvement threshold for stopping condition
) {

  # Normalize O and D
  sum_O <- sum(O)
  sum_D <- sum(D)
  # cat("Checking production, attraction balancing:\n") #let's disable the messages..
  # cat("Production: ", sum_O, "\n")
  # cat("Attraction: ", sum_D, "\n")

  if (sum_O != sum_D) {
    # cat("Productions and attractions do not balance, scaling to match.\n") #let's disable the messages..
    if (sum_O < sum_D) {
      O <- O * (sum_D / sum_O)
    } else {
      D <- D * (sum_O / sum_D)
    }
  } else {
    # cat("Production, attraction balancing OK.\n") #let's disable the messages..
  }

  n <- length(O)  # Number of i
  T <- sum(O)  # Total trips
  Ai <- rep(1, n)  # Initialize Ai
  Bj <- rep(1, n)  # Initialize Bj

  previous_error <- Inf
  iteration_count <- 0
  stop_reason <- ""

  while (TRUE) {
    iteration_count <- iteration_count + 1

    # Update Ai
    for (i in 1:n) {
      Ai[i] <- 1 / (sum(Bj * D * impedance_matrix[i, ]) + 1e-9)
    }

    # Update Bj
    Bj_new <- rep(1, n)
    for (j in 1:n) {
      Bj_new[j] <- 1 / (sum(Ai * O * impedance_matrix[, j]) + 1e-9)
    }

    # Calculate Tij
    Tij <- outer(Ai * O, Bj_new * D) * impedance_matrix

    # # Print Ai and Bj for this iteration #let's disable the messages..
    # cat("\nIteration:", iteration_count, "\n")
    # cat("Ai:", round(Ai, 3), "\n")
    # cat("Bj:", round(Bj_new, 3), "\n")

    # Calculate error
    error <- (sum(abs(O - rowSums(Tij))) + sum(abs(D - colSums(Tij)))) / T

    # Calculate change in error
    error_change <- abs(previous_error - error)

    # Check stopping conditions
    if (error < error_threshold) {
      stop_reason <- "Error threshold met"
      break
    } else if (error_change < improvement_threshold) {
      stop_reason <- "Slow improvement"
      break
    }

    previous_error <- error
    Bj <- Bj_new
  }

  # report stopping condition and final error threshold #let's disable the messages..
  #cat("\nStopping Condition: ", stop_reason, "\n")
  #cat(sprintf("Final Error: %.3f%%\n", error * 100))

  return(list(Ai = Ai, Bj = Bj, Tij = Tij))
}
```

```{r}
#| label: calculating balancing-factors and resulting Tij for each travel behaviour scenario

#isolating impedance
Impf1 <- C$f1 |> 
  matrix(nrow = 3, ncol = 3)

Impf2 <- C$f2 |> 
  matrix(nrow = 3, ncol = 3)

Impf3 <- C$f3 |> 
  matrix(nrow = 3, ncol = 3)
# caclulating it
dc_acc_1 <- doubly_constrained_gravity_model(O_i2, D_j2, Impf1)
dc_acc_2 <- doubly_constrained_gravity_model(O_i2, D_j2, Impf2)
dc_acc_3 <- doubly_constrained_gravity_model(O_i2, D_j2, Impf3)

#assigning the balancing factors to their own variables
A_i_doubly1 <- dc_acc_1$Ai
B_j_doubly1 <- dc_acc_1$Bj

A_i_doubly2 <- dc_acc_2$Ai
B_j_doubly2 <- dc_acc_2$Bj

A_i_doubly3 <- dc_acc_3$Ai
B_j_doubly3 <- dc_acc_3$Bj

#assigning the Tijs to their own variables
V_dc_1 <- dc_acc_1$Tij
V_dc_2 <- dc_acc_2$Tij
V_dc_3 <- dc_acc_3$Tij

#reformatting the matrix into long format, joining it to OD2
OD2<-OD2 |> mutate(V_dc_ij_1 = c(V_dc_1[,1], V_dc_1[,2], V_dc_1[,3]),
              V_dc_ij_2 = c(V_dc_2[,1], V_dc_2[,2], V_dc_2[,3]),
              V_dc_ij_3 = c(V_dc_3[,1], V_dc_3[,2], V_dc_3[,3]))

OD2$k_dc_ij_1 = c((outer(A_i_doubly1 * O_i2, B_j_doubly1) * Impf1)[,1],
                   (outer(A_i_doubly1 * O_i2, B_j_doubly1) * Impf1)[,2],
                   (outer(A_i_doubly1 * O_i2, B_j_doubly1) * Impf1)[,3]) / 3

OD2$k_dc_ij_2 = c((outer(A_i_doubly2 * O_i2, B_j_doubly2) * Impf2)[,1],
                   (outer(A_i_doubly2 * O_i2, B_j_doubly2) * Impf2)[,2],
                   (outer(A_i_doubly2 * O_i2, B_j_doubly2) * Impf2)[,3]) / 3

OD2$k_dc_ij_3 = c((outer(A_i_doubly3 * O_i2, B_j_doubly3) * Impf3)[,1],
                   (outer(A_i_doubly3 * O_i2, B_j_doubly3) * Impf3)[,2],
                   (outer(A_i_doubly3 * O_i2, B_j_doubly3) * Impf3)[,3]) / 3

#Checks, should equal 1.
# OD2$k_dc_ij_1 |> sum()
# OD2$k_dc_ij_2 |> sum()
# OD2$k_dc_ij_3 |> sum()
```

```{r}
#| label: tbl-adjusted-small-system-land-use-doubly-constrained-case-f1cij-access-values
#| tbl-cap: "Doubly constrained accessible opportunities assuming highest travel decay in the modified simple system."

OD2 |> 
  select(c(oid, did, V_dc_ij_1)) |>
  tidyr::pivot_wider(names_from = did, values_from = V_dc_ij_1) |>
  group_by(oid) |> 
  mutate(sum = round(`1` + `2` + `3`, 0)) |> 
  ungroup() |> 
  gt() |>
  tab_spanner(label = "Destination ID",
              columns = 2:4) |>
  cols_label(oid = "Origin ID")  |>
  cols_align(align = "center",
             columns = 2:5) |>
  grand_summary_rows(
    columns = 2:4,
    fns = list(label = "Sum", fn = "sum")) |> 
  
  tab_options(column_labels.font.size = "small",
              table.font.size = px(10)) |>
  as_latex()
```

As mentioned, accessibility values are typically interpreted as a summary of the proportionally allocated opportunities at each $i$. Hence, in interpreting the doubly constrained accessibility from @tbl-adjusted-small-system-land-use-doubly-constrained-case-f1cij-access-values, $V_i^D$ values (i.e., the sum of values at all three $j$ destinations for each origin $i$) would be `r (OD2|>group_by(oid)|>summarize(V_dc_i_1=sum(V_dc_ij_1)))[1,2] |> pull()`, `r (OD2|>group_by(oid)|>summarize(V_dc_i_1=sum(V_dc_ij_1)))[2,2] |> pull()`, and `r (OD2|>group_by(oid)|>summarize(V_dc_i_1=sum(V_dc_ij_1)))[3,2] |> pull()` physician-capacity accessible for Zones 1, 2 and 3 respectively. This approximately equal to the number of population at each of these zones. Conversely, the market potential $M_j^D$ interpretation of these values would be `r (OD2|>group_by(did)|>summarize(M_dc_j_1=sum(V_dc_ij_1)))[1,2] |> pull()`, `r (OD2|>group_by(did)|>summarize(M_dc_j_1=sum(V_dc_ij_1)))[2,2] |> pull()`, and `r (OD2|>group_by(did)|>summarize(M_dc_j_1=sum(V_dc_ij_1)))[3,2] |> pull()` people accessible from Zones 1, 2 and 3 respectively, equal to the number of *opportunities* (physician-capacities accessible) at each of these zones. Notice, the mass weight at the origin equals the mass weight of the destination: this is precisely the function of the double constraint. In other words, $V_i^D$ is the number of accessed opportunities and $M_j^D$ is the number of population accessed. For the other two travel behaviour, identical $V_i^D$ and $M_j^D$ values are calculated, following the same logic. Hence, the usefulness of the doubly constrained measure lies in the interpretation as $V_{ij}^D$ values.

For instance, differences in $V_{ij}^D$ values between travel behaviour scenarios are notable. These values can be directly compared to discuss mass and distance decay impacts. Examining Zone 2 (the bedroom community), @tbl-adjusted-small-system-land-use-doubly-constrained-case-allfs-access-values-for-zone2 demonstrates these $i$ to $j$ access values for this more relatively remote, higher-populated and lower-opportunity rich zone. It can be observed that the number of intrazonal opportunities proportionally allocated decreases as the assumed distance decay decreases e.g., from `r OD2|>filter(oid == 2 & did == 2) |> pull(V_dc_ij_1)` to `r OD2|>filter(oid == 2 & did == 2) |> pull(V_dc_ij_3)` out of the \~`r OD2|>filter(oid == 2) |> summarize(V_dc_i_1 = sum(V_dc_ij_1)) |> pull(V_dc_i_1) |>round()` opportunities allocated to Zone 2 (a population of `r OD2|>filter(oid == 2) |> summarize(O_i2 = first(O_i2)) |> pull(O_i2) |>round()`). Following the intuition discussed in the singly constrained opportunity case, as decay decreases, the mass effect of the population (at origin) and opportunity (at destination) is more evident: zonal opportunities are supplied and zonal populations demand at the weights assigned to these zones, with minimal decay adjustment, reflected by the proportional allocation factors $\kappa_{ij}^D$.

```{r}
#| label: tbl-adjusted-small-system-land-use-doubly-constrained-case-allfs-access-values-for-zone2
#| tbl-cap: "Doubly constrained accessible opportunities at Zone 2 for all travel decay groups in the modified simple system."

OD2  |>
  filter(oid == 2) |>
  select(c(did, O_i2, D_j2, starts_with("V_"))) |>
  gt(rowname_col = "did") |>
  tab_stubhead(label = "Dest.") |>
  
  tab_spanner(label = "{{V[_{ij}^D]}}",
              columns = 4:6,
              level = 2) |>
  tab_spanner(label = "{{f_1 (c_ij ) = 1/c[_ij^3]}}",
              columns = 4,
              level = 1) |>
  tab_spanner(label = "{{f_2 (c_ij ) = 1/c[_ij^2]}}",
              columns = 5,
              level = 1) |>
  tab_spanner(label = "{{f_3 (c_ij ) = 1/c[_ij^0.1]}}",
              columns = 6,
              level = 1) |>
  fmt_number(decimals = 3) |>
  
  cols_label(O_i2 = md("Population at 2 (units: *people in 10,000s*)"),
             D_j2 = md("Opportunities (units: *capacity in 10,000s*)"),
             V_dc_ij_1 = md("units: *physician-capacity in 10,000s*"),
             V_dc_ij_2 = md("units: *physician-capacity in 10,000s*"),
             V_dc_ij_3 = md("units: *physician-capacity in 10,000s*"),
             )  |>
  cols_align(align = "center",
             columns = 2:6) |>
  cols_width(
    stub() ~ px(60*0.5),
    everything() ~ px(180*0.5)
  ) |>
  tab_options(column_labels.font.size = "small",
              table.font.size = px(10)) |>
  as_latex()
```

Recall, accessibility is defined as "the potential for interaction" and is traditionally presented as a summary zonal measure. In the doubly constrained case, we force the zonal population and zonal opportunities to match one-to-one, hence providing a zonal summary is no longer relevant: the sum of $V_{ij}^D$ for all $i$s ends up being equal to the population at the zone. However, if what interests readers is the "potential for interaction" in the case population and opportunities to match one-to-one, reframing the investigation may be needed. In this sense, it would be examining "interaction" (much less room for potential) through the values of $V_{ij}^D$ e.g., how many opportunities are being allocated to an origin from a destination (or in a transposed sense for $M_{ji}^D$). In this sense, the doubly constrained case can be thought of as an estimate of _realized_ accessibility or access: reflecting spatial interaction. It is also formulaically identical to the doubly constrained spatial interaction model, but with specific interpretations of the origin and destination weights as 'population' and 'opportunity', respectively.

As Wilson explicitly noted, origin and destination weights defined in the spatial interaction model *can* be defined using any unit. Accessibility, however, is often presented and understood as a zonal summary of *potential* for interaction between origins and destinations that contain inherently different units. Arriving at the doubly constrained case through the unconstrained, total, and singly constrained cases make the connection between the *potential* for spatial interaction (accessibility) and *realized* potential for spatial interaction more interpretable. Namely, by demonstrating that these members of the accessibility family all derive from the same root and can be derived from Wilson's original formulation, this more clearly demonstrates what *potential* is, within the context of spatial interaction modelling.

Namely, *potential* depends on the framing of the masses at the origin and destination, and how similar they are in their units. The appropriate constraint should be decided based on the the input data and their similarity. In increasing unit similarity from the perspective of opportunity-constraint: the total-constraint can be used if population (origin mass) is not known, the single constraint can be used if population is known and matters to *potential* but it does not match the capacity of opportunities, and lastly, the double constraint is appropriate if population is known, matters and population matches the capacity of opportunities. These constraint measures can reflect the opportunities accessible at each zone, but reflects the assumptions embedded in the input data about the potential to spatially interact.

# Conclusions

In this work, we examined the historical and mathematical commonalities between spatial interaction models and place-based accessibility measures. As accessibility research evolved largely influenced by Hansen [@hansen1959], researchers in the field neglected the proportionality constant that was originally present in gravity-based models, and is still present in spatial interaction modeling. Firstly, we have demonstrated that by reintroducing such constraints and defining associated balancing factors and proportional allocation factors, we can derive a unifying family of accessibility measures that reintroduces units to the resulting values. These values become more intuitive for the purpose of analysis and comparison. Secondly, the constraining constants, depending on the case (i.e., total, singly- or doubly- constrained), restrict the degree of _potential_, linking accessibility (the potential for spatial interaction) with access (spatial interaction) on the same continuum based on the constraint used. Lastly, we discussed how popular measures such as the one used in Hansen [@hansen1959] and the 2SFCA link into the family of accessibility measures. We summarise the family of accessibility measures, as follows.

We first place the popular Hansen-type accessibility measure [@hansen1959] within this family of measures as an "unconstrained" case, demonstrating that resulting values cannot be directly compared across different travel scenarios without ad-hoc adjustments. We then show how applying a total constraint balances the units and produces a statistically averaged solution that converges to the regional average for each zone as the decay effect decreases. In other words, the total-constraint model could be a more interpretable alternative for the unconstrained case if population-competition is not relevant and one is interested in capturing the maximum _potential_; specifically, if there is a fixed number of opportunities in the region, and if it makes sense to assume that people accessing proximate opportunities leave fewer for others, *without* considering the population size at the origins. <!-- A.S. NOTE: Hansen's measure would converge to some global total if the decay effect was low. Imagine everyone can teleport. In the unconstrained case: all zones can reach all opportunities. In the total constrained case: all zones can reach all opportunities divided by the number of zones. Alternatively, if 1 zone can teleport and no other zone can travel at all, that 1 zone will get all the opportunities in the region. -->

We then introduce the singly constrained case, which *does* takes into account the population size at the origin in the allocation of opportunities (unlike the total constraint). It is also mathematically equivalent to the spatial availability introduced in Soukhov et al.  [@soukhovIntroducingSpatialAvailability2023]. In this case, all accessibility values are fixed to sum to a known zonal opportunity-size value (implicitly, the regional total of opportunities), but they are not required to sum to any population-based values at the zone or regional level. The singly constrained model could be useful if regional competition is a factor and if the acknowledgment that only a finite number of opportunities can be allocated from each destination (with those allocations distributed based on origin population size) is suitable. We also introduce an 'accessible' PPR (e.g., opportunities per capita), calculated by dividing each accessibility value by the zonal population. To clarify, this per capita expression of the singly constrained case is equivalent to the 2SFCA [@luo2003; @shen1998], hence linking this literature back to spatial interaction principles. 

Lastly, the doubly constrained case is introduced. In this case, the sums must equal both the regional total and ensure that no zone allocates more opportunities than it has available. Specifically, accessibility values for each $i$-$j$ pair must be a proportion of he zonal opportunity and population values simultaneously. For example, the accessibility at zone 1 must equal the sum of opportunities from zones 1, 2, and 3, as well as the sum of the population at zone 1. Satisfying the double constraint means the opportunities and population data must match one-to-one, so working with the accessibility $i$-$j$ pair values should be of interest. In this sense, the research question should be concerned with 'access' (how many opportunities accessed from $j$ at $i$ based on given zonal opportunities and populations) instead of potential spatial interaction (e.g., typically expressed as a zonal summary measure of how many opportunities one could reach (out of a regional total and/or zonal-allocation).

In summary, building on Wilson's [@wilson1971] foundational work, this paper proposed a unified framework for accessibility that is able to account for competition. By reintroducing Wilson's proportionality constant, the proposed family of constrained accessibility measures restores measurement units to accessibility estimates. This enhancement provides a more interpretable, consistent, and theoretically grounded basis for accessibility analysis, which could help advance the adoption of accessibility-oriented planning.

# References
